<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FutBot Pro - Professional Trading Bot Dashboard">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FutBot Pro">
    <title>FutBot Pro</title>
    
    <!-- Force cache clear on every load -->
    <script>
        // Clear all caches on page load
        if ('caches' in window) {
            caches.keys().then(function(names) {
                for (let name of names) {
                    caches.delete(name);
                }
            });
        }
        
        // Force reload if page was loaded from cache
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237c3aed'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'%3EF%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Dark Theme Colors */
            --nav-bg: #1a1e23;
            --nav-text: #9ca3af;
            --nav-text-active: #ffffff;
            --nav-item-hover: #2d333b;
            --nav-accent: #7c3aed;
            
            --header-bg: #1f2937;
            --header-text: #ffffff;

            --main-bg: #0f172a; /* Dark background */
            --card-bg: #1e293b; /* Dark card background */
            
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #334155;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; display: flex; height: 100vh; background: var(--main-bg); color: var(--text-primary); overflow: hidden; }

        /* --- Navigation Sidebar --- */
        .nav-sidebar {
            width: 240px;
            background: var(--nav-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .brand {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: white;
            font-weight: 700;
            font-size: 20px;
            border-bottom: 1px solid #2d333b;
        }
        
        .brand i { color: var(--nav-accent); margin-right: 10px; }

        .nav-menu {
            padding: 20px 16px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--nav-text);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: var(--nav-item-hover);
            color: white;
        }

        .nav-item.active {
            background: var(--nav-accent);
            color: white;
        }

        .nav-item i { width: 24px; margin-right: 12px; }

        /* --- Main Layout --- */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* --- Top Header --- */
        .app-header {
            height: 64px;
            background: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
        }
        .status-dot.running { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-dot.paused { background: #f59e0b; }

        .status-text {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }
        .ctrl-btn:hover { opacity: 0.9; }
        .ctrl-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-start { background: #10b981; color: white; }
        .btn-stop { background: #ef4444; color: white; }
        .btn-pause { background: #f59e0b; color: white; }
        .btn-kill { background: #b91c1c; color: white; }

        /* DateTime Input Styling */
        .datetime-input {
            cursor: pointer;
            transition: all 0.2s;
        }
        .datetime-input:hover {
            border-color: var(--nav-accent) !important;
            background: var(--card-bg) !important;
        }
        .datetime-input:focus {
            outline: none;
            border-color: var(--nav-accent) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        /* Make datetime-local input look like a button */
        .datetime-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.8;
            filter: invert(1);
        }
        .datetime-input::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* --- Views Container --- */
        .content-container {
            flex: 1;
            overflow: hidden; /* Scroll handled inside views */
            position: relative;
        }

        .view-section {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
            overflow-y: auto;
        }

        .view-section.active { display: block; }

        /* --- General Styles --- */
        .section-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }

        .data-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* --- Sub Tabs --- */
        .sub-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .sub-tab {
            padding: 10px 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .sub-tab:hover { color: var(--text-primary); }
        .sub-tab.active { color: var(--nav-accent); border-bottom-color: var(--nav-accent); }

        /* --- Grid Layouts --- */
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .card-body { padding: 20px; height: 300px; display: flex; align-items: center; justify-content: center; }

        /* --- Dashboard Layout --- */
        #dashboard-view {
            flex-direction: row;
            height: 100%;
            background: var(--main-bg);
            overflow: hidden; 
        }
        #dashboard-view.active { display: flex; }

        .wb-sidebar {
            width: 300px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
        }
        .wb-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Webull Style Overrides for Dark Mode --- */
        .wb-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            padding: 20px;
        }
        .wb-title { color: var(--text-secondary); font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .wb-value { color: var(--text-primary); font-size: 28px; font-weight: 700; }
        .wb-metric-label { color: var(--text-secondary); }
        .wb-metric-val { color: var(--text-primary); font-weight: 600; }
        table.wb-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table.wb-table th { text-align: left; padding: 10px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); font-weight: 500; }
        table.wb-table td { padding: 10px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); }
        
        .wb-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #334155; color: #38bdf8; margin-left: 8px; vertical-align: middle; }
        .wb-metric-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .text-pos { color: var(--success) !important; }
        .text-neg { color: var(--danger) !important; }
        .wb-grid-top { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; min-height: 350px; }
        .wb-grid-mid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .wb-card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .wb-card-title { font-weight: 600; color: var(--text-primary); font-size: 16px; }
        
        .simple-view-container { padding: 24px; max-width: 1200px; margin: 0 auto; }


        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .nav-sidebar {
                width: 100%;
                height: auto;
                max-height: 60px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .brand {
                height: 60px;
                min-width: 120px;
                font-size: 16px;
            }
            
            .nav-menu {
                display: flex;
                flex-direction: row;
                padding: 0;
                overflow-x: auto;
                flex: 1;
            }
            
            .nav-item {
                white-space: nowrap;
                margin: 0 4px;
                padding: 8px 12px;
                min-width: fit-content;
            }
            
            .nav-item i {
                margin-right: 6px;
            }
            
            .app-main {
                height: calc(100vh - 60px);
            }
            
            .app-header {
                height: 56px;
                padding: 0 16px;
                font-size: 14px;
            }
            
            .view-content {
                padding: 16px;
            }
            
            .wb-card {
                min-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .analytics-tabs {
                flex-direction: column;
            }
            
            .analytics-tab {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .app-header {
                font-size: 12px;
            }
            
            .status-indicator {
                gap: 8px;
            }
            
            .view-content {
                padding: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <div class="nav-sidebar">
        <div class="brand"><i class="fas fa-robot"></i> FutBot Pro</div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="showView('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
            <div class="nav-item" onclick="showView('analytics')"><i class="fas fa-chart-pie"></i> Analytics</div>
            <div class="nav-item" onclick="showView('trades')"><i class="fas fa-list"></i> Trades</div>
            <div class="nav-item" onclick="showView('agents')"><i class="fas fa-users-cog"></i> Agents</div>
            <div class="nav-item" onclick="showView('risk')"><i class="fas fa-shield-alt"></i> Risk Mgmt</div>
            <div class="nav-item" onclick="showView('settings')"><i class="fas fa-cog"></i> Settings</div>
        </div>
        <div style="padding: 20px; color: #6b7280; font-size: 12px;">
            v2.1.0 Stable
        </div>
    </div>

    <!-- Main App -->
    <div class="app-main">
        <!-- Top Header -->
        <div class="app-header">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <div class="status-text" id="statusText">System Stopped</div>
                <div style="margin-left: 10px; font-size: 12px; color: #9ca3af;" id="lastUpdate">Last update: -</div>
            </div>
            <div class="header-controls">
                <!-- Simulation Controls (shown when Simulate button is visible) -->
                <span style="color: var(--text-secondary); margin-right: 8px; font-size: 13px;">SPY & QQQ</span>
                <select id="simStartDateTime" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               width: 200px; display: inline-block;"
                        title="Select start date and time">
                    <option value="">Initializing...</option>
                </select>
                <span style="color: var(--text-secondary); margin-right: 8px;">to</span>
                <select id="simEndDateTime" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               width: 200px; display: inline-block;"
                        title="Select end date and time">
                    <option value="">Initializing...</option>
                </select>
                <select id="replaySpeed" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               max-width: 120px;"
                        title="Replay speed multiplier">
                    <option value="1">1x (Real-time)</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                    <option value="600" selected>600x (Fast)</option>
                </select>
                <button onclick="if(window.initDateTimeDropdowns) { window.initDateTimeDropdowns(); console.log('üîÑ Manual refresh triggered'); } else { console.error('initDateTimeDropdowns not available yet'); }" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--nav-accent); color: white; border-radius: 4px; cursor: pointer; font-size: 12px;"
                        title="Refresh date dropdowns">
                    <i class="fas fa-sync-alt"></i> Refresh Dates
                </button>
                <button class="ctrl-btn btn-start" id="btnStart" onclick="controlBot('start')" style="display: none;"><i class="fas fa-play"></i> Start Live</button>
                <button class="ctrl-btn btn-sim" id="btnSim" onclick="startSimulation()" style="background:#3b82f6; color:white;"><i class="fas fa-flask"></i> Simulate</button>
                <button class="ctrl-btn btn-pause" id="btnPause" onclick="controlBot('pause')"><i class="fas fa-pause"></i> Pause</button>
                <button class="ctrl-btn btn-stop" id="btnStop" onclick="controlBot('stop')"><i class="fas fa-stop"></i> Stop</button>
                <div style="width: 1px; background: #374151; margin: 0 8px;"></div>
                <button class="ctrl-btn btn-kill" id="btnKill" onclick="controlBot('kill')"><i class="fas fa-skull"></i> Kill Switch</button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            
            <!-- DASHBOARD VIEW (Webull Style) -->
            <div id="dashboard-view" class="view-section active">
                <!-- Webull Sidebar (Account Details) -->
                <div class="wb-sidebar">
                    <div style="margin-bottom: 30px;">
                        <div class="wb-title">TOTAL ACCOUNT VALUE</div>
                        <div class="wb-value"><span id="wbTotalValue">$100,000.00</span> <span class="wb-badge">LIVE</span></div>
                    </div>
                    
                    <div style="height: 150px; margin-bottom: 30px;">
                        <canvas id="wbMiniChart"></canvas>
                    </div>

                    <div style="flex: 1;">
                        <div class="wb-title" style="margin-bottom: 15px;">DETAILS</div>
                        <div class="wb-metric-row"><span>Day's P&L</span> <span id="wbDayPnL" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Open P&L</span> <span id="wbOpenPnL" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Cash Balance</span> <span id="wbCash" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Buying Power</span> <span id="wbBP" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Options BP</span> <span id="wbOptBP" class="wb-metric-val">$0.00</span></div>
                    </div>

                    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--wb-border);">
                        <div class="wb-title">RISK LEVEL</div>
                        <div style="height: 100px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="wbRiskGauge"></canvas>
                        </div>
                        <div style="text-align: center; font-weight: 700; color: var(--wb-text-primary);" id="wbRiskLabel">SAFE</div>
                    </div>
                </div>

                <!-- Webull Main Content -->
                <div class="wb-main">
                    <div class="wb-grid-top">
                        <div class="wb-card">
                            <div class="wb-card-header">
                                <div class="wb-card-title">Performance</div>
                                <div>
                                    <span id="wbPerfPnL" style="font-size: 24px; font-weight: 600;">$0.00</span>
                                </div>
                            </div>
                            <!-- Performance Tabs -->
                            <div style="display: flex; gap: 8px; padding: 0 20px; border-bottom: 1px solid var(--border-color);">
                                <div class="perf-tab active" onclick="showPerfTab('chart', this)" style="padding: 8px 12px; cursor: pointer; border-bottom: 2px solid var(--nav-accent); color: var(--nav-accent); font-size: 13px; font-weight: 500;">
                                    Chart
                                </div>
                                <div class="perf-tab" onclick="showPerfTab('status', this)" style="padding: 8px 12px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500;">
                                    Status
                                </div>
                            </div>
                            <!-- Chart View -->
                            <div id="perf-chart-view" class="perf-tab-content" style="flex: 1; position: relative; display: block;">
                                <canvas id="wbMainChart"></canvas>
                            </div>
                            <!-- Status View -->
                            <div id="perf-status-view" class="perf-tab-content" style="flex: 1; padding: 20px; display: none; overflow-y: auto; max-height: 400px;">
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-signal" style="margin-right: 8px;"></i>Trade Setups
                                    </div>
                                    <div id="tradeSetups" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid #9ca3af;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <div style="font-weight: 600; color: var(--text-primary);">Waiting for data...</div>
                                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">No trade signals available</div>
                                                </div>
                                                <div style="padding: 4px 8px; background: #374151; border-radius: 4px; font-size: 11px; color: #9ca3af;">
                                                    PENDING
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-robot" style="margin-right: 8px;"></i>Agent Activity
                                    </div>
                                    <div id="agentActivity" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px;">
                                            <div style="font-size: 12px; color: var(--text-secondary);">Loading agent status...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-cog" style="margin-right: 8px;"></i>Background Activity
                                    </div>
                                    <div id="backgroundActivity" style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">System Status:</span>
                                            <span id="systemStatus" style="color: var(--text-primary); font-weight: 500;">Stopped</span>
                                        </div>
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Bars Processed:</span>
                                            <span id="barsProcessed" style="color: var(--text-primary); font-weight: 500;">0</span>
                                        </div>
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Current Regime:</span>
                                            <span id="currentRegime" style="color: var(--text-primary); font-weight: 500;">-</span>
                                        </div>
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Last Bar:</span>
                                            <span id="lastBarTime" style="color: var(--text-primary); font-weight: 500; font-size: 11px;">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-history" style="margin-right: 8px;"></i>Recent Activity
                                    </div>
                                    <div id="recentActivity" style="display: flex; flex-direction: column; gap: 6px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; color: var(--text-secondary);">
                                            No recent activity
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="wb-card">
                            <div class="wb-card-header">
                                <div class="wb-card-title">Components</div>
                            </div>
                            <div style="display: flex; flex-direction: column; justify-content: space-around; height: 100%;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px;"><canvas id="wbWinChart"></canvas></div>
                                    <div><div class="wb-title">Win Rate</div><div class="wb-metric-val" id="wbWinVal">0%</div></div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px;"><canvas id="wbRegimeChart"></canvas></div>
                                    <div><div class="wb-title">Regime Confidence</div><div class="wb-metric-val" id="wbRegimeVal">0%</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wb-card" style="flex: 1; min-height: 300px;">
                        <div class="wb-card-header">
                            <div class="wb-card-title">Positions & Recent Trades</div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="wb-table" id="wbPositionsTable">
                                <thead>
                                    <tr><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>Comm</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No recent trades</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="analytics-view" class="view-section simple-view-container">
                <div class="section-header"><i class="fas fa-chart-pie"></i> Analytics</div>
                
                <!-- Sub Tabs -->
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="showAnalyticsTab('perf', this)">Performance</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('regime', this)">Regime Analysis</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('vol', this)">Volatility</div>
                </div>

                <!-- Tab Content: Performance -->
                <div id="ana-perf" class="ana-tab-content" style="display:block;">
                    <div class="grid-2-col">
                        <div class="data-card">
                            <div class="card-header">Performance Metrics</div>
                            <div class="card-body" style="position:relative;">
                                <div style="text-align:center; color:var(--text-secondary);">
                                    <div style="margin-bottom:10px;">Loading...</div>
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="card-header">TradingView Chart</div>
                            <div class="card-body" style="padding: 0; height: 400px;">
                                <div id="tradingview-widget" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Regime (Placeholder) -->
                <div id="ana-regime" class="ana-tab-content" style="display:none;">
                    <div class="data-card">
                        <div class="card-header">Regime Distribution</div>
                        <div class="card-body"><canvas id="regimeDistChart"></canvas></div>
                    </div>
                </div>
                
                 <!-- Tab Content: Volatility (Placeholder) -->
                <div id="ana-vol" class="ana-tab-content" style="display:none;">
                    <div class="data-card">
                        <div class="card-header">Volatility Analysis</div>
                        <div class="card-body">No data available</div>
                    </div>
                </div>
            </div>

            <!-- TRADES VIEW -->
            <div id="trades-view" class="view-section simple-view-container">
                <div class="section-header">Trade History</div>
                <div class="data-card">
                    <table class="wb-table" id="fullTradesTable">
                        <thead>
                            <tr><th>ID</th><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>PnL</th><th>Reason</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- AGENTS VIEW -->
            <div id="agents-view" class="view-section simple-view-container">
                <div class="section-header">Active Agents</div>
                <div class="wb-grid-mid" id="agentsGrid">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- RISK VIEW -->
            <div id="risk-view" class="view-section simple-view-container">
                <div class="section-header">Risk Management</div>
                <div class="data-card" style="padding: 20px;">
                    <div id="riskJson">Loading...</div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="settings-view" class="view-section simple-view-container">
                <div class="section-header">Settings</div>
                <div class="data-card" style="padding: 20px;">
                    <p>Configuration options...</p>
                </div>
            </div>

        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <script>
        // VERIFY SCRIPT IS LOADING
        console.log('‚úÖ Dashboard JavaScript is loading...');
        console.log('‚úÖ Script tag executed at:', new Date().toISOString());
        
        const API_BASE = window.location.origin;
        let charts = {}; // Store chart instances

        function showAnalyticsTab(tabId, el) {
            // Hide all tabs
            document.querySelectorAll('.ana-tab-content').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected
            document.getElementById(`ana-${tabId}`).style.display = 'block';
            el.classList.add('active');
            
            // Load data for the selected tab
            if (tabId === 'perf') {
                updatePerformanceAnalytics();
            } else if (tabId === 'regime') {
                updateRegimeAnalytics();
            } else if (tabId === 'vol') {
                updateVolatilityAnalytics();
            }
        }
        
        // --- Analytics Data Cache ---
        let analyticsCache = {
            stats: null,
            regime: null,
            liveStatus: null,
            health: null,
            lastFetch: 0,
            cacheDuration: 2000 // 2 seconds
        };
        
        async function getCachedData(endpoint, cacheKey) {
            const now = Date.now();
            if (analyticsCache[cacheKey] && (now - analyticsCache.lastFetch) < analyticsCache.cacheDuration) {
                return analyticsCache[cacheKey];
            }
            const data = await fetch(`${API_BASE}${endpoint}`).then(r => r.json()).catch(() => null);
            if (data) {
                analyticsCache[cacheKey] = data;
                analyticsCache.lastFetch = now;
            }
            return data;
        }
        
        // --- Analytics Data Updates ---
        async function updatePerformanceAnalytics() {
            try {
                const [stats, health, liveStatus] = await Promise.all([
                    getCachedData('/stats', 'stats'),
                    getCachedData('/health', 'health'),
                    getCachedData('/live/status', 'liveStatus')
                ]);
                
                const perfDiv = document.querySelector('#ana-perf .data-card .card-body');
                if (!perfDiv) return;
                
                if (!stats) {
                    perfDiv.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No performance data available. Start trading to see metrics.</div>';
                    return;
                }
                
                const totalReturn = stats.total_return_pct || 0;
                const sharpe = stats.sharpe_ratio || 0;
                const maxDrawdown = stats.max_drawdown_pct || 0;
                const winRate = stats.win_rate || 0;
                const totalTrades = stats.total_trades || 0;
                
                // Get equity curve for sparkline
                let equitySparkline = '';
                try {
                    const equityData = await fetch(`${API_BASE}/visualizations/equity-curve-data`).then(r => r.json()).catch(() => null);
                    if (equityData && equityData.equity_curve && equityData.equity_curve.length > 0) {
                        const curve = equityData.equity_curve;
                        const initial = equityData.initial_capital || 100000;
                        const current = curve[curve.length - 1] || initial;
                        const change = ((current - initial) / initial) * 100;
                        
                        // Generate simple ASCII sparkline
                        const maxVal = Math.max(...curve);
                        const minVal = Math.min(...curve);
                        const range = maxVal - minVal || 1;
                        const sparkline = curve.slice(-20).map(v => {
                            const normalized = ((v - minVal) / range) * 4;
                            return Math.round(normalized);
                        });
                        const sparklineChars = sparkline.map(h => {
                            if (h === 0) return '‚ñÅ';
                            if (h === 1) return '‚ñÇ';
                            if (h === 2) return '‚ñÉ';
                            if (h === 3) return '‚ñÖ';
                            return '‚ñá';
                        }).join('');
                        
                        equitySparkline = `
                            <div style="margin-top: 12px; padding: 12px; background: #111827; border-radius: 6px; border-left: 3px solid ${change >= 0 ? '#10b981' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Equity</div>
                                        <div style="font-size: 18px; font-weight: 700; color: ${change >= 0 ? '#10b981' : '#ef4444'};">
                                            $${current.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                            <span style="font-size: 12px; margin-left: 4px;">(${change >= 0 ? '+' : ''}${change.toFixed(2)}%)</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="font-family: monospace; font-size: 14px; color: ${change >= 0 ? '#10b981' : '#ef4444'}; letter-spacing: 2px;">
                                    ${sparklineChars}
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.debug('Could not load equity curve for sparkline:', e);
                }
                
                // Get simulation start time
                let startTimeInfo = '';
                if (liveStatus && liveStatus.start_time) {
                    const startDate = new Date(liveStatus.start_time);
                    const startTimeFormatted = startDate.toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    }) + ' CST';
                    const barsProcessed = liveStatus.bar_count || 0;
                    startTimeInfo = `
                        <div style="margin-top: 12px; padding: 8px; background: #1f2937; border-radius: 4px; font-size: 11px; color: var(--text-secondary);">
                            <i class="fas fa-clock" style="margin-right: 4px;"></i>
                            Since ${liveStatus.mode === 'offline' ? 'Simulation' : 'Live Trading'} Start: ${startTimeFormatted} | Bars: ${barsProcessed}
                        </div>
                    `;
                }
                
                perfDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Return</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${totalReturn >= 0 ? '#10b981' : '#ef4444'};">${totalReturn.toFixed(2)}%</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Sharpe Ratio</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${sharpe.toFixed(2)}</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Max Drawdown</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${maxDrawdown <= 0 ? '#10b981' : '#ef4444'};">${maxDrawdown.toFixed(2)}%</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Win Rate</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(winRate * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Trades</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${totalTrades}</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Status</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${health?.is_running ? '#10b981' : '#ef4444'};">${health?.is_running ? 'Running' : 'Stopped'}</div>
                        </div>
                    </div>
                    ${equitySparkline}
                    ${startTimeInfo}
                `;
            } catch (e) {
                console.error('Error updating performance analytics:', e);
            }
        }
        
        async function updateRegimeAnalytics() {
            try {
                const [regime, health] = await Promise.all([
                    getCachedData('/regime', 'regime'),
                    getCachedData('/health', 'health')
                ]);
                
                const regimeDiv = document.querySelector('#ana-regime .card-body');
                if (!regimeDiv) return;
                
                if (!regime || !regime.is_valid) {
                    regimeDiv.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No regime data available. Need 30+ bars for analysis.</div>';
                    return;
                }
                
                const regimeType = regime.regime_type || 'N/A';
                const trend = regime.trend_direction || 'N/A';
                const volatility = regime.volatility_level || 'N/A';
                const bias = regime.bias || 'N/A';
                const confidence = (regime.confidence || 0) * 100;
                
                // Regime badge colors
                const regimeColors = {
                    'TREND': '#3b82f6',
                    'COMPRESSION': '#9ca3af',
                    'EXPANSION': '#f59e0b',
                    'MEAN_REVERSION': '#8b5cf6',
                    'NEUTRAL': '#6b7280'
                };
                
                const trendColors = {
                    'UP': '#10b981',
                    'DOWN': '#ef4444',
                    'SIDEWAYS': '#9ca3af'
                };
                
                const volColors = {
                    'HIGH': '#ef4444',
                    'MEDIUM': '#f59e0b',
                    'LOW': '#10b981'
                };
                
                const biasColors = {
                    'BULLISH': '#10b981',
                    'BEARISH': '#ef4444',
                    'NEUTRAL': '#9ca3af'
                };
                
                regimeDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${regimeColors[regimeType] || '#8b5cf6'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Current Regime</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${regimeColors[regimeType] || '#8b5cf6'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${regimeColors[regimeType] || '#8b5cf6'}; text-transform: uppercase;">${regimeType}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${trendColors[trend] || '#3b82f6'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Trend Direction</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${trendColors[trend] || '#3b82f6'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${trendColors[trend] || '#3b82f6'}; text-transform: uppercase;">${trend}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${volColors[volatility] || '#f59e0b'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Volatility Level</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${volColors[volatility] || '#f59e0b'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${volColors[volatility] || '#f59e0b'}; text-transform: uppercase;">VOL ${volatility}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${biasColors[bias] || '#9ca3af'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Bias</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${biasColors[bias] || '#9ca3af'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${biasColors[bias] || '#9ca3af'}; text-transform: capitalize;">${bias}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #10b981;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Confidence</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${confidence >= 70 ? '#10b981' : confidence >= 40 ? '#f59e0b' : '#ef4444'};">${confidence.toFixed(1)}%</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${regime.is_valid ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Status</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${regime.is_valid ? '#10b981' : '#ef4444'};">${regime.is_valid ? 'Valid' : 'Invalid'}</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error updating regime analytics:', e);
            }
        }
        
        async function updateVolatilityAnalytics() {
            try {
                const [regime, stats, liveStatus] = await Promise.all([
                    getCachedData('/regime', 'regime'),
                    getCachedData('/stats', 'stats'),
                    getCachedData('/live/status', 'liveStatus')
                ]);
                
                const volDiv = document.querySelector('#ana-vol .card-body');
                if (!volDiv) return;
                
                if (!regime || !regime.is_valid) {
                    volDiv.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No volatility data available. Need 30+ bars for analysis.</div>';
                    return;
                }
                
                const volatility = regime.volatility_level || 'N/A';
                const atrPct = regime.metrics?.atr_pct || 0;
                const barCount = liveStatus?.bar_count || 0;
                
                // Determine volatility status
                let volStatus = 'NORMAL';
                let volColor = '#f59e0b';
                if (volatility === 'HIGH') {
                    volStatus = 'HIGH VOLATILITY';
                    volColor = '#ef4444';
                } else if (volatility === 'LOW') {
                    volStatus = 'LOW VOLATILITY';
                    volColor = '#10b981';
                }
                
                volDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${volColor};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Volatility Level</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${volColor}; text-transform: uppercase;">${volatility}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${volStatus}</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ATR %</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${(atrPct * 100).toFixed(2)}%</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Average True Range</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Bars Analyzed</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${barCount}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${barCount >= 30 ? 'Sufficient' : 'Insufficient'} for analysis</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #10b981;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Trading Recommendation</div>
                            <div style="font-size: 16px; font-weight: 700; color: ${volatility === 'HIGH' ? '#ef4444' : volatility === 'LOW' ? '#9ca3af' : '#10b981'};">
                                ${volatility === 'HIGH' ? 'CAUTION - High Risk' : volatility === 'LOW' ? 'STABLE - Low Risk' : 'NORMAL - Moderate Risk'}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: #1f2937; border-radius: 6px;">
                        <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Volatility Interpretation</div>
                        <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                            ${volatility === 'HIGH' ? 
                                'High volatility indicates increased market uncertainty. Consider smaller position sizes and tighter stop losses.' :
                                volatility === 'LOW' ?
                                'Low volatility suggests stable market conditions. Normal position sizing and stop losses are appropriate.' :
                                'Normal volatility indicates standard market conditions. Standard trading parameters apply.'}
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error updating volatility analytics:', e);
            }
        }

        function showPerfTab(tabId, el) {
            console.log('üîÑ showPerfTab called with:', tabId);
            // Hide all performance tab contents
            document.querySelectorAll('.perf-tab-content').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.perf-tab').forEach(t => {
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--text-secondary)';
            });
            
            // Show selected
            if (tabId === 'chart') {
                const chartView = document.getElementById('perf-chart-view');
                if (chartView) {
                    chartView.style.display = 'block';
                    console.log('‚úÖ Chart view shown');
                } else {
                    console.error('‚ùå perf-chart-view element not found');
                }
            } else if (tabId === 'status') {
                const statusView = document.getElementById('perf-status-view');
                if (statusView) {
                    statusView.style.display = 'block';
                    console.log('‚úÖ Status view shown, calling updateStatusView()');
                    updateStatusView(); // Refresh status when switching to status tab
                } else {
                    console.error('‚ùå perf-status-view element not found');
                }
            }
            
            // Update tab styling
            if (el) {
                el.style.borderBottomColor = 'var(--nav-accent)';
                el.style.color = 'var(--nav-accent)';
            }
        }

        async function updateStatusView() {
            try {
                // Fetch all status data with fallbacks
                const [health, regime, agents, liveStatus] = await Promise.all([
                    fetch(`${API_BASE}/health`).then(r => r.json()).catch(() => ({ is_running: false, is_paused: false })),
                    fetch(`${API_BASE}/regime`).then(r => r.json()).catch(() => ({ regime_type: 'COMPRESSION', confidence: 0.0 })),
                    fetch(`${API_BASE}/agents`).then(r => r.json()).catch(() => ({})),
                    fetch(`${API_BASE}/live/status`).then(r => r.json()).catch(() => ({ is_running: false, bar_count: 0 }))
                ]);

                // Update Background Activity
                if (health) {
                    document.getElementById('systemStatus').textContent = health.is_running 
                        ? (health.is_paused ? 'Paused' : 'Running') 
                        : 'Stopped';
                    document.getElementById('systemStatus').style.color = health.is_running 
                        ? (health.is_paused ? '#f59e0b' : '#10b981') 
                        : '#ef4444';
                }
                
                if (liveStatus) {
                    document.getElementById('barsProcessed').textContent = liveStatus.bar_count || 0;
                    if (liveStatus.mode) {
                        document.getElementById('systemStatus').textContent = 
                            `${liveStatus.mode === 'offline' ? 'Simulating' : 'Live'} - ${liveStatus.is_running ? 'Running' : 'Stopped'}`;
                    }
                }

                // Update Current Regime
                if (regime) {
                    const regimeText = `${regime.regime_type} (${regime.trend_direction})`;
                    document.getElementById('currentRegime').textContent = regimeText;
                    document.getElementById('currentRegime').style.color = regime.confidence > 0.7 ? '#10b981' : '#f59e0b';
                }
                
                // Update Last Bar Timestamp - ALWAYS show current CST time when bot is running
                const currentTimeForDisplay = new Date();
                let timeToShow = null;
                
                // FIX: Always show current time when bot is running (fixes timestamp issue)
                if (liveStatus && liveStatus.is_running) {
                    // Always show current CST time when bot is running
                    timeToShow = currentTimeForDisplay.toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' CST';
                    
                    // Add note if bars are stuck
                    if (liveStatus.last_bar_time) {
                        const lastBarDate = new Date(liveStatus.last_bar_time);
                        const timeDiff = (currentTimeForDisplay - lastBarDate) / 1000 / 60; // minutes ago
                        if (timeDiff > 5) {
                            timeToShow += ' (Waiting for new bars)';
                        }
                    }
                } else if (liveStatus && liveStatus.last_bar_time) {
                    // Bot not running - show last bar time
                    const lastBarDate = new Date(liveStatus.last_bar_time);
                    timeToShow = lastBarDate.toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' CST';
                } else if (health && health.last_update) {
                    const lastUpdate = new Date(health.last_update);
                    timeToShow = lastUpdate.toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' CST';
                } else {
                    // Fallback to current time
                    timeToShow = currentTimeForDisplay.toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' CST';
                }
                
                if (timeToShow) {
                    document.getElementById('lastBarTime').textContent = timeToShow;
                }

                // Update Trade Setups
                updateTradeSetups(regime, agents, liveStatus);

                // Update Agent Activity
                updateAgentActivity(agents);

                // Update Recent Activity
                updateRecentActivity(health, liveStatus);

            } catch (e) {
                console.error('Error updating status view:', e);
                // Show error message in status view
                const setupsDiv = document.getElementById('tradeSetups');
                if (setupsDiv) {
                    setupsDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid #ef4444;">
                            <div style="font-weight: 600; color: #ef4444;">Error loading status</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${e.message}</div>
                        </div>
                    `;
                }
            }
        }

        function updateTradeSetups(regime, agents, liveStatus) {
            const setupsDiv = document.getElementById('tradeSetups');
            setupsDiv.innerHTML = '';

            // Get current bar count
            const barCount = liveStatus?.bar_count || 0;
            const requiredBars = 30;
            const barsNeeded = Math.max(0, requiredBars - barCount);

            // Get current evaluation time/bar (CST timezone)
            // If last_bar_time is old (>5 min) and bot is running, show current time
            const currentTime = new Date();
            let currentBarTime = liveStatus?.last_bar_time || regime?.timestamp || null;
            
            if (currentBarTime && liveStatus?.is_running) {
                const lastBarDate = new Date(currentBarTime);
                const timeDiff = (currentTime - lastBarDate) / 1000 / 60; // minutes ago
                // If last bar is more than 5 minutes old, show current time
                if (timeDiff > 5) {
                    currentBarTime = currentTime.toISOString(); // Use current time
                }
            }
            
            const currentBarTimeFormatted = currentBarTime 
                ? new Date(currentBarTime).toLocaleString('en-US', {
                    timeZone: 'America/Chicago',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                  }) + ' CST'
                : currentTime.toLocaleString('en-US', {
                    timeZone: 'America/Chicago',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                  }) + ' CST';
            
            // If we have enough bars, treat regime as valid even if is_valid is false
            // (backend should force-validate, but UI can also handle this)
            const hasEnoughBars = barCount >= requiredBars;
            const regimeValid = regime && (regime.is_valid || hasEnoughBars);
            
            if (!regime || !regimeValid) {
                let message = 'Insufficient bars for analysis';
                let suggestion = '';
                let statusColor = '#9ca3af'; // Gray for NO DATA
                let statusLabel = 'NO DATA';
                let progressColor = '#9ca3af';
                let etaText = '';
                let diagnosticInfo = '';
                
                if (barCount >= requiredBars) {
                    // Have enough bars but regime is invalid - show diagnostic
                    message = `Analysis in progress (${barCount} bars available)`;
                    suggestion = regime ? 'Regime detected but validation pending...' : 'Waiting for regime classification';
                    statusColor = '#f59e0b'; // Orange - processing
                    statusLabel = 'PROCESSING';
                    progressColor = '#f59e0b';
                    diagnosticInfo = regime 
                        ? `<div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;">
                            <div style="font-size: 10px; color: #fca5a5; margin-bottom: 4px;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
                                <strong>Diagnostic:</strong> ${barCount} bars but regime invalid
                            </div>
                            <div style="font-size: 10px; color: #fca5a5;">
                                Regime: ${regime.regime_type || 'N/A'}, Confidence: ${((regime.confidence || 0) * 100).toFixed(1)}%, Valid: ${regime.is_valid ? 'Yes' : 'No'}
                            </div>
                        </div>`
                        : '<div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;"><div style="font-size: 10px; color: #fca5a5;">No regime signal received from backend</div></div>';
                } else if (barCount > 0) {
                    message = `Need ${barsNeeded} more bars (${barCount}/${requiredBars})`;
                    suggestion = 'Continue simulation to collect more bars';
                    statusColor = '#f59e0b'; // Orange for COLLECTING
                    statusLabel = 'COLLECTING';
                    progressColor = '#f59e0b';
                    
                    // Calculate ETA if simulation is running
                    if (liveStatus && liveStatus.is_running && liveStatus.duration_seconds) {
                        const barsPerSecond = barCount / liveStatus.duration_seconds;
                        if (barsPerSecond > 0) {
                            const etaSeconds = Math.ceil(barsNeeded / barsPerSecond);
                            if (etaSeconds < 60) {
                                etaText = `Ready in ~${etaSeconds} seconds`;
                            } else {
                                const etaMinutes = Math.ceil(etaSeconds / 60);
                                etaText = `Ready in ~${etaMinutes} minute${etaMinutes > 1 ? 's' : ''}`;
                            }
                        }
                    } else if (liveStatus && liveStatus.replay_speed) {
                        // Estimate based on replay speed (600x = ~50-80 bars/sec)
                        const estimatedBarsPerSecond = Math.min(80, liveStatus.replay_speed / 7.5);
                        const etaSeconds = Math.ceil(barsNeeded / estimatedBarsPerSecond);
                        if (etaSeconds < 60) {
                            etaText = `Ready in ~${etaSeconds} seconds at ${liveStatus.replay_speed}x speed`;
                        } else {
                            const etaMinutes = Math.ceil(etaSeconds / 60);
                            etaText = `Ready in ~${etaMinutes} minute${etaMinutes > 1 ? 's' : ''} at ${liveStatus.replay_speed}x speed`;
                        }
                    }
                } else {
                    message = 'No bars collected yet';
                    suggestion = 'Start a simulation or collect historical data';
                }
                
                // Show diagnostic info if we have bars but regime is invalid
                if (barCount >= requiredBars && (!regime || !regime.is_valid)) {
                    diagnosticInfo = `
                        <div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;">
                            <div style="font-size: 10px; color: #fca5a5; margin-bottom: 4px;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
                                <strong>Diagnostic:</strong> ${barCount} bars available but regime invalid
                            </div>
                            <div style="font-size: 10px; color: #fca5a5;">
                                ${regime ? `Regime: ${regime.regime_type || 'N/A'}, Confidence: ${((regime.confidence || 0) * 100).toFixed(1)}%` : 'No regime signal received'}
                            </div>
                        </div>
                    `;
                }
                
                setupsDiv.innerHTML = `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Waiting for Data</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${message}</div>
                            </div>
                            <div style="padding: 4px 8px; background: ${statusColor}20; border-radius: 4px; font-size: 11px; color: ${statusColor}; font-weight: 600;">
                                ${statusLabel}
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: #1f2937; border-radius: 4px; font-size: 11px; color: var(--text-secondary);">
                            <div style="margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>Progress:</strong> ${barCount}/${requiredBars} bars</span>
                                ${etaText ? `<span style="color: ${statusColor}; font-weight: 600;">${etaText}</span>` : ''}
                            </div>
                            <div style="width: 100%; height: 4px; background: #374151; border-radius: 2px; overflow: hidden; margin: 4px 0;">
                                <div style="width: ${Math.min(100, (barCount / requiredBars) * 100)}%; height: 100%; background: ${progressColor}; transition: width 0.3s;"></div>
                            </div>
                            <div style="margin-top: 6px; padding: 6px; background: #111827; border-radius: 4px; border-left: 2px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: var(--text-secondary);"><i class="fas fa-clock" style="margin-right: 4px;"></i>Evaluating Bar:</span>
                                    <span style="color: var(--text-primary); font-weight: 600;">${currentBarTimeFormatted}</span>
                                </div>
                                ${liveStatus && liveStatus.bars_per_symbol ? `
                                <div style="margin-top: 4px; font-size: 10px; color: var(--text-secondary);">
                                    Bars: ${Object.entries(liveStatus.bars_per_symbol).map(([s, c]) => `${s}: ${c}`).join(', ')}
                                </div>
                                ${Object.values(liveStatus.bars_per_symbol || {}).some(c => c < 30) ? `
                                <div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;">
                                    <div style="font-size: 10px; color: #fca5a5;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
                                        <strong>Warning:</strong> Bar count stuck. Check data feed connection (Alpaca/IBKR). Market shows SPY: 681, QQQ: 616 but bot has only ${Object.values(liveStatus.bars_per_symbol || {}).join('/')} bars.
                                    </div>
                                </div>
                                ` : ''}
                                ` : ''}
                            </div>
                            ${diagnosticInfo ? diagnosticInfo : ''}
                            </div>
                            <div style="margin-top: 6px; color: #9ca3af;">
                                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                                ${suggestion}
                            </div>
                            ${barCount === 0 ? `
                            <div style="margin-top: 8px;">
                                <button onclick="autoStartDataCollection()" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-play" style="margin-right: 4px;"></i>Collect Data & Analyze
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                return;
            }

            // If we reach here, we have a valid regime (or enough bars to treat it as valid)
            // Use regime even if is_valid is false but we have enough bars
            const effectiveRegime = regime || {};
            
            // Determine setup quality based on regime and agents
            const confidence = effectiveRegime.confidence || 0;
            const bias = effectiveRegime.bias || 'NEUTRAL';
            const regimeType = effectiveRegime.regime_type || 'COMPRESSION';
            
            let setupQuality = 'NEUTRAL';
            let setupColor = '#9ca3af';
            let setupLabel = 'WAIT';
            let setupReason = '';

            if (confidence > 0.7 && (bias === 'BULLISH' || bias === 'BEARISH')) {
                if (regimeType === 'TREND' || regimeType === 'EXPANSION') {
                    setupQuality = 'GOOD';
                    setupColor = '#10b981'; // Green for READY/GOOD
                    setupLabel = 'GOOD SETUP';
                    setupReason = `Strong ${bias.toLowerCase()} signal in ${regimeType.toLowerCase()} regime`;
                }
            } else if (confidence < 0.5 || regimeType === 'COMPRESSION') {
                setupQuality = 'BAD';
                setupColor = '#ef4444'; // Red for AVOID/BAD
                setupLabel = 'AVOID';
                setupReason = `Low confidence (${(confidence * 100).toFixed(0)}%) or choppy market`;
            } else {
                setupQuality = 'NEUTRAL';
                setupColor = '#f59e0b'; // Orange for CAUTION
                setupLabel = 'CAUTION';
                setupReason = `Moderate confidence (${(confidence * 100).toFixed(0)}%) - wait for better setup`;
            }
            
            // If we have valid regime, status is READY (green)
            const readyStatusColor = '#10b981';

            // Get current evaluation time (CST timezone)
            // ALWAYS show current time when bot is running (fixes timestamp issue)
            const evalCurrentTime = new Date();
            let evalTimeFormatted;
            
            if (liveStatus && liveStatus.is_running) {
                // Bot is running - ALWAYS show current CST time
                evalTimeFormatted = evalCurrentTime.toLocaleString('en-US', {
                    timeZone: 'America/Chicago',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }) + ' CST';
            } else {
                // Bot not running - show last bar time or current time
                const evalBarTime = liveStatus?.last_bar_time || regime?.timestamp || null;
                if (evalBarTime) {
                    evalTimeFormatted = new Date(evalBarTime).toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' CST';
                } else {
                    evalTimeFormatted = evalCurrentTime.toLocaleString('en-US', {
                        timeZone: 'America/Chicago',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' CST';
                }
            }
            
            setupsDiv.innerHTML = `
                <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${setupColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${setupLabel}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${setupReason}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;">
                                Regime: ${regimeType} | Bias: ${bias} | Confidence: ${(confidence * 100).toFixed(0)}%
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                            <div style="padding: 4px 8px; background: ${readyStatusColor}20; border-radius: 4px; font-size: 11px; color: ${readyStatusColor}; font-weight: 600;">
                                READY
                            </div>
                            <div style="padding: 4px 8px; background: ${setupColor}20; border-radius: 4px; font-size: 11px; color: ${setupColor}; font-weight: 600;">
                                ${setupLabel}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 6px; background: #111827; border-radius: 4px; border-left: 2px solid ${setupColor};">
                        <div style="display: flex; justify-content: space-between; font-size: 10px;">
                            <span style="color: var(--text-secondary);"><i class="fas fa-clock" style="margin-right: 4px;"></i>Evaluating:</span>
                            <span style="color: var(--text-primary); font-weight: 600;">${evalTimeFormatted}</span>
                        </div>
                        <div style="margin-top: 4px; font-size: 10px; color: var(--text-secondary);">
                            Bar #${liveStatus?.bar_count || 'N/A'} | ${liveStatus?.bars_per_symbol ? Object.entries(liveStatus.bars_per_symbol).map(([s, c]) => `${s}: ${c}`).join(', ') : ''}
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 8px; background: #1e3a5f; border-radius: 4px; border-left: 2px solid #3b82f6;">
                        <div style="font-size: 11px; font-weight: 600; color: #93c5fd; margin-bottom: 6px;">
                            <i class="fas fa-info-circle" style="margin-right: 4px;"></i>Trade Setup Criteria:
                        </div>
                        <div style="font-size: 10px; color: #bfdbfe; line-height: 1.6;">
                            <div><strong>GOOD SETUP:</strong> Confidence ‚â•70%, Bias (BULLISH/BEARISH), Regime (TREND/EXPANSION)</div>
                            <div><strong>CAUTION:</strong> Confidence 40-70%, Moderate signals</div>
                            <div><strong>AVOID:</strong> Confidence &lt;40% or COMPRESSION regime</div>
                            <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #3b82f6;">
                                <strong>Profit Target:</strong> 15% | <strong>Stop Loss:</strong> 10%
                            </div>
                            <div><strong>Min Confidence:</strong> 15% (lowered for active trading)</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateAgentActivity(agents) {
            const activityDiv = document.getElementById('agentActivity');
            activityDiv.innerHTML = '';

            if (!agents || !agents.agents) {
                activityDiv.innerHTML = `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">No agent data available</div>
                    </div>
                `;
                return;
            }

            const agentEntries = Object.entries(agents.agents);
            if (agentEntries.length === 0) {
                activityDiv.innerHTML = `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">No active agents</div>
                    </div>
                `;
                return;
            }

            // Sort by weight (most active first)
            agentEntries.sort((a, b) => (b[1].current_weight || 0) - (a[1].current_weight || 0));

            agentEntries.forEach(([name, data]) => {
                const weight = (data.current_weight || 0) * 100;
                const fitness = data.short_term || 0;
                const barColor = weight > 20 ? '#10b981' : weight > 10 ? '#f59e0b' : '#9ca3af';
                
                activityDiv.innerHTML += `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${barColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 13px;">${name}</div>
                            <div style="padding: 2px 8px; background: ${barColor}20; border-radius: 4px; font-size: 11px; color: ${barColor};">
                                ${weight.toFixed(1)}% weight
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary);">
                            <span>Fitness: ${(fitness * 100).toFixed(1)}%</span>
                            <span>Status: ${weight > 5 ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                `;
            });
        }

        function updateRecentActivity(health, liveStatus) {
            const activityDiv = document.getElementById('recentActivity');
            const activities = [];

            if (liveStatus) {
                if (liveStatus.is_running) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: `Simulation running - ${liveStatus.bar_count || 0} bars processed`,
                        type: 'info',
                        color: '#10b981'
                    });
                }
                if (liveStatus.stop_reason) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: `Stopped: ${liveStatus.stop_reason}`,
                        type: 'warning',
                        color: '#f59e0b'
                    });
                }
            }

            if (health) {
                if (health.is_running && !health.is_paused) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: 'System running',
                        type: 'success',
                        color: '#10b981'
                    });
                } else if (health.is_paused) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: 'System paused',
                        type: 'warning',
                        color: '#f59e0b'
                    });
                }
            }

            if (activities.length === 0) {
                activityDiv.innerHTML = `
                    <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; color: var(--text-secondary);">
                        No recent activity
                    </div>
                `;
                return;
            }

            // Show last 5 activities (most recent first)
            activityDiv.innerHTML = activities.slice(-5).reverse().map(activity => `
                <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 2px solid ${activity.color}; margin-bottom: 6px;">
                    <div>
                        <div style="color: var(--text-primary); font-size: 11px;">${activity.message}</div>
                        <div style="color: var(--text-secondary); font-size: 10px; margin-top: 2px;">${activity.time}</div>
                    </div>
                    <div style="width: 8px; height: 8px; background: ${activity.color}; border-radius: 50%;"></div>
                </div>
            `).join('');
        }

        // --- Navigation ---
        function showView(viewId) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(`${viewId}-view`).classList.add('active');
            
            // Highlight nav item
            const navItems = document.querySelectorAll('.nav-item');
            if (viewId === 'dashboard') navItems[0].classList.add('active');
            if (viewId === 'analytics') navItems[1].classList.add('active');
            if (viewId === 'trades') navItems[2].classList.add('active');
            if (viewId === 'agents') navItems[3].classList.add('active');
            if (viewId === 'risk') navItems[4].classList.add('active');
            if (viewId === 'settings') navItems[5].classList.add('active');

            if (viewId === 'trades') updateFullTradesLog();
            if (viewId === 'agents') updateAgentsView();
            if (viewId === 'analytics') {
                // Load Performance tab by default when Analytics view opens
                updatePerformanceAnalytics();
            }
        }

        // --- Notifications ---
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.className = 'toast', 3000);
        }

        // --- Initialize Combined Date/Time Dropdowns ---
        // Define function first
        function initDateTimeDropdowns() {
            console.log('üîÑ initDateTimeDropdowns() called');
            console.log('üìã Current URL:', window.location.href);
            console.log('üìã Document ready state:', document.readyState);
            
            // Try multiple possible IDs
            const startDateTimeSelect = document.getElementById('simStartDateTime') || 
                                       document.getElementById('simStartDate') ||
                                       document.querySelector('select[id*="Start"]');
            const endDateTimeSelect = document.getElementById('simEndDateTime') || 
                                     document.getElementById('simEndDate') ||
                                     document.querySelector('select[id*="End"]');
            
            console.log('Dropdown elements:', {
                start: startDateTimeSelect ? '‚úÖ FOUND' : '‚ùå NOT FOUND',
                end: endDateTimeSelect ? '‚úÖ FOUND' : '‚ùå NOT FOUND',
                startId: startDateTimeSelect?.id,
                endId: endDateTimeSelect?.id,
                allSelects: document.querySelectorAll('select').length,
                allSelectIds: Array.from(document.querySelectorAll('select')).map(s => s.id).join(', ')
            });
            
            if (!startDateTimeSelect || !endDateTimeSelect) {
                console.error('‚ùå Date/Time dropdowns not found!', {
                    start: !!startDateTimeSelect,
                    end: !!endDateTimeSelect,
                    allSelects: document.querySelectorAll('select').length,
                    allSelectIds: Array.from(document.querySelectorAll('select')).map(s => s.id).join(', '),
                    pageSource: document.documentElement.innerHTML.substring(0, 500)
                });
                // Retry after a short delay
                setTimeout(initDateTimeDropdowns, 1000);
                return;
            }
            
            // Clear existing options first (including placeholder)
            startDateTimeSelect.innerHTML = '';
            endDateTimeSelect.innerHTML = '';
            console.log('‚úÖ Dropdowns cleared, starting to populate...');
            
            // Generate combined date+time options: Last 3 months of weekdays with market hours
            const now = new Date();
            const dateTimeOptions = [];
            
            // Market hours
            const marketTimes = [
                { value: '09:30', display: '9:30 AM' },
                { value: '10:00', display: '10:00 AM' },
                { value: '11:00', display: '11:00 AM' },
                { value: '12:00', display: '12:00 PM' },
                { value: '13:00', display: '1:00 PM' },
                { value: '14:00', display: '2:00 PM' },
                { value: '15:00', display: '3:00 PM' },
                { value: '16:00', display: '4:00 PM' }
            ];
            
            // Generate dates: Last 3 months of weekdays
            for (let i = 0; i < 90; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                // Only include weekdays (Mon-Fri)
                if (date.getDay() >= 1 && date.getDay() <= 5) {
                    const dateStr = date.toISOString().split('T')[0];
                    const dateDisplay = date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric' 
                    });
                    
                    // Add each time option for this date
                    marketTimes.forEach(time => {
                        const option = {
                            value: `${dateStr}T${time.value}:00`,
                            display: `${dateDisplay} ${time.display}`
                        };
                        dateTimeOptions.push(option);
                    });
                }
            }
            
            // Populate dropdowns
            console.log(`üìä Populating ${dateTimeOptions.length} date/time options...`);
            let addedCount = 0;
            try {
                dateTimeOptions.forEach(opt => {
                    const option1 = document.createElement('option');
                    option1.value = opt.value;
                    option1.textContent = opt.display;
                    startDateTimeSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = opt.value;
                    option2.textContent = opt.display;
                    endDateTimeSelect.appendChild(option2);
                    addedCount++;
                });
                console.log(`‚úÖ Added ${addedCount} options to each dropdown`);
                console.log(`‚úÖ Verification: startDateTimeSelect has ${startDateTimeSelect.options.length} options`);
                console.log(`‚úÖ Verification: endDateTimeSelect has ${endDateTimeSelect.options.length} options`);
            } catch (e) {
                console.error('‚ùå Error populating dropdowns:', e);
                // Add at least one option so dropdown is visible
                const fallbackOption = document.createElement('option');
                fallbackOption.value = '';
                fallbackOption.textContent = 'Error loading dates - please refresh';
                startDateTimeSelect.appendChild(fallbackOption);
                endDateTimeSelect.appendChild(fallbackOption.cloneNode(true));
            }
            
            // Set default values: Start = 3 months ago at 9:30 AM, End = today at 4:00 PM
            const threeMonthsAgo = new Date(now);
            threeMonthsAgo.setMonth(now.getMonth() - 3);
            // Find first weekday
            while (threeMonthsAgo.getDay() === 0 || threeMonthsAgo.getDay() === 6) {
                threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 1);
            }
            const defaultStartDate = threeMonthsAgo.toISOString().split('T')[0];
            const defaultStartValue = `${defaultStartDate}T09:30:00`;
            
            // Find today or last weekday
            const defaultEndDate = new Date(now);
            while (defaultEndDate.getDay() === 0 || defaultEndDate.getDay() === 6) {
                defaultEndDate.setDate(defaultEndDate.getDate() - 1);
            }
            const defaultEndDateStr = defaultEndDate.toISOString().split('T')[0];
            const defaultEndValue = `${defaultEndDateStr}T16:00:00`;
            
            // Set defaults
            if (dateTimeOptions.length > 0) {
                try {
                    startDateTimeSelect.value = defaultStartValue;
                    endDateTimeSelect.value = defaultEndValue;
                    console.log(`‚úÖ Combined Date/Time dropdowns initialized with ${dateTimeOptions.length} options`);
                    console.log(`   Start default: ${defaultStartValue}`);
                    console.log(`   End default: ${defaultEndValue}`);
                    console.log(`   ‚úÖ Start dropdown now has ${startDateTimeSelect.options.length} options`);
                    console.log(`   ‚úÖ End dropdown now has ${endDateTimeSelect.options.length} options`);
                    
                    // Visual confirmation - change placeholder text
                    if (startDateTimeSelect.options.length > 1) {
                        console.log('‚úÖ SUCCESS: Dropdowns are populated!');
                    }
                } catch (e) {
                    console.error('‚ùå Error setting default values:', e);
                }
            } else {
                console.error('‚ùå No date/time options generated!');
            }
        }
        
        // CRITICAL: Assign to window IMMEDIATELY after function definition
        window.initDateTimeDropdowns = initDateTimeDropdowns;
        console.log('‚úÖ initDateTimeDropdowns assigned to window:', typeof window.initDateTimeDropdowns);
        console.log('‚úÖ Window.initDateTimeDropdowns exists:', 'initDateTimeDropdowns' in window);
        
        // Also expose a test function
        window.testDropdowns = function() {
            console.log('üß™ Testing dropdowns...');
            console.log('simStartDateTime:', document.getElementById('simStartDateTime'));
            console.log('simEndDateTime:', document.getElementById('simEndDateTime'));
            console.log('All selects:', Array.from(document.querySelectorAll('select')).map(s => ({id: s.id, options: s.options.length})));
            initDateTimeDropdowns();
        }
        
        // Initialize on page load - ensure it runs
        function initializeOnLoad() {
            console.log('üîÑ Attempting to initialize dropdowns...');
            try {
                initDateTimeDropdowns();
            } catch (e) {
                console.error('‚ùå Error initializing dropdowns:', e);
                // Show error in dropdown
                const startSelect = document.getElementById('simStartDateTime');
                const endSelect = document.getElementById('simEndDateTime');
                if (startSelect) {
                    startSelect.innerHTML = '<option value="">Error - Click to refresh</option>';
                }
                if (endSelect) {
                    endSelect.innerHTML = '<option value="">Error - Click to refresh</option>';
                }
            }
        }
        
        // IMMEDIATE initialization - run right now
        (function() {
            console.log('üöÄ IMMEDIATE initialization starting...');
            initializeOnLoad();
        })();
        
        // Multiple initialization strategies to ensure it runs
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOMContentLoaded event fired');
                initializeOnLoad();
            });
        } else {
            console.log('üìÑ Document already loaded, initializing immediately');
            initializeOnLoad();
        }
        
        // Also try after delays in case elements aren't ready
        setTimeout(initializeOnLoad, 100);
        setTimeout(initializeOnLoad, 500);
        setTimeout(initializeOnLoad, 1000);
        setTimeout(initializeOnLoad, 2000);
        setTimeout(initializeOnLoad, 3000);
        
        // Force initialization when page is fully loaded
        window.addEventListener('load', function() {
            console.log('üìÑ Window load event fired, forcing dropdown initialization');
            setTimeout(initializeOnLoad, 100);
        });
        
        // Also try on visibility change (when tab becomes visible)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üëÅÔ∏è Tab became visible, re-initializing dropdowns');
                setTimeout(initializeOnLoad, 100);
            }
        });

        // --- Auto-Start Historical Simulation ---
        async function autoStartHistoricalSimulation() {
            const btn = document.getElementById('btnSim');
            if (!btn) return;
            
            // Get values from dropdowns
            const startDateSelect = document.getElementById('simStartDate');
            const startTimeSelect = document.getElementById('simStartTime');
            const endDateSelect = document.getElementById('simEndDate');
            const endTimeSelect = document.getElementById('simEndTime');
            
            if (!startDateSelect || !startTimeSelect || !endDateSelect || !endTimeSelect) {
                console.warn('Date/Time dropdowns not found');
                return;
            }
            
            const startDate = startDateSelect.value;
            const startTime = startTimeSelect.value;
            const endDate = endDateSelect.value;
            const endTime = endTimeSelect.value;
            
            // Format for API (YYYY-MM-DDTHH:MM:SS)
            const startDateTime = `${startDate}T${startTime}:00`;
            const endDateTime = `${endDate}T${endTime}:00`;
            
            // Show toast
            showToast('Starting historical simulation with SPY and QQQ...', 'success');
            
            // Auto-start simulation with both symbols
            const payload = {
                symbols: ["SPY", "QQQ"], // Both symbols automatically
                broker_type: "cached",
                offline_mode: true,
                fixed_investment_amount: 10000.0,
                replay_speed: 600.0, // Fast speed
                start_time: startDateTime,
                end_time: endDateTime
            };
            
            try {
                const res = await fetch(`${API_BASE}/live/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Historical simulation started! Processing SPY and QQQ...', 'success');
                    updateData();
                } else {
                    throw new Error(data.detail || 'Failed to start');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // --- API Controls ---
        async function startSimulation() {
            // Check if market is open
            if (marketStatus.is_open) {
                showToast('Simulation is disabled during trading hours (9:30 AM - 4:00 PM ET). Use "Start Live" for live trading.', 'error');
                return;
            }
            
            const btn = document.getElementById('btnSim');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Starting...';
            
            // Get values from combined date/time dropdowns
            const startDateTimeSelect = document.getElementById('simStartDateTime');
            const endDateTimeSelect = document.getElementById('simEndDateTime');
            
            if (!startDateTimeSelect || !endDateTimeSelect) {
                showToast('Date/Time dropdowns not found', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }
            
            // Values are already in format YYYY-MM-DDTHH:MM:00
            const startDateTime = startDateTimeSelect.value;
            const endDateTime = endDateTimeSelect.value;
            
            // Validate: end_time must be after start_time
            const start = new Date(startDateTime);
            const end = new Date(endDateTime);
            if (end <= start) {
                showToast('End date/time must be after start date/time', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }
            
            // Get replay speed
            const replaySpeedInput = document.getElementById('replaySpeed');
            const replaySpeed = replaySpeedInput ? parseFloat(replaySpeedInput.value) : 600.0;
            
            // Note: broker_type="cached" + offline_mode=true ensures synthetic bars are safe
            // Synthetic bars are ONLY generated in cached/offline mode, never in live trading
            const payload = {
                symbols: ["SPY", "QQQ"], // Always use both symbols automatically
                broker_type: "cached",   // Offline mode (synthetic bars safe here)
                offline_mode: true,      // Explicitly offline (prevents live trading with synthetic data)
                fixed_investment_amount: 10000.0, // $10k per trade for simulation
                replay_speed: replaySpeed,
                start_time: startDateTime, // Use full datetime string
                end_time: endDateTime     // Use full datetime string
            };
            
            try {
                const res = await fetch(`${API_BASE}/live/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'Simulation started', 'success');
                    updateData();
                } else {
                    throw new Error(data.detail || 'Simulation start failed');
                }
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function controlBot(action) {
            const btn = document.getElementById(`btn${action.charAt(0).toUpperCase() + action.slice(1)}`);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing';

            try {
                let endpoint = `/${action}`;
                let method = 'POST';
                let body = {};

                if (action === 'start') {
                    // Start live trading with testing_mode for aggressive trading
                    endpoint = '/live/start';
                    body = {
                        symbols: ["QQQ", "SPY"],
                        broker_type: "alpaca",  // Use Alpaca for live trading
                        offline_mode: false,
                        testing_mode: true,  // Enable force mode - allows trading with minimal bars
                        fixed_investment_amount: 10000.0
                    };
                } else if (action === 'stop') {
                    // Stop live trading/simulation
                    endpoint = '/live/stop';
                } else if (action === 'pause') {
                    // Pause/resume trading
                    endpoint = '/pause';
                } else if (action === 'kill') {
                    // Toggle logic needed or assume engage? Assuming toggle based on UI logic is complex, 
                    // let's assume this button ENGAGES kill switch for safety.
                    // Or we can check status first. Let's just try to engage.
                    body = { engage: true }; 
                }

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(data.message || `Action ${action} successful`, 'success');
                    updateData(); // Refresh status immediately
                } else {
                    throw new Error(data.detail || 'Request failed');
                }
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Data Fetching & UI Updates ---
        async function updateData() {
            try {
                const [health, stats, regime, trades, marketStatus] = await Promise.all([
                    fetch(`${API_BASE}/health`).then(r => r.json()),
                    fetch(`${API_BASE}/stats`).then(r => r.json()),
                    fetch(`${API_BASE}/regime`).then(r => r.json()),
                    fetch(`${API_BASE}/trade-log?limit=10`).then(r => r.json()),
                    fetch(`${API_BASE}/market/status`).then(r => r.json()).catch(() => ({ is_open: false }))
                ]);
                
                // 1. Header Status
                const dot = document.getElementById('statusDot');
                const txt = document.getElementById('statusText');
                const btnStart = document.getElementById('btnStart');
                const btnStop = document.getElementById('btnStop');
                const btnPause = document.getElementById('btnPause');
                
                // Show/hide Start Live button based on market hours
                if (btnStart) {
                    if (marketStatus.is_open) {
                        btnStart.style.display = 'inline-block'; // Show during trading hours
                    } else {
                        btnStart.style.display = 'none'; // Hide during non-trading hours
                    }
                }

                if (health.is_running && !health.is_paused) {
                    dot.className = 'status-dot running';
                    txt.textContent = 'System Running';
                    btnStart.disabled = true; btnStop.disabled = false; btnPause.disabled = false;
                } else if (health.is_paused) {
                    dot.className = 'status-dot paused';
                    txt.textContent = 'System Paused';
                    btnStart.disabled = true; btnStop.disabled = false; btnPause.disabled = false; // Can resume via pause btn usually? endpoint handles toggle?
                } else {
                    dot.className = 'status-dot';
                    txt.textContent = 'System Stopped';
                    btnStart.disabled = false; btnStop.disabled = true; btnPause.disabled = true;
                }
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;

                // Update status view if it's visible
                const statusView = document.getElementById('perf-status-view');
                if (statusView && statusView.style.display !== 'none') {
                    updateStatusView();
                }

                // 2. Webull Dashboard Updates
                const fmt = (n) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(n);
                
                // Sidebar Values - Always use initial_capital as base, or default to 100000
                const initialCapital = stats.initial_capital || 100000;
                const currentCapital = stats.current_capital || initialCapital;
                // Always show at least initial capital (100K)
                const accountValue = Math.max(currentCapital, initialCapital);
                
                const totalValueEl = document.getElementById('wbTotalValue');
                if (totalValueEl) {
                    totalValueEl.textContent = fmt(accountValue);
                }
                const cashEl = document.getElementById('wbCash');
                if (cashEl) {
                    cashEl.textContent = fmt(accountValue);
                }
                const bpEl = document.getElementById('wbBP');
                if (bpEl) {
                    bpEl.textContent = fmt(accountValue);
                }
                const optBpEl = document.getElementById('wbOptBP');
                if (optBpEl) {
                    optBpEl.textContent = fmt(accountValue);
                }
                
                const pnl = stats.current_capital - stats.initial_capital;
                const pnlEl = document.getElementById('wbOpenPnL');
                pnlEl.textContent = (pnl>=0?'+':'') + fmt(pnl);
                pnlEl.className = `wb-metric-val ${pnl>=0?'text-pos':'text-neg'}`;
                
                const dayEl = document.getElementById('wbDayPnL');
                dayEl.textContent = pnlEl.textContent; // Placeholder for day PnL
                dayEl.className = pnlEl.className;

                document.getElementById('wbPerfPnL').textContent = pnlEl.textContent;
                document.getElementById('wbPerfPnL').style.color = pnl>=0 ? 'var(--wb-success)' : 'var(--wb-danger)';

                // Charts
                updateCharts(stats, regime, health);

                // Trades Table (Dashboard Snippet)
                const tbody = document.querySelector('#wbPositionsTable tbody');
                tbody.innerHTML = '';
                if(trades.trades && trades.trades.length > 0) {
                    trades.trades.slice(0,5).forEach(t => {
                        const tr = document.createElement('tr');
                        // Format timestamp with date and time in CST
                        let timeStr = '-';
                        if (t.entry_time) {
                            const entryDate = new Date(t.entry_time);
                            timeStr = entryDate.toLocaleString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true,
                                timeZone: 'America/Chicago' // CST
                            });
                        }
                        tr.innerHTML = `
                            <td>${timeStr}</td>
                            <td style="font-weight:600">${t.symbol}</td>
                            <td>${t.quantity>0?'BUY':'SELL'}</td>
                            <td>${Math.abs(t.quantity)}</td>
                            <td>${fmt(t.entry_price)}</td>
                            <td>$0.00</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#9ca3af;">No recent trades</td></tr>';
                }

            } catch (e) {
                console.error("Update failed", e);
                // Show error message in trades table
                const tbody = document.querySelector('#wbPositionsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#ef4444;">Error loading data. Please refresh.</td></tr>';
                }
            }
        }
        
        // Call updateData immediately and then every 2 seconds
        updateData();
        setInterval(updateData, 2000);

        function updateCharts(stats, regime, health) {
            // Main Equity Chart
            if (!charts.main) {
                const ctx = document.getElementById('wbMainChart').getContext('2d');
                charts.main = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#00c805', backgroundColor: 'rgba(0,200,5,0.1)', fill: true, tension: 0.4, pointRadius:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: false}, scales: { x:{display:false}, y:{display:false} } }
                });
            }
            
            if (stats.equity_history && stats.equity_history.length > 0) {
                const labels = stats.equity_history.map((_,i) => i);
                charts.main.data.labels = labels;
                charts.main.data.datasets[0].data = stats.equity_history;
                charts.main.update('none');
            }

            // Mini Chart
            if (!charts.mini) {
                const ctx = document.getElementById('wbMiniChart').getContext('2d');
                charts.mini = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', borderWidth:1.5, fill: false, pointRadius:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: false}, scales: { x:{display:false}, y:{display:false} } }
                });
            }
            if (stats.equity_history) {
                charts.mini.data.labels = stats.equity_history.map((_,i)=>i);
                charts.mini.data.datasets[0].data = stats.equity_history;
                charts.mini.update('none');
            }

            // Win Rate
            const winRate = (stats.win_rate || 0) * 100;
            if (!charts.win) {
                charts.win = new Chart(document.getElementById('wbWinChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [0,100], backgroundColor: ['#3b82f6', '#e2e8f0'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            charts.win.data.datasets[0].data = [winRate, 100-winRate];
            charts.win.update();
            document.getElementById('wbWinVal').textContent = winRate.toFixed(1)+'%';

            // Regime
            const conf = (regime.confidence || 0) * 100;
            if (!charts.regime) {
                charts.regime = new Chart(document.getElementById('wbRegimeChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [0,100], backgroundColor: ['#8b5cf6', '#e2e8f0'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            charts.regime.data.datasets[0].data = [conf, 100-conf];
            charts.regime.update();
            document.getElementById('wbRegimeVal').textContent = conf.toFixed(1)+'%';

            // Risk Gauge
            if (!charts.risk) {
                charts.risk = new Chart(document.getElementById('wbRiskGauge'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [10,90], backgroundColor: ['#10b981', '#e2e8f0'], borderWidth:0, circumference:180, rotation:-90 }] },
                    options: { cutout: '75%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            // Determine risk color
            let riskVal = 10;
            let riskColor = '#10b981';
            let riskText = 'SAFE';
            if (health.risk_status?.kill_switch_engaged) {
                riskVal = 100; riskColor='#ef4444'; riskText='HALTED';
            }
            charts.risk.data.datasets[0].data = [riskVal, 100-riskVal];
            charts.risk.data.datasets[0].backgroundColor[0] = riskColor;
            charts.risk.update();
            document.getElementById('wbRiskLabel').textContent = riskText;
            document.getElementById('wbRiskLabel').style.color = riskColor;
        }

        async function updateFullTradesLog() {
            const res = await fetch(`${API_BASE}/trade-log?limit=100`);
            const data = await res.json();
            const tbody = document.querySelector('#fullTradesTable tbody');
            tbody.innerHTML = '';
            if(data.trades) {
                data.trades.forEach(t => {
                    const row = document.createElement('tr');
                    const pnl = t.pnl || 0;
                    row.innerHTML = `
                        <td>-</td>
                        <td>${t.entry_time}</td>
                        <td style="font-weight:600">${t.symbol}</td>
                        <td>${t.quantity>0?'BUY':'SELL'}</td>
                        <td>${Math.abs(t.quantity)}</td>
                        <td>${t.entry_price.toFixed(2)}</td>
                        <td class="${pnl>=0?'text-pos':'text-neg'}">${pnl.toFixed(2)}</td>
                        <td>${t.reason || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        async function updateAgentsView() {
            const res = await fetch(`${API_BASE}/agents`);
            const data = await res.json();
            const grid = document.getElementById('agentsGrid');
            grid.innerHTML = '';
            
            if (data.agents) {
                // Convert to array if needed
                const agents = Array.isArray(data.agents) ? data.agents : Object.entries(data.agents).map(([k,v]) => ({name:k, ...v}));
                agents.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'wb-card';
                    card.innerHTML = `
                        <div class="wb-card-title" style="text-transform:capitalize;">${a.name}</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--wb-text-primary); margin: 10px 0;">
                            ${((a.weight || a.current_weight || 0)*100).toFixed(1)}%
                        </div>
                        <div class="wb-metric-label">Allocation</div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        // --- Market Status Check & Auto-Start ---
        let marketStatus = { is_open: false };
        let autoStartAttempted = false;
        
        async function checkMarketStatus() {
            try {
                const res = await fetch(`${API_BASE}/market/status`);
                marketStatus = await res.json();
                
                // Show/hide Start Live button based on market hours
                const btnStart = document.getElementById('btnStart');
                if (btnStart) {
                    if (marketStatus.is_open) {
                        btnStart.style.display = 'inline-block'; // Show during trading hours
                    } else {
                        btnStart.style.display = 'none'; // Hide during non-trading hours
                    }
                }
                
                // Keep Simulate button and all simulation controls always visible
                // Users can test historical data anytime
                const btnSim = document.getElementById('btnSim');
                if (btnSim) {
                    btnSim.style.display = 'inline-block'; // Always visible
                }
                
                // Keep all simulation controls visible
                const simControls = document.querySelectorAll('#simStartDateTime, #simEndDateTime, #replaySpeed');
                simControls.forEach(ctrl => {
                    if (ctrl) ctrl.style.display = 'inline-block';
                });
                    
                    // Auto-start live trading if not already running
                    if (!autoStartAttempted) {
                        autoStartAttempted = true;
                        setTimeout(async () => {
                            try {
                                const liveStatus = await fetch(`${API_BASE}/live/status`).then(r => r.json()).catch(() => ({ active: false, is_running: false }));
                                if (!liveStatus.active && !liveStatus.is_running) {
                                    // Auto-start with SPY and QQQ - use testing_mode for aggressive trading
                                    const autoStartPayload = {
                                        symbols: ["SPY", "QQQ"],
                                        broker_type: "alpaca",  // Use Alpaca for live trading
                                        offline_mode: false,
                                        testing_mode: true,  // Enable force mode - allows trading with minimal bars
                                        fixed_investment_amount: 10000.0
                                    };
                                    const res = await fetch(`${API_BASE}/live/start`, {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify(autoStartPayload)
                                    });
                                    if (res.ok) {
                                        console.log('‚úÖ Auto-started live trading with SPY and QQQ');
                                        showToast('Auto-trading started: SPY & QQQ', 'success');
                                    }
                                }
                            } catch (e) {
                                console.error('Auto-start failed:', e);
                            }
                        }, 3000); // Wait 3 seconds after page load
                    }
                } else {
                    // Market closed - show simulation controls
                    simControls.forEach(ctrl => {
                        if (ctrl) ctrl.style.display = 'inline-block';
                    });
                    autoStartAttempted = false; // Reset for next market open
                }
            } catch (e) {
                console.error('Error checking market status:', e);
            }
        }

        // --- TradingView Widget ---
        function loadTradingViewChart(symbol = 'SPY') {
            const widgetContainer = document.getElementById('tradingview-widget');
            if (!widgetContainer) return;
            
            // Clear existing widget
            widgetContainer.innerHTML = '';
            
            // Create TradingView widget
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/tv.js';
            script.onload = function() {
                new TradingView.widget({
                    "autosize": true,
                    "symbol": `NASDAQ:${symbol}`,
                    "interval": "1",
                    "timezone": "America/Chicago",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tradingview-widget",
                    "hide_side_toolbar": false,
                    "studies": [
                        "RSI@tv-basicstudies",
                        "MACD@tv-basicstudies",
                        "Volume@tv-basicstudies"
                    ],
                    "show_popup_button": true,
                    "popup_width": "1000",
                    "popup_height": "650"
                });
            };
            document.head.appendChild(script);
        }
        
        // Update TradingView chart when symbol changes or Performance tab opens
        let currentChartSymbol = 'SPY';
        const originalShowAnalyticsTab = showAnalyticsTab;
        showAnalyticsTab = function(tabId, el) {
            originalShowAnalyticsTab(tabId, el);
            if (tabId === 'perf') {
                const symbolSelect = document.getElementById('simSymbol');
                if (symbolSelect) {
                    currentChartSymbol = symbolSelect.value;
                }
                setTimeout(() => loadTradingViewChart(currentChartSymbol), 500);
            }
        };
        
        // --- Init ---
        setInterval(updateData, 2000);
        setInterval(checkMarketStatus, 60000); // Check market status every minute
        updateData(); // Initial load
        checkMarketStatus(); // Initial market status check

    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Handle install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // You can show a custom install button here if needed
            console.log('PWA install prompt available');
        });
    </script>
</body>
</html>


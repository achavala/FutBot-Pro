<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FutBot Pro - Professional Trading Bot Dashboard">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FutBot Pro">
    <title>FutBot Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237c3aed'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'%3EF%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Dark Theme Colors */
            --nav-bg: #1a1e23;
            --nav-text: #9ca3af;
            --nav-text-active: #ffffff;
            --nav-item-hover: #2d333b;
            --nav-accent: #7c3aed;
            
            --header-bg: #1f2937;
            --header-text: #ffffff;

            --main-bg: #0f172a; /* Dark background */
            --card-bg: #1e293b; /* Dark card background */
            
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #334155;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; display: flex; height: 100vh; background: var(--main-bg); color: var(--text-primary); overflow: hidden; }

        /* --- Navigation Sidebar --- */
        .nav-sidebar {
            width: 240px;
            background: var(--nav-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .brand {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: white;
            font-weight: 700;
            font-size: 20px;
            border-bottom: 1px solid #2d333b;
        }
        
        .brand i { color: var(--nav-accent); margin-right: 10px; }

        .nav-menu {
            padding: 20px 16px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--nav-text);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: var(--nav-item-hover);
            color: white;
        }

        .nav-item.active {
            background: var(--nav-accent);
            color: white;
        }

        .nav-item i { width: 24px; margin-right: 12px; }

        /* --- Main Layout --- */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* --- Top Header --- */
        .app-header {
            height: 64px;
            background: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
        }
        .status-dot.running { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-dot.paused { background: #f59e0b; }

        .status-text {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }
        .ctrl-btn:hover { opacity: 0.9; }
        .ctrl-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-start { background: #10b981; color: white; }
        .btn-stop { background: #ef4444; color: white; }
        .btn-pause { background: #f59e0b; color: white; }
        .btn-kill { background: #b91c1c; color: white; }

        /* --- Views Container --- */
        .content-container {
            flex: 1;
            overflow: hidden; /* Scroll handled inside views */
            position: relative;
        }

        .view-section {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
            overflow-y: auto;
        }

        .view-section.active { display: block; }

        /* --- General Styles --- */
        .section-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }

        .data-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* --- Sub Tabs --- */
        .sub-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .sub-tab {
            padding: 10px 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .sub-tab:hover { color: var(--text-primary); }
        .sub-tab.active { color: var(--nav-accent); border-bottom-color: var(--nav-accent); }

        /* --- Grid Layouts --- */
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .card-body { padding: 20px; height: 300px; display: flex; align-items: center; justify-content: center; }

        /* --- Dashboard Layout --- */
        #dashboard-view {
            flex-direction: row;
            height: 100%;
            background: var(--main-bg);
            overflow: hidden; 
        }
        #dashboard-view.active { display: flex; }

        .wb-sidebar {
            width: 300px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
        }
        .wb-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Webull Style Overrides for Dark Mode --- */
        .wb-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            padding: 20px;
        }
        .wb-title { color: var(--text-secondary); font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .wb-value { color: var(--text-primary); font-size: 28px; font-weight: 700; }
        .wb-metric-label { color: var(--text-secondary); }
        .wb-metric-val { color: var(--text-primary); font-weight: 600; }
        table.wb-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table.wb-table th { text-align: left; padding: 10px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); font-weight: 500; }
        table.wb-table td { padding: 10px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); }
        
        .wb-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #334155; color: #38bdf8; margin-left: 8px; vertical-align: middle; }
        .wb-metric-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .text-pos { color: var(--success) !important; }
        .text-neg { color: var(--danger) !important; }
        .wb-grid-top { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; min-height: 350px; }
        .wb-grid-mid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .wb-card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .wb-card-title { font-weight: 600; color: var(--text-primary); font-size: 16px; }
        
        .simple-view-container { padding: 24px; max-width: 1200px; margin: 0 auto; }


        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .nav-sidebar {
                width: 100%;
                height: auto;
                max-height: 60px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .brand {
                height: 60px;
                min-width: 120px;
                font-size: 16px;
            }
            
            .nav-menu {
                display: flex;
                flex-direction: row;
                padding: 0;
                overflow-x: auto;
                flex: 1;
            }
            
            .nav-item {
                white-space: nowrap;
                margin: 0 4px;
                padding: 8px 12px;
                min-width: fit-content;
            }
            
            .nav-item i {
                margin-right: 6px;
            }
            
            .app-main {
                height: calc(100vh - 60px);
            }
            
            .app-header {
                height: 56px;
                padding: 0 16px;
                font-size: 14px;
            }
            
            .view-content {
                padding: 16px;
            }
            
            .wb-card {
                min-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .analytics-tabs {
                flex-direction: column;
            }
            
            .analytics-tab {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .app-header {
                font-size: 12px;
            }
            
            .status-indicator {
                gap: 8px;
            }
            
            .view-content {
                padding: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <div class="nav-sidebar">
        <div class="brand"><i class="fas fa-robot"></i> FutBot Pro</div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="showView('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
            <div class="nav-item" onclick="showView('analytics')"><i class="fas fa-chart-pie"></i> Analytics</div>
            <div class="nav-item" onclick="showView('trades')"><i class="fas fa-list"></i> Trades</div>
            <div class="nav-item" onclick="showView('agents')"><i class="fas fa-users-cog"></i> Agents</div>
            <div class="nav-item" onclick="showView('risk')"><i class="fas fa-shield-alt"></i> Risk Mgmt</div>
            <div class="nav-item" onclick="showView('settings')"><i class="fas fa-cog"></i> Settings</div>
        </div>
        <div style="padding: 20px; color: #6b7280; font-size: 12px;">
            v2.1.0 Stable
        </div>
    </div>

    <!-- Main App -->
    <div class="app-main">
        <!-- Top Header -->
        <div class="app-header">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <div class="status-text" id="statusText">System Stopped</div>
                <div style="margin-left: 10px; font-size: 12px; color: #9ca3af;" id="lastUpdate">Last update: -</div>
            </div>
            <div class="header-controls">
                <!-- Simulation Controls (shown when Simulate button is visible) -->
                <select id="simSymbol" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               max-width: 100px; display: inline-block;"
                        title="Select symbol for simulation">
                    <option value="SPY" selected>SPY</option>
                    <option value="QQQ">QQQ</option>
                </select>
                <select id="simStartDate" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               max-width: 180px; display: inline-block;"
                        title="Select start date for simulation (last 3 months)">
                    <option value="">All Available Data</option>
                </select>
                <select id="replaySpeed" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               max-width: 120px;"
                        title="Replay speed multiplier">
                    <option value="1">1x (Real-time)</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                    <option value="600" selected>600x (Fast)</option>
                </select>
                <button class="ctrl-btn btn-start" id="btnStart" onclick="controlBot('start')"><i class="fas fa-play"></i> Start Live</button>
                <button class="ctrl-btn btn-sim" id="btnSim" onclick="startSimulation()" style="background:#3b82f6; color:white;"><i class="fas fa-flask"></i> Simulate</button>
                <button class="ctrl-btn btn-pause" id="btnPause" onclick="controlBot('pause')"><i class="fas fa-pause"></i> Pause</button>
                <button class="ctrl-btn btn-stop" id="btnStop" onclick="controlBot('stop')"><i class="fas fa-stop"></i> Stop</button>
                <div style="width: 1px; background: #374151; margin: 0 8px;"></div>
                <button class="ctrl-btn btn-kill" id="btnKill" onclick="controlBot('kill')"><i class="fas fa-skull"></i> Kill Switch</button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            
            <!-- DASHBOARD VIEW (Webull Style) -->
            <div id="dashboard-view" class="view-section active">
                <!-- Webull Sidebar (Account Details) -->
                <div class="wb-sidebar">
                    <div style="margin-bottom: 30px;">
                        <div class="wb-title">TOTAL ACCOUNT VALUE</div>
                        <div class="wb-value"><span id="wbTotalValue">$0.00</span> <span class="wb-badge">LIVE</span></div>
                    </div>
                    
                    <div style="height: 150px; margin-bottom: 30px;">
                        <canvas id="wbMiniChart"></canvas>
                    </div>

                    <div style="flex: 1;">
                        <div class="wb-title" style="margin-bottom: 15px;">DETAILS</div>
                        <div class="wb-metric-row"><span>Day's P&L</span> <span id="wbDayPnL" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Open P&L</span> <span id="wbOpenPnL" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Cash Balance</span> <span id="wbCash" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Buying Power</span> <span id="wbBP" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Options BP</span> <span id="wbOptBP" class="wb-metric-val">$0.00</span></div>
                    </div>

                    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--wb-border);">
                        <div class="wb-title">RISK LEVEL</div>
                        <div style="height: 100px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="wbRiskGauge"></canvas>
                        </div>
                        <div style="text-align: center; font-weight: 700; color: var(--wb-text-primary);" id="wbRiskLabel">SAFE</div>
                    </div>
                </div>

                <!-- Webull Main Content -->
                <div class="wb-main">
                    <div class="wb-grid-top">
                        <div class="wb-card">
                            <div class="wb-card-header">
                                <div class="wb-card-title">Performance</div>
                                <div>
                                    <span id="wbPerfPnL" style="font-size: 24px; font-weight: 600;">$0.00</span>
                                </div>
                            </div>
                            <div style="flex: 1; position: relative;">
                                <canvas id="wbMainChart"></canvas>
                            </div>
                        </div>
                        <div class="wb-card">
                            <div class="wb-card-header">
                                <div class="wb-card-title">Components</div>
                            </div>
                            <div style="display: flex; flex-direction: column; justify-content: space-around; height: 100%;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px;"><canvas id="wbWinChart"></canvas></div>
                                    <div><div class="wb-title">Win Rate</div><div class="wb-metric-val" id="wbWinVal">0%</div></div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px;"><canvas id="wbRegimeChart"></canvas></div>
                                    <div><div class="wb-title">Regime Confidence</div><div class="wb-metric-val" id="wbRegimeVal">0%</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wb-card" style="flex: 1; min-height: 300px;">
                        <div class="wb-card-header">
                            <div class="wb-card-title">Positions & Recent Trades</div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="wb-table" id="wbPositionsTable">
                                <thead>
                                    <tr><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>Comm</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="analytics-view" class="view-section simple-view-container">
                <div class="section-header"><i class="fas fa-chart-pie"></i> Analytics</div>
                
                <!-- Sub Tabs -->
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="showAnalyticsTab('perf', this)">Performance</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('regime', this)">Regime Analysis</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('vol', this)">Volatility</div>
                </div>

                <!-- Tab Content: Performance -->
                <div id="ana-perf" class="ana-tab-content" style="display:block;">
                    <div class="grid-2-col">
                        <div class="data-card">
                            <div class="card-header">Performance Metrics</div>
                            <div class="card-body" style="position:relative;">
                                <div style="text-align:center; color:var(--text-secondary);">
                                    <div style="margin-bottom:10px;">Loading...</div>
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="card-header">Drawdown Analysis</div>
                            <div class="card-body">
                                <canvas id="drawdownChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Regime (Placeholder) -->
                <div id="ana-regime" class="ana-tab-content" style="display:none;">
                    <div class="data-card">
                        <div class="card-header">Regime Distribution</div>
                        <div class="card-body"><canvas id="regimeDistChart"></canvas></div>
                    </div>
                </div>
                
                 <!-- Tab Content: Volatility (Placeholder) -->
                <div id="ana-vol" class="ana-tab-content" style="display:none;">
                    <div class="data-card">
                        <div class="card-header">Volatility Analysis</div>
                        <div class="card-body">No data available</div>
                    </div>
                </div>
            </div>

            <!-- TRADES VIEW -->
            <div id="trades-view" class="view-section simple-view-container">
                <div class="section-header">Trade History</div>
                <div class="data-card">
                    <table class="wb-table" id="fullTradesTable">
                        <thead>
                            <tr><th>ID</th><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>PnL</th><th>Reason</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- AGENTS VIEW -->
            <div id="agents-view" class="view-section simple-view-container">
                <div class="section-header">Active Agents</div>
                <div class="wb-grid-mid" id="agentsGrid">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- RISK VIEW -->
            <div id="risk-view" class="view-section simple-view-container">
                <div class="section-header">Risk Management</div>
                <div class="data-card" style="padding: 20px;">
                    <div id="riskJson">Loading...</div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="settings-view" class="view-section simple-view-container">
                <div class="section-header">Settings</div>
                <div class="data-card" style="padding: 20px;">
                    <p>Configuration options...</p>
                </div>
            </div>

        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <script>
        const API_BASE = window.location.origin;
        let charts = {}; // Store chart instances

        function showAnalyticsTab(tabId, el) {
            // Hide all tabs
            document.querySelectorAll('.ana-tab-content').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected
            document.getElementById(`ana-${tabId}`).style.display = 'block';
            el.classList.add('active');
        }

        // --- Navigation ---
        function showView(viewId) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(`${viewId}-view`).classList.add('active');
            
            // Highlight nav item
            const navItems = document.querySelectorAll('.nav-item');
            if (viewId === 'dashboard') navItems[0].classList.add('active');
            if (viewId === 'analytics') navItems[1].classList.add('active');
            if (viewId === 'trades') navItems[2].classList.add('active');
            if (viewId === 'agents') navItems[3].classList.add('active');
            if (viewId === 'risk') navItems[4].classList.add('active');
            if (viewId === 'settings') navItems[5].classList.add('active');

            if (viewId === 'trades') updateFullTradesLog();
            if (viewId === 'agents') updateAgentsView();
        }

        // --- Notifications ---
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.className = 'toast', 3000);
        }

        // --- Populate Date Dropdown (Last 3 Months) ---
        function populateDateDropdown() {
            const dateSelect = document.getElementById('simStartDate');
            if (!dateSelect) return;
            
            // Clear existing options except "All Available Data"
            while (dateSelect.options.length > 1) {
                dateSelect.remove(1);
            }
            
            // Generate dates for last 3 months (weekdays only - trading days)
            const today = new Date();
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(today.getMonth() - 3);
            
            const dates = [];
            const currentDate = new Date(threeMonthsAgo);
            
            // Generate dates (weekdays only, Monday-Friday)
            while (currentDate <= today) {
                const dayOfWeek = currentDate.getDay();
                // 0 = Sunday, 6 = Saturday, skip weekends
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    // Store ISO date (YYYY-MM-DD) as value for backend
                    const dateStr = currentDate.toISOString().split('T')[0];
                    // Store formatted date as label for user display
                    const formattedDate = currentDate.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    dates.push({ value: dateStr, label: formattedDate });
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Add dates to dropdown (most recent first)
            // NOTE: option.value = ISO date (for backend), option.textContent = formatted label (for display)
            // TODO: Future enhancement - query /cache/coverage endpoint to only show dates with actual cached data
            dates.reverse().forEach(date => {
                const option = document.createElement('option');
                option.value = date.value;  // ISO format: "2024-11-25"
                option.textContent = date.label;  // Display: "Mon, Nov 25, 2024"
                dateSelect.appendChild(option);
            });
        }
        
        // Initialize date dropdown on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', populateDateDropdown);
        } else {
            populateDateDropdown();
        }

        // --- API Controls ---
        async function startSimulation() {
            const btn = document.getElementById('btnSim');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Starting...';
            
            // Get selected symbol
            const symbolSelect = document.getElementById('simSymbol');
            const selectedSymbol = symbolSelect ? symbolSelect.value : 'SPY';
            
            // Get start date from dropdown (optional)
            const startDateSelect = document.getElementById('simStartDate');
            // Explicitly check for empty string to avoid sending "" to backend
            const startDate = startDateSelect && startDateSelect.value && startDateSelect.value.trim() !== '' 
                ? startDateSelect.value.trim() 
                : null;
            
            // Get replay speed
            const replaySpeedInput = document.getElementById('replaySpeed');
            const replaySpeed = replaySpeedInput ? parseFloat(replaySpeedInput.value) : 600.0;
            
            const payload = {
                symbols: [selectedSymbol], // Use selected symbol only
                broker_type: "cached",   // Offline mode
                offline_mode: true,
                fixed_investment_amount: 10000.0, // $10k per trade for simulation
                replay_speed: replaySpeed
            };
            
            // Add start_date only if a valid date is selected (not "All Available Data")
            // Backend expects ISO format string (YYYY-MM-DD) or null/undefined
            if (startDate && startDate !== '') {
                payload.start_date = startDate;
            }
            // If startDate is null or empty, we don't include it in payload (backend uses all available data)
            
            try {
                const res = await fetch(`${API_BASE}/live/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    showToast(data.message || 'Simulation started', 'success');
                    updateData();
                } else {
                    throw new Error(data.detail || 'Simulation start failed');
                }
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function controlBot(action) {
            const btn = document.getElementById(`btn${action.charAt(0).toUpperCase() + action.slice(1)}`);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing';

            try {
                let endpoint = `/${action}`;
                let method = 'POST';
                let body = {};

                if (action === 'start') {
                    // Default start params
                    body = {}; 
                } else if (action === 'kill') {
                    // Toggle logic needed or assume engage? Assuming toggle based on UI logic is complex, 
                    // let's assume this button ENGAGES kill switch for safety.
                    // Or we can check status first. Let's just try to engage.
                    body = { engage: true }; 
                }

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(data.message || `Action ${action} successful`, 'success');
                    updateData(); // Refresh status immediately
                } else {
                    throw new Error(data.detail || 'Request failed');
                }
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Data Fetching & UI Updates ---
        async function updateData() {
            try {
                const [health, stats, regime, trades] = await Promise.all([
                    fetch(`${API_BASE}/health`).then(r => r.json()),
                    fetch(`${API_BASE}/stats`).then(r => r.json()),
                    fetch(`${API_BASE}/regime`).then(r => r.json()),
                    fetch(`${API_BASE}/trade-log?limit=10`).then(r => r.json())
                ]);

                // 1. Header Status
                const dot = document.getElementById('statusDot');
                const txt = document.getElementById('statusText');
                const btnStart = document.getElementById('btnStart');
                const btnStop = document.getElementById('btnStop');
                const btnPause = document.getElementById('btnPause');

                if (health.is_running && !health.is_paused) {
                    dot.className = 'status-dot running';
                    txt.textContent = 'System Running';
                    btnStart.disabled = true; btnStop.disabled = false; btnPause.disabled = false;
                } else if (health.is_paused) {
                    dot.className = 'status-dot paused';
                    txt.textContent = 'System Paused';
                    btnStart.disabled = true; btnStop.disabled = false; btnPause.disabled = false; // Can resume via pause btn usually? endpoint handles toggle?
                } else {
                    dot.className = 'status-dot';
                    txt.textContent = 'System Stopped';
                    btnStart.disabled = false; btnStop.disabled = true; btnPause.disabled = true;
                }
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;

                // 2. Webull Dashboard Updates
                const fmt = (n) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(n);
                
                // Sidebar Values
                document.getElementById('wbTotalValue').textContent = fmt(stats.current_capital);
                document.getElementById('wbCash').textContent = fmt(stats.current_capital);
                document.getElementById('wbBP').textContent = fmt(stats.current_capital); // Simplified
                document.getElementById('wbOptBP').textContent = fmt(stats.current_capital);
                
                const pnl = stats.current_capital - stats.initial_capital;
                const pnlEl = document.getElementById('wbOpenPnL');
                pnlEl.textContent = (pnl>=0?'+':'') + fmt(pnl);
                pnlEl.className = `wb-metric-val ${pnl>=0?'text-pos':'text-neg'}`;
                
                const dayEl = document.getElementById('wbDayPnL');
                dayEl.textContent = pnlEl.textContent; // Placeholder for day PnL
                dayEl.className = pnlEl.className;

                document.getElementById('wbPerfPnL').textContent = pnlEl.textContent;
                document.getElementById('wbPerfPnL').style.color = pnl>=0 ? 'var(--wb-success)' : 'var(--wb-danger)';

                // Charts
                updateCharts(stats, regime, health);

                // Trades Table (Dashboard Snippet)
                const tbody = document.querySelector('#wbPositionsTable tbody');
                tbody.innerHTML = '';
                if(trades.trades && trades.trades.length > 0) {
                    trades.trades.slice(0,5).forEach(t => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${new Date(t.entry_time).toLocaleTimeString()}</td>
                            <td style="font-weight:600">${t.symbol}</td>
                            <td>${t.quantity>0?'BUY':'SELL'}</td>
                            <td>${Math.abs(t.quantity)}</td>
                            <td>${fmt(t.entry_price)}</td>
                            <td>$0.00</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#9ca3af;">No recent trades</td></tr>';
                }

            } catch (e) {
                console.error("Update failed", e);
            }
        }

        function updateCharts(stats, regime, health) {
            // Main Equity Chart
            if (!charts.main) {
                const ctx = document.getElementById('wbMainChart').getContext('2d');
                charts.main = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#00c805', backgroundColor: 'rgba(0,200,5,0.1)', fill: true, tension: 0.4, pointRadius:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: false}, scales: { x:{display:false}, y:{display:false} } }
                });
            }
            
            if (stats.equity_history && stats.equity_history.length > 0) {
                const labels = stats.equity_history.map((_,i) => i);
                charts.main.data.labels = labels;
                charts.main.data.datasets[0].data = stats.equity_history;
                charts.main.update('none');
            }

            // Mini Chart
            if (!charts.mini) {
                const ctx = document.getElementById('wbMiniChart').getContext('2d');
                charts.mini = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', borderWidth:1.5, fill: false, pointRadius:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: false}, scales: { x:{display:false}, y:{display:false} } }
                });
            }
            if (stats.equity_history) {
                charts.mini.data.labels = stats.equity_history.map((_,i)=>i);
                charts.mini.data.datasets[0].data = stats.equity_history;
                charts.mini.update('none');
            }

            // Win Rate
            const winRate = (stats.win_rate || 0) * 100;
            if (!charts.win) {
                charts.win = new Chart(document.getElementById('wbWinChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [0,100], backgroundColor: ['#3b82f6', '#e2e8f0'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            charts.win.data.datasets[0].data = [winRate, 100-winRate];
            charts.win.update();
            document.getElementById('wbWinVal').textContent = winRate.toFixed(1)+'%';

            // Regime
            const conf = (regime.confidence || 0) * 100;
            if (!charts.regime) {
                charts.regime = new Chart(document.getElementById('wbRegimeChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [0,100], backgroundColor: ['#8b5cf6', '#e2e8f0'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            charts.regime.data.datasets[0].data = [conf, 100-conf];
            charts.regime.update();
            document.getElementById('wbRegimeVal').textContent = conf.toFixed(1)+'%';

            // Risk Gauge
            if (!charts.risk) {
                charts.risk = new Chart(document.getElementById('wbRiskGauge'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [10,90], backgroundColor: ['#10b981', '#e2e8f0'], borderWidth:0, circumference:180, rotation:-90 }] },
                    options: { cutout: '75%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            // Determine risk color
            let riskVal = 10;
            let riskColor = '#10b981';
            let riskText = 'SAFE';
            if (health.risk_status?.kill_switch_engaged) {
                riskVal = 100; riskColor='#ef4444'; riskText='HALTED';
            }
            charts.risk.data.datasets[0].data = [riskVal, 100-riskVal];
            charts.risk.data.datasets[0].backgroundColor[0] = riskColor;
            charts.risk.update();
            document.getElementById('wbRiskLabel').textContent = riskText;
            document.getElementById('wbRiskLabel').style.color = riskColor;
        }

        async function updateFullTradesLog() {
            const res = await fetch(`${API_BASE}/trade-log?limit=100`);
            const data = await res.json();
            const tbody = document.querySelector('#fullTradesTable tbody');
            tbody.innerHTML = '';
            if(data.trades) {
                data.trades.forEach(t => {
                    const row = document.createElement('tr');
                    const pnl = t.pnl || 0;
                    row.innerHTML = `
                        <td>-</td>
                        <td>${t.entry_time}</td>
                        <td style="font-weight:600">${t.symbol}</td>
                        <td>${t.quantity>0?'BUY':'SELL'}</td>
                        <td>${Math.abs(t.quantity)}</td>
                        <td>${t.entry_price.toFixed(2)}</td>
                        <td class="${pnl>=0?'text-pos':'text-neg'}">${pnl.toFixed(2)}</td>
                        <td>${t.reason || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        async function updateAgentsView() {
            const res = await fetch(`${API_BASE}/agents`);
            const data = await res.json();
            const grid = document.getElementById('agentsGrid');
            grid.innerHTML = '';
            
            if (data.agents) {
                // Convert to array if needed
                const agents = Array.isArray(data.agents) ? data.agents : Object.entries(data.agents).map(([k,v]) => ({name:k, ...v}));
                agents.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'wb-card';
                    card.innerHTML = `
                        <div class="wb-card-title" style="text-transform:capitalize;">${a.name}</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--wb-text-primary); margin: 10px 0;">
                            ${((a.weight || a.current_weight || 0)*100).toFixed(1)}%
                        </div>
                        <div class="wb-metric-label">Allocation</div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        // --- Init ---
        setInterval(updateData, 2000);
        updateData();

    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Handle install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // You can show a custom install button here if needed
            console.log('PWA install prompt available');
        });
    </script>
</body>
</html>


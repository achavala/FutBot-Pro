<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FutBot Pro - Professional Trading Bot Dashboard">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FutBot Pro">
    <title>FutBot Pro</title>
    
    <!-- CRITICAL: This script MUST execute - if you don't see this log, scripts are blocked -->
    <script>
        console.log('ðŸš€ EARLY SCRIPT: This should appear FIRST in console!');
        console.log('ðŸš€ Script execution test:', new Date().toISOString());
        console.log('ðŸš€ Window object available:', typeof window !== 'undefined');
    </script>
    
    <!-- Force cache clear on every load -->
    <script>
        // Clear all caches on page load
        if ('caches' in window) {
            caches.keys().then(function(names) {
                for (let name of names) {
                    caches.delete(name);
                }
            });
        }
        
        // Force reload if page was loaded from cache
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237c3aed'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white' font-weight='bold'%3EF%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Dark Theme Colors */
            --nav-bg: #1a1e23;
            --nav-text: #9ca3af;
            --nav-text-active: #ffffff;
            --nav-item-hover: #2d333b;
            --nav-accent: #7c3aed;
            
            --header-bg: #1f2937;
            --header-text: #ffffff;

            --main-bg: #0f172a; /* Dark background */
            --card-bg: #1e293b; /* Dark card background */
            
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #334155;
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; display: flex; height: 100vh; background: var(--main-bg); color: var(--text-primary); overflow: hidden; }

        /* --- Navigation Sidebar --- */
        .nav-sidebar {
            width: 240px;
            background: var(--nav-bg);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .brand {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            color: white;
            font-weight: 700;
            font-size: 20px;
            border-bottom: 1px solid #2d333b;
        }
        
        .brand i { color: var(--nav-accent); margin-right: 10px; }

        .nav-menu {
            padding: 20px 16px;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--nav-text);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: var(--nav-item-hover);
            color: white;
        }

        .nav-item.active {
            background: var(--nav-accent);
            color: white;
        }

        .nav-item i { width: 24px; margin-right: 12px; }

        /* --- Main Layout --- */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* --- Top Header --- */
        .app-header {
            height: 64px;
            background: var(--header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
        }
        .status-dot.running { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-dot.paused { background: #f59e0b; }

        .status-text {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }
        .ctrl-btn:hover { opacity: 0.9; }
        .ctrl-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-start { background: #10b981; color: white; }
        .btn-stop { background: #ef4444; color: white; }
        .btn-pause { background: #f59e0b; color: white; }
        .btn-kill { background: #b91c1c; color: white; }

        /* DateTime Input Styling */
        .datetime-input {
            cursor: pointer;
            transition: all 0.2s;
        }
        .datetime-input:hover {
            border-color: var(--nav-accent) !important;
            background: var(--card-bg) !important;
        }
        .datetime-input:focus {
            outline: none;
            border-color: var(--nav-accent) !important;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        /* Make datetime-local input look like a button */
        .datetime-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.8;
            filter: invert(1);
        }
        .datetime-input::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* --- Views Container --- */
        .content-container {
            flex: 1;
            overflow: hidden; /* Scroll handled inside views */
            position: relative;
        }

        .view-section {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: none;
            overflow-y: auto;
        }

        .view-section.active { display: block; }

        /* --- General Styles --- */
        .section-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }

        .data-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* --- Sub Tabs --- */
        .sub-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .sub-tab {
            padding: 10px 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .sub-tab:hover { color: var(--text-primary); }
        .sub-tab.active { color: var(--nav-accent); border-bottom-color: var(--nav-accent); }

        /* --- Grid Layouts --- */
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .card-body { padding: 20px; height: 300px; display: flex; align-items: center; justify-content: center; }

        /* --- Dashboard Layout --- */
        #dashboard-view {
            flex-direction: row;
            height: 100%;
            background: var(--main-bg);
            overflow: hidden; 
        }
        #dashboard-view.active { display: flex; }

        .wb-sidebar {
            width: 300px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
        }
        .wb-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Webull Style Overrides for Dark Mode --- */
        .wb-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            padding: 20px;
        }
        .wb-title { color: var(--text-secondary); font-size: 13px; font-weight: 500; margin-bottom: 4px; }
        .wb-value { color: var(--text-primary); font-size: 28px; font-weight: 700; }
        .wb-metric-label { color: var(--text-secondary); }
        .wb-metric-val { color: var(--text-primary); font-weight: 600; }
        table.wb-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        table.wb-table th { text-align: left; padding: 10px; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); font-weight: 500; }
        table.wb-table td { padding: 10px; color: var(--text-primary); border-bottom: 1px solid var(--border-color); }
        
        .wb-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #334155; color: #38bdf8; margin-left: 8px; vertical-align: middle; }
        .wb-metric-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
        .text-pos { color: var(--success) !important; }
        .text-neg { color: var(--danger) !important; }
        .wb-grid-top { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; min-height: 350px; }
        .wb-grid-mid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .wb-card-header { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .wb-card-title { font-weight: 600; color: var(--text-primary); font-size: 16px; }
        
        .simple-view-container { padding: 24px; max-width: 1200px; margin: 0 auto; }


        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        /* --- Mobile Responsive --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .nav-sidebar {
                width: 100%;
                height: auto;
                max-height: 60px;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .brand {
                height: 60px;
                min-width: 120px;
                font-size: 16px;
            }
            
            .nav-menu {
                display: flex;
                flex-direction: row;
                padding: 0;
                overflow-x: auto;
                flex: 1;
            }
            
            .nav-item {
                white-space: nowrap;
                margin: 0 4px;
                padding: 8px 12px;
                min-width: fit-content;
            }
            
            .nav-item i {
                margin-right: 6px;
            }
            
            .app-main {
                height: calc(100vh - 60px);
            }
            
            .app-header {
                height: 56px;
                padding: 0 16px;
                font-size: 14px;
            }
            
            .view-content {
                padding: 16px;
            }
            
            .wb-card {
                min-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .analytics-tabs {
                flex-direction: column;
            }
            
            .analytics-tab {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .app-header {
                font-size: 12px;
            }
            
            .status-indicator {
                gap: 8px;
            }
            
            .view-content {
                padding: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <div class="nav-sidebar">
        <div class="brand"><i class="fas fa-robot"></i> FutBot Pro</div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="showView('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</div>
            <div class="nav-item" onclick="showView('analytics')"><i class="fas fa-chart-pie"></i> Analytics</div>
            <div class="nav-item" onclick="showView('trades')"><i class="fas fa-list"></i> Trades</div>
            <div class="nav-item" onclick="showView('agents')"><i class="fas fa-users-cog"></i> Agents</div>
            <div class="nav-item" onclick="showView('risk')"><i class="fas fa-shield-alt"></i> Risk Mgmt</div>
            <div class="nav-item" onclick="showView('settings')"><i class="fas fa-cog"></i> Settings</div>
        </div>
        <div style="padding: 20px; color: #6b7280; font-size: 12px;">
            v2.1.0 Stable
        </div>
    </div>

    <!-- Main App -->
    <div class="app-main">
        <!-- Top Header -->
        <div class="app-header">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <div class="status-text" id="statusText">System Stopped</div>
                <div style="margin-left: 10px; font-size: 12px; color: #9ca3af;" id="lastUpdate">Last update: -</div>
            </div>
            <div class="header-controls">
                <!-- Simulation Controls (shown when Simulate button is visible) -->
                <span style="color: var(--text-secondary); margin-right: 8px; font-size: 13px;">SPY & QQQ</span>
                <select id="simStartDateTime" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               width: 200px; display: inline-block;"
                        title="Select start date and time">
                    <option value="">Initializing...</option>
                </select>
                <span style="color: var(--text-secondary); margin-right: 8px;">to</span>
                <select id="simEndDateTime" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               width: 200px; display: inline-block;"
                        title="Select end date and time">
                    <option value="">Initializing...</option>
                </select>
                <select id="replaySpeed" 
                        style="padding: 8px 12px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: var(--card-bg); color: var(--text-primary); border-radius: 4px;
                               max-width: 120px;"
                        title="Replay speed multiplier">
                    <option value="1">1x (Real-time)</option>
                    <option value="10">10x</option>
                    <option value="50">50x</option>
                    <option value="100">100x</option>
                    <option value="600" selected>600x (Fast)</option>
                </select>
                <button onclick="startSimulation()" 
                        style="padding: 8px 16px; margin-right: 8px; border: 1px solid var(--border-color); 
                               background: #10b981; color: white; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;"
                        title="Start simulation with selected date/time range">
                    <i class="fas fa-play"></i> Start
                </button>
                <button class="ctrl-btn btn-start" id="btnStart" onclick="controlBot('start')" style="display: none;"><i class="fas fa-play"></i> Start Live</button>
                <button class="ctrl-btn btn-sim" id="btnSim" onclick="startSimulation()" style="background:#3b82f6; color:white; display: none;"><i class="fas fa-flask"></i> Simulate</button>
                <button class="ctrl-btn btn-pause" id="btnPause" onclick="controlBot('pause')"><i class="fas fa-pause"></i> Pause</button>
                <button class="ctrl-btn btn-stop" id="btnStop" onclick="controlBot('stop')"><i class="fas fa-stop"></i> Stop</button>
                <div style="width: 1px; background: #374151; margin: 0 8px;"></div>
                <button class="ctrl-btn btn-kill" id="btnKill" onclick="controlBot('kill')"><i class="fas fa-skull"></i> Kill Switch</button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            
            <!-- DASHBOARD VIEW (Webull Style) -->
            <div id="dashboard-view" class="view-section active">
                <!-- Webull Sidebar (Account Details) -->
                <div class="wb-sidebar">
                    <div style="margin-bottom: 30px;">
                        <div class="wb-title">TOTAL ACCOUNT VALUE</div>
                        <div class="wb-value"><span id="wbTotalValue">$100,000.00</span> <span class="wb-badge">LIVE</span></div>
                    </div>
                    
                    <div style="height: 150px; margin-bottom: 30px;">
                        <canvas id="wbMiniChart"></canvas>
                    </div>

                    <div style="flex: 1;">
                        <div class="wb-title" style="margin-bottom: 15px;">DETAILS</div>
                        <div class="wb-metric-row"><span>Day's P&L</span> <span id="wbDayPnL" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Open P&L</span> <span id="wbOpenPnL" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Cash Balance</span> <span id="wbCash" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Buying Power</span> <span id="wbBP" class="wb-metric-val">$0.00</span></div>
                        <div class="wb-metric-row"><span>Options BP</span> <span id="wbOptBP" class="wb-metric-val">$0.00</span></div>
                    </div>

                    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--wb-border);">
                        <div class="wb-title">RISK LEVEL</div>
                        <div style="height: 100px; display: flex; align-items: center; justify-content: center;">
                            <canvas id="wbRiskGauge"></canvas>
                        </div>
                        <div style="text-align: center; font-weight: 700; color: var(--wb-text-primary);" id="wbRiskLabel">SAFE</div>
                    </div>
                </div>

                <!-- Webull Main Content -->
                <div class="wb-main">
                    <div class="wb-grid-top">
                        <div class="wb-card">
                            <div class="wb-card-header">
                                <div class="wb-card-title">Performance</div>
                                <div>
                                    <span id="wbPerfPnL" style="font-size: 24px; font-weight: 600;">$0.00</span>
                                </div>
                            </div>
                            <!-- Performance Tabs -->
                            <div style="display: flex; gap: 8px; padding: 0 20px; border-bottom: 1px solid var(--border-color);">
                                <div class="perf-tab active" onclick="showPerfTab('chart', this)" style="padding: 8px 12px; cursor: pointer; border-bottom: 2px solid var(--nav-accent); color: var(--nav-accent); font-size: 13px; font-weight: 500;">
                                    Chart
                                </div>
                                <div class="perf-tab" onclick="showPerfTab('status', this)" style="padding: 8px 12px; cursor: pointer; border-bottom: 2px solid transparent; color: var(--text-secondary); font-size: 13px; font-weight: 500;">
                                    Status
                                </div>
                            </div>
                            <!-- Chart View -->
                            <div id="perf-chart-view" class="perf-tab-content" style="flex: 1; position: relative; display: block;">
                                <canvas id="wbMainChart"></canvas>
                            </div>
                            <!-- Status View -->
                            <div id="perf-status-view" class="perf-tab-content" style="flex: 1; padding: 20px; display: none; overflow-y: auto; max-height: 400px;">
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-signal" style="margin-right: 8px;"></i>Trade Setups
                                    </div>
                                    <div id="tradeSetups" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid #9ca3af;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <div style="font-weight: 600; color: var(--text-primary);">Waiting for data...</div>
                                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">No trade signals available</div>
                                                </div>
                                                <div style="padding: 4px 8px; background: #374151; border-radius: 4px; font-size: 11px; color: #9ca3af;">
                                                    PENDING
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Simulation & Trade Activity Status -->
                                <div style="margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center;">
                                            <i class="fas fa-chart-line" style="margin-right: 8px;"></i>Simulation Status
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button onclick="updateSimulationStatus(healthData, liveStatusData);" style="padding: 4px 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 11px;" title="Refresh Status">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <button onclick="stopSimulation();" id="stopSimBtn" style="padding: 4px 8px; background: #ef4444; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px; display: none;" title="Stop Simulation">
                                                <i class="fas fa-stop"></i> Stop
                                            </button>
                                        </div>
                                    </div>
                                    <div id="simulationStatus" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid #9ca3af;">
                                            <div style="font-size: 12px; color: var(--text-secondary);">Loading simulation status...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-robot" style="margin-right: 8px;"></i>Agent Activity
                                    </div>
                                    <div id="agentActivity" style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px;">
                                            <div style="font-size: 12px; color: var(--text-secondary);">Loading agent status...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-cog" style="margin-right: 8px;"></i>Background Activity
                                    </div>
                                    <div id="backgroundActivity" style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">System Status:</span>
                                            <span id="systemStatus" style="color: var(--text-primary); font-weight: 500;">Stopped</span>
                                        </div>
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Bars Processed:</span>
                                            <span id="barsProcessed" style="color: var(--text-primary); font-weight: 500;">0</span>
                                        </div>
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Current Regime:</span>
                                            <span id="currentRegime" style="color: var(--text-primary); font-weight: 500;">-</span>
                                        </div>
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between;">
                                            <span style="color: var(--text-secondary);">Last Bar:</span>
                                            <span id="lastBarTime" style="color: var(--text-primary); font-weight: 500; font-size: 11px;">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                                        <i class="fas fa-history" style="margin-right: 8px;"></i>Recent Activity
                                    </div>
                                    <div id="recentActivity" style="display: flex; flex-direction: column; gap: 6px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                                        <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; color: var(--text-secondary);">
                                            No recent activity
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="wb-card">
                            <div class="wb-card-header">
                                <div class="wb-card-title">Components</div>
                            </div>
                            <div style="display: flex; flex-direction: column; justify-content: space-around; height: 100%;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px;"><canvas id="wbWinChart"></canvas></div>
                                    <div><div class="wb-title">Win Rate</div><div class="wb-metric-val" id="wbWinVal">0%</div></div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px;"><canvas id="wbRegimeChart"></canvas></div>
                                    <div><div class="wb-title">Regime Confidence</div><div class="wb-metric-val" id="wbRegimeVal">0%</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="wb-card" style="flex: 1; min-height: 300px;">
                        <div class="wb-card-header">
                            <div class="wb-card-title">Positions & Recent Trades</div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="wb-table" id="wbPositionsTable">
                                <thead>
                                    <tr><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>Comm</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" style="text-align: center; padding: 20px; color: #9ca3af;">No recent trades</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="analytics-view" class="view-section simple-view-container">
                <div class="section-header"><i class="fas fa-chart-pie"></i> Analytics</div>
                
                <!-- Sub Tabs -->
                <div class="sub-tabs">
                    <div class="sub-tab active" onclick="showAnalyticsTab('perf', this)">Performance</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('regime', this)">Regime Analysis</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('vol', this)">Volatility</div>
                    <div class="sub-tab" onclick="showAnalyticsTab('options', this)">Options Dashboard</div>
                </div>

                <!-- Tab Content: Performance -->
                <div id="ana-perf" class="ana-tab-content" style="display:block;">
                    <div class="grid-2-col">
                        <div class="data-card">
                            <div class="card-header">Performance Metrics</div>
                            <div class="card-body" style="position:relative;">
                                <div style="text-align:center; color:var(--text-secondary);">
                                    <div style="margin-bottom:10px;">Loading...</div>
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="card-header">TradingView Chart</div>
                            <div class="card-body" style="padding: 0; height: 400px;">
                                <div id="tradingview-widget" style="width: 100%; height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Regime (Placeholder) -->
                <div id="ana-regime" class="ana-tab-content" style="display:none;">
                    <div class="data-card">
                        <div class="card-header">Regime Distribution</div>
                        <div class="card-body"><canvas id="regimeDistChart"></canvas></div>
                    </div>
                </div>
                
                 <!-- Tab Content: Volatility (Placeholder) -->
                <div id="ana-vol" class="ana-tab-content" style="display:none;">
                    <div class="data-card">
                        <div class="card-header">Volatility Analysis</div>
                        <div class="card-body">No data available</div>
                    </div>
                </div>
                
                <!-- Tab Content: Options Dashboard -->
                <div id="ana-options" class="ana-tab-content" style="display:none;">
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Options Trading Analytics</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">
                            Visualize options-specific performance metrics, including equity curves, drawdowns, and P&L by symbol.
                        </p>
                    </div>
                    
                    <!-- Options Equity Curve & Drawdown (Top Row) -->
                    <div class="grid-2-col" style="margin-bottom: 20px;">
                        <div class="data-card">
                            <div class="card-header">Options Equity Curve</div>
                            <div class="card-body" style="padding: 15px;">
                                <img id="optionsEquityCurveImg" src="" alt="Options Equity Curve" 
                                     style="width: 100%; height: auto; max-height: 400px; border-radius: 4px;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; text-align: center; color: var(--text-secondary); padding: 40px;">
                                    <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                                    <div>No options trades yet</div>
                                </div>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="card-header">Options Drawdown</div>
                            <div class="card-body" style="padding: 15px;">
                                <img id="optionsDrawdownImg" src="" alt="Options Drawdown" 
                                     style="width: 100%; height: auto; max-height: 400px; border-radius: 4px;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; text-align: center; color: var(--text-secondary); padding: 40px;">
                                    <i class="fas fa-chart-area" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                                    <div>No options trades yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options P&L by Symbol & Comparison (Bottom Row) -->
                    <div class="grid-2-col" style="margin-bottom: 20px;">
                        <div class="data-card">
                            <div class="card-header">Options P&L by Symbol</div>
                            <div class="card-body" style="padding: 15px;">
                                <img id="optionsPnlBySymbolImg" src="" alt="Options P&L by Symbol" 
                                     style="width: 100%; height: auto; max-height: 400px; border-radius: 4px;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; text-align: center; color: var(--text-secondary); padding: 40px;">
                                    <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                                    <div>No options trades yet</div>
                                </div>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="card-header">Options vs Stock Equity</div>
                            <div class="card-body" style="padding: 15px;">
                                <img id="optionsVsStockImg" src="" alt="Options vs Stock Comparison" 
                                     style="width: 100%; height: auto; max-height: 400px; border-radius: 4px;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none; text-align: center; color: var(--text-secondary); padding: 40px;">
                                    <i class="fas fa-balance-scale" style="font-size: 48px; margin-bottom: 10px; opacity: 0.3;"></i>
                                    <div>Insufficient data for comparison</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Multi-Leg Positions & Trade History -->
                    <div class="grid-2-col">
                        <div class="data-card">
                            <div class="card-header">Multi-Leg Open Positions</div>
                            <div class="card-body" style="padding: 15px;">
                                <div style="overflow-x: auto;">
                                    <table class="wb-table" id="multiLegPositionsTable" style="width: 100%; font-size: 12px;">
                                        <thead>
                                            <tr>
                                                <th>Strategy</th>
                                                <th>Symbol</th>
                                                <th>Call Strike</th>
                                                <th>Put Strike</th>
                                                <th>Credit/Debit</th>
                                                <th>P&L</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="data-card">
                            <div class="card-header">Multi-Leg Trade History</div>
                            <div class="card-body" style="padding: 15px;">
                                <div style="overflow-x: auto;">
                                    <table class="wb-table" id="multiLegTradesTable" style="width: 100%; font-size: 12px;">
                                        <thead>
                                            <tr>
                                                <th>Strategy</th>
                                                <th>Entry</th>
                                                <th>Exit</th>
                                                <th>Total P&L</th>
                                                <th>Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRADES VIEW -->
            <div id="trades-view" class="view-section simple-view-container">
                <div class="section-header">Trade History</div>
                <div class="data-card">
                    <table class="wb-table" id="fullTradesTable">
                        <thead>
                            <tr><th>ID</th><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>PnL</th><th>Reason</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- AGENTS VIEW -->
            <div id="agents-view" class="view-section simple-view-container">
                <div class="section-header">Active Agents</div>
                <div class="wb-grid-mid" id="agentsGrid">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- RISK VIEW -->
            <div id="risk-view" class="view-section simple-view-container">
                <div class="section-header">Risk Management</div>
                <div class="data-card" style="padding: 20px;">
                    <div id="riskJson">Loading...</div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="settings-view" class="view-section simple-view-container">
                <div class="section-header">Settings</div>
                
                <!-- Logging Configuration -->
                <div class="data-card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <i class="fas fa-bug" style="margin-right: 8px;"></i>Debug Logging
                    </div>
                    <div class="card-body" style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">
                                Log Level
                            </label>
                            <select id="logLevelSelect" style="width: 200px; padding: 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                                <option value="DEBUG">DEBUG (Most Verbose)</option>
                                <option value="INFO" selected>INFO (Default)</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL (Least Verbose)</option>
                            </select>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                Controls the verbosity of logging. DEBUG captures all details for troubleshooting.
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="enableDebugCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 500; color: var(--text-primary);">Enable Debug Mode</span>
                            </label>
                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; margin-left: 26px;">
                                Enables detailed debug logging for troubleshooting. May impact performance.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="saveLoggingSettings()" style="padding: 10px 20px; background: var(--nav-accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button onclick="refreshLogs()" style="padding: 10px 20px; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-sync-alt"></i> Refresh Logs
                            </button>
                            <button onclick="downloadLogs()" style="padding: 10px 20px; background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-download"></i> Download Logs
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Log Viewer -->
                <div class="data-card">
                    <div class="card-header">
                        <i class="fas fa-file-alt" style="margin-right: 8px;"></i>Recent Logs
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <select id="logLevelFilter" style="padding: 4px 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                                <option value="">All Levels</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL</option>
                            </select>
                            <input type="number" id="logLimit" value="100" min="10" max="1000" step="10" style="width: 80px; padding: 4px 8px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-size: 12px;">
                            <span style="font-size: 12px; color: var(--text-secondary);">entries</span>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div id="logViewer" style="height: 500px; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; font-size: 12px; background: #0a0a0a; color: #00ff00; line-height: 1.6;">
                            <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                                Loading logs...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="toast" class="toast">Notification</div>

    <script>
        // CRITICAL: This MUST execute - if you don't see this log, script isn't running
        try {
            console.log('âœ… Dashboard JavaScript is loading...');
            console.log('âœ… Script tag executed at:', new Date().toISOString());
            console.log('âœ… Window object:', typeof window);
            console.log('âœ… Document ready state:', document.readyState);
        } catch(e) {
            console.error('âŒ ERROR in initial script:', e);
        }
        
        const API_BASE = window.location.origin;
        let charts = {}; // Store chart instances

        function showAnalyticsTab(tabId, el) {
            // Hide all tabs
            document.querySelectorAll('.ana-tab-content').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            
            // Show selected
            document.getElementById(`ana-${tabId}`).style.display = 'block';
            el.classList.add('active');
            
            // Load data for the selected tab
            if (tabId === 'perf') {
                updatePerformanceAnalytics();
            } else if (tabId === 'regime') {
                updateRegimeAnalytics();
            } else if (tabId === 'vol') {
                updateVolatilityAnalytics();
            } else if (tabId === 'options') {
                updateOptionsAnalytics();
                updateMultiLegPositions();
                updateMultiLegTrades();
            }
        }
        
        // --- Analytics Data Cache ---
        let analyticsCache = {
            stats: null,
            regime: null,
            liveStatus: null,
            health: null,
            lastFetch: 0,
            cacheDuration: 2000 // 2 seconds
        };
        
        async function getCachedData(endpoint, cacheKey) {
            const now = Date.now();
            if (analyticsCache[cacheKey] && (now - analyticsCache.lastFetch) < analyticsCache.cacheDuration) {
                return analyticsCache[cacheKey];
            }
            const data = await fetch(`${API_BASE}${endpoint}`).then(r => r.json()).catch(() => null);
            if (data) {
                analyticsCache[cacheKey] = data;
                analyticsCache.lastFetch = now;
            }
            return data;
        }
        
        // --- Analytics Data Updates ---
        async function updatePerformanceAnalytics() {
            try {
                const [stats, health, liveStatus] = await Promise.all([
                    getCachedData('/stats', 'stats'),
                    getCachedData('/health', 'health'),
                    getCachedData('/live/status', 'liveStatus')
                ]);
                
                const perfDiv = document.querySelector('#ana-perf .data-card .card-body');
                if (!perfDiv) return;
                
                if (!stats) {
                    perfDiv.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No performance data available. Start trading to see metrics.</div>';
                    return;
                }
                
                const totalReturn = stats.total_return_pct || 0;
                const sharpe = stats.sharpe_ratio || 0;
                const maxDrawdown = stats.max_drawdown_pct || 0;
                const winRate = stats.win_rate || 0;
                const totalTrades = stats.total_trades || 0;
                
                // Get equity curve for sparkline
                let equitySparkline = '';
                try {
                    const equityData = await fetch(`${API_BASE}/visualizations/equity-curve-data`).then(r => r.json()).catch(() => null);
                    if (equityData && equityData.equity_curve && equityData.equity_curve.length > 0) {
                        const curve = equityData.equity_curve;
                        const initial = equityData.initial_capital || 100000;
                        const current = curve[curve.length - 1] || initial;
                        const change = ((current - initial) / initial) * 100;
                        
                        // Generate simple ASCII sparkline
                        const maxVal = Math.max(...curve);
                        const minVal = Math.min(...curve);
                        const range = maxVal - minVal || 1;
                        const sparkline = curve.slice(-20).map(v => {
                            const normalized = ((v - minVal) / range) * 4;
                            return Math.round(normalized);
                        });
                        const sparklineChars = sparkline.map(h => {
                            if (h === 0) return 'â–';
                            if (h === 1) return 'â–‚';
                            if (h === 2) return 'â–ƒ';
                            if (h === 3) return 'â–…';
                            return 'â–‡';
                        }).join('');
                        
                        equitySparkline = `
                            <div style="margin-top: 12px; padding: 12px; background: #111827; border-radius: 6px; border-left: 3px solid ${change >= 0 ? '#10b981' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary);">Equity</div>
                                        <div style="font-size: 18px; font-weight: 700; color: ${change >= 0 ? '#10b981' : '#ef4444'};">
                                            $${current.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                            <span style="font-size: 12px; margin-left: 4px;">(${change >= 0 ? '+' : ''}${change.toFixed(2)}%)</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="font-family: monospace; font-size: 14px; color: ${change >= 0 ? '#10b981' : '#ef4444'}; letter-spacing: 2px;">
                                    ${sparklineChars}
                                </div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.debug('Could not load equity curve for sparkline:', e);
                }
                
                // Get simulation start time
                let startTimeInfo = '';
                if (liveStatus && liveStatus.start_time) {
                    const startDate = new Date(liveStatus.start_time);
                    const startTimeFormatted = startDate.toLocaleString('en-US', {
                        timeZone: 'America/New_York',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    }) + ' EST';
                    const barsProcessed = liveStatus.bar_count || 0;
                    startTimeInfo = `
                        <div style="margin-top: 12px; padding: 8px; background: #1f2937; border-radius: 4px; font-size: 11px; color: var(--text-secondary);">
                            <i class="fas fa-clock" style="margin-right: 4px;"></i>
                            Since ${liveStatus.mode === 'offline' ? 'Simulation' : 'Live Trading'} Start: ${startTimeFormatted} | Bars: ${barsProcessed}
                        </div>
                    `;
                }
                
                perfDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Return</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${totalReturn >= 0 ? '#10b981' : '#ef4444'};">${totalReturn.toFixed(2)}%</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Sharpe Ratio</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${sharpe.toFixed(2)}</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Max Drawdown</div>
                            <div style="font-size: 24px; font-weight: 700; color: ${maxDrawdown <= 0 ? '#10b981' : '#ef4444'};">${maxDrawdown.toFixed(2)}%</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Win Rate</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(winRate * 100).toFixed(1)}%</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Total Trades</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${totalTrades}</div>
                        </div>
                        <div style="padding: 12px; background: #1f2937; border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Status</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${health?.is_running ? '#10b981' : '#ef4444'};">${health?.is_running ? 'Running' : 'Stopped'}</div>
                        </div>
                    </div>
                    ${equitySparkline}
                    ${startTimeInfo}
                `;
            } catch (e) {
                console.error('Error updating performance analytics:', e);
            }
        }
        
        async function updateRegimeAnalytics() {
            try {
                const [regime, health] = await Promise.all([
                    getCachedData('/regime', 'regime'),
                    getCachedData('/health', 'health')
                ]);
                
                const regimeDiv = document.querySelector('#ana-regime .card-body');
                if (!regimeDiv) return;
                
                if (!regime || !regime.is_valid) {
                    regimeDiv.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No regime data available. Need 30+ bars for analysis.</div>';
                    return;
                }
                
                const regimeType = regime.regime_type || 'N/A';
                const trend = regime.trend_direction || 'N/A';
                const volatility = regime.volatility_level || 'N/A';
                const bias = regime.bias || 'N/A';
                const confidence = (regime.confidence || 0) * 100;
                
                // Regime badge colors
                const regimeColors = {
                    'TREND': '#3b82f6',
                    'COMPRESSION': '#9ca3af',
                    'EXPANSION': '#f59e0b',
                    'MEAN_REVERSION': '#8b5cf6',
                    'NEUTRAL': '#6b7280'
                };
                
                const trendColors = {
                    'UP': '#10b981',
                    'DOWN': '#ef4444',
                    'SIDEWAYS': '#9ca3af'
                };
                
                const volColors = {
                    'HIGH': '#ef4444',
                    'MEDIUM': '#f59e0b',
                    'LOW': '#10b981'
                };
                
                const biasColors = {
                    'BULLISH': '#10b981',
                    'BEARISH': '#ef4444',
                    'NEUTRAL': '#9ca3af'
                };
                
                regimeDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${regimeColors[regimeType] || '#8b5cf6'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Current Regime</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${regimeColors[regimeType] || '#8b5cf6'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${regimeColors[regimeType] || '#8b5cf6'}; text-transform: uppercase;">${regimeType}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${trendColors[trend] || '#3b82f6'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Trend Direction</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${trendColors[trend] || '#3b82f6'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${trendColors[trend] || '#3b82f6'}; text-transform: uppercase;">${trend}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${volColors[volatility] || '#f59e0b'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Volatility Level</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${volColors[volatility] || '#f59e0b'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${volColors[volatility] || '#f59e0b'}; text-transform: uppercase;">VOL ${volatility}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${biasColors[bias] || '#9ca3af'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Bias</div>
                            <div style="display: inline-block; padding: 4px 8px; background: ${biasColors[bias] || '#9ca3af'}20; border-radius: 4px; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 700; color: ${biasColors[bias] || '#9ca3af'}; text-transform: capitalize;">${bias}</span>
                            </div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #10b981;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Confidence</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${confidence >= 70 ? '#10b981' : confidence >= 40 ? '#f59e0b' : '#ef4444'};">${confidence.toFixed(1)}%</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${regime.is_valid ? '#10b981' : '#ef4444'};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Status</div>
                            <div style="font-size: 14px; font-weight: 600; color: ${regime.is_valid ? '#10b981' : '#ef4444'};">${regime.is_valid ? 'Valid' : 'Invalid'}</div>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error updating regime analytics:', e);
            }
        }
        
        async function updateVolatilityAnalytics() {
            try {
                const [regime, stats, liveStatus] = await Promise.all([
                    getCachedData('/regime', 'regime'),
                    getCachedData('/stats', 'stats'),
                    getCachedData('/live/status', 'liveStatus')
                ]);
                
                const volDiv = document.querySelector('#ana-vol .card-body');
                if (!volDiv) return;
                
                if (!regime || !regime.is_valid) {
                    volDiv.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">No volatility data available. Need 30+ bars for analysis.</div>';
                    return;
                }
                
                const volatility = regime.volatility_level || 'N/A';
                const atrPct = regime.metrics?.atr_pct || 0;
                const barCount = liveStatus?.bar_count || 0;
                
                // Determine volatility status
                let volStatus = 'NORMAL';
                let volColor = '#f59e0b';
                if (volatility === 'HIGH') {
                    volStatus = 'HIGH VOLATILITY';
                    volColor = '#ef4444';
                } else if (volatility === 'LOW') {
                    volStatus = 'LOW VOLATILITY';
                    volColor = '#10b981';
                }
                
                volDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid ${volColor};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Volatility Level</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${volColor}; text-transform: uppercase;">${volatility}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${volStatus}</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">ATR %</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${(atrPct * 100).toFixed(2)}%</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Average True Range</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Bars Analyzed</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text-primary);">${barCount}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${barCount >= 30 ? 'Sufficient' : 'Insufficient'} for analysis</div>
                        </div>
                        <div style="padding: 16px; background: #1f2937; border-radius: 6px; border-left: 3px solid #10b981;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Trading Recommendation</div>
                            <div style="font-size: 16px; font-weight: 700; color: ${volatility === 'HIGH' ? '#ef4444' : volatility === 'LOW' ? '#9ca3af' : '#10b981'};">
                                ${volatility === 'HIGH' ? 'CAUTION - High Risk' : volatility === 'LOW' ? 'STABLE - Low Risk' : 'NORMAL - Moderate Risk'}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: #1f2937; border-radius: 6px;">
                        <div style="font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Volatility Interpretation</div>
                        <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                            ${volatility === 'HIGH' ? 
                                'High volatility indicates increased market uncertainty. Consider smaller position sizes and tighter stop losses.' :
                                volatility === 'LOW' ?
                                'Low volatility suggests stable market conditions. Normal position sizing and stop losses are appropriate.' :
                                'Normal volatility indicates standard market conditions. Standard trading parameters apply.'}
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error('Error updating volatility analytics:', e);
            }
        }
        
        async function updateMultiLegPositions() {
            try {
                const res = await fetch(`${API_BASE}/options/positions`);
                const data = await res.json();
                
                const table = document.getElementById('multiLegPositionsTable');
                if (!table) return;
                
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                
                const positions = data.multi_leg_positions || [];
                
                if (positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-secondary);">No multi-leg positions</td></tr>';
                    return;
                }
                
                positions.forEach(pos => {
                    const row = document.createElement('tr');
                    const strategy = pos.trade_type === 'straddle' ? 'Theta Harvester' : 'Gamma Scalper';
                    const direction = pos.direction === 'short' ? 'SELL' : 'BUY';
                    const pnlColor = pos.combined_unrealized_pnl >= 0 ? '#10b981' : '#ef4444';
                    const status = pos.both_legs_filled ? 
                        (pos.call_fill_status === 'filled' && pos.put_fill_status === 'filled' ? 'âœ… Filled' : 'âš ï¸ Partial') :
                        'â³ Pending';
                    
                    row.innerHTML = `
                        <td>${strategy}</td>
                        <td>${pos.symbol}</td>
                        <td>$${pos.call_strike.toFixed(2)}</td>
                        <td>$${pos.put_strike.toFixed(2)}</td>
                        <td>${direction === 'SELL' ? '+' : '-'}$${Math.abs(pos.net_premium).toFixed(2)}</td>
                        <td style="color: ${pnlColor}">$${pos.combined_unrealized_pnl.toFixed(2)}</td>
                        <td>${status}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                console.error('Error updating multi-leg positions:', e);
            }
        }
        
        async function updateMultiLegTrades() {
            try {
                const res = await fetch(`${API_BASE}/trades/options/multi-leg?limit=20`);
                const data = await res.json();
                
                const table = document.getElementById('multiLegTradesTable');
                if (!table) return;
                
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                
                const trades = data.trades || [];
                
                if (trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-secondary);">No multi-leg trades</td></tr>';
                    return;
                }
                
                trades.forEach(trade => {
                    const row = document.createElement('tr');
                    const strategy = trade.trade_type === 'straddle' ? 'Theta Harvester' : 'Gamma Scalper';
                    const entryTime = new Date(trade.entry_time).toLocaleString();
                    const exitTime = new Date(trade.exit_time).toLocaleString();
                    const pnlColor = trade.combined_pnl >= 0 ? '#10b981' : '#ef4444';
                    const duration = `${Math.round(trade.duration_minutes)}m`;
                    
                    row.innerHTML = `
                        <td>${strategy}</td>
                        <td>${entryTime}</td>
                        <td>${exitTime}</td>
                        <td style="color: ${pnlColor}">$${trade.combined_pnl.toFixed(2)} (${trade.combined_pnl_pct.toFixed(1)}%)</td>
                        <td>${duration}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                console.error('Error updating multi-leg trades:', e);
            }
        }
        
        async function updateOptionsAnalytics() {
            try {
                // Update all options visualization images with cache-busting
                const timestamp = Date.now();
                const baseUrl = `${API_BASE}/visualizations`;
                
                // Options Equity Curve
                const equityImg = document.getElementById('optionsEquityCurveImg');
                if (equityImg) {
                    equityImg.src = `${baseUrl}/options-equity-curve?t=${timestamp}`;
                    equityImg.style.display = 'block';
                    const nextDiv = equityImg.nextElementSibling;
                    if (nextDiv) nextDiv.style.display = 'none';
                }
                
                // Options Drawdown
                const drawdownImg = document.getElementById('optionsDrawdownImg');
                if (drawdownImg) {
                    drawdownImg.src = `${baseUrl}/options-drawdown?t=${timestamp}`;
                    drawdownImg.style.display = 'block';
                    const nextDiv = drawdownImg.nextElementSibling;
                    if (nextDiv) nextDiv.style.display = 'none';
                }
                
                // Options P&L by Symbol
                const pnlImg = document.getElementById('optionsPnlBySymbolImg');
                if (pnlImg) {
                    pnlImg.src = `${baseUrl}/options-pnl-by-symbol?t=${timestamp}`;
                    pnlImg.style.display = 'block';
                    const nextDiv = pnlImg.nextElementSibling;
                    if (nextDiv) nextDiv.style.display = 'none';
                }
                
                // Options vs Stock Comparison
                const vsStockImg = document.getElementById('optionsVsStockImg');
                if (vsStockImg) {
                    vsStockImg.src = `${baseUrl}/options-vs-stock?t=${timestamp}`;
                    vsStockImg.style.display = 'block';
                    const nextDiv = vsStockImg.nextElementSibling;
                    if (nextDiv) nextDiv.style.display = 'none';
                }
                
                // Update multi-leg positions and trades
                updateMultiLegPositions();
                updateMultiLegTrades();
                
            } catch (error) {
                console.error('Error updating options analytics:', error);
                // Show error placeholders
                const errorMsg = '<div style="text-align:center; color:var(--text-secondary); padding:20px;">Error loading options data.</div>';
                document.querySelectorAll('#ana-options .card-body').forEach(div => {
                    if (div.querySelector('img')) {
                        div.innerHTML = errorMsg;
                    }
                });
            }
        }

        function showPerfTab(tabId, el) {
            console.log('ðŸ”„ showPerfTab called with:', tabId);
            // Hide all performance tab contents
            document.querySelectorAll('.perf-tab-content').forEach(div => div.style.display = 'none');
            document.querySelectorAll('.perf-tab').forEach(t => {
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--text-secondary)';
            });
            
            // Show selected
            if (tabId === 'chart') {
                const chartView = document.getElementById('perf-chart-view');
                if (chartView) {
                    chartView.style.display = 'block';
                    console.log('âœ… Chart view shown');
                } else {
                    console.error('âŒ perf-chart-view element not found');
                }
            } else if (tabId === 'status') {
                const statusView = document.getElementById('perf-status-view');
                if (statusView) {
                    statusView.style.display = 'block';
                    console.log('âœ… Status view shown, calling updateStatusView()');
                    updateStatusView(); // Refresh status when switching to status tab
                } else {
                    console.error('âŒ perf-status-view element not found');
                }
            }
            
            // Update tab styling
            if (el) {
                el.style.borderBottomColor = 'var(--nav-accent)';
                el.style.color = 'var(--nav-accent)';
            }
        }

        async function updateStatusView() {
            try {
                // Fetch all status data with fallbacks
                const [health, regime, agents, liveStatus] = await Promise.all([
                    fetch(`${API_BASE}/health`).then(r => r.json()).catch(() => ({ is_running: false, is_paused: false })),
                    fetch(`${API_BASE}/regime`).then(r => r.json()).catch(() => ({ regime_type: 'COMPRESSION', confidence: 0.0 })),
                    fetch(`${API_BASE}/agents`).then(r => r.json()).catch(() => ({})),
                    fetch(`${API_BASE}/live/status`).then(r => r.json()).catch(() => ({ is_running: false, bar_count: 0 }))
                ]);

                // Update Background Activity - prioritize liveStatus over health
                if (liveStatus) {
                    document.getElementById('barsProcessed').textContent = liveStatus.bar_count || 0;
                    if (liveStatus.mode) {
                        const statusText = `${liveStatus.mode === 'offline' ? 'Simulating' : 'Live'} - ${liveStatus.is_running ? 'Running' : 'Stopped'}`;
                        document.getElementById('systemStatus').textContent = statusText;
                        document.getElementById('systemStatus').style.color = liveStatus.is_running 
                            ? (liveStatus.is_paused ? '#f59e0b' : '#10b981') 
                            : '#ef4444';
                    } else {
                        // Fallback to health status if liveStatus doesn't have mode
                        if (health) {
                            document.getElementById('systemStatus').textContent = health.is_running 
                                ? (health.is_paused ? 'Paused' : 'Running') 
                                : 'Stopped';
                            document.getElementById('systemStatus').style.color = health.is_running 
                                ? (health.is_paused ? '#f59e0b' : '#10b981') 
                                : '#ef4444';
                        }
                    }
                } else if (health) {
                    // Fallback if no liveStatus
                    document.getElementById('systemStatus').textContent = health.is_running 
                        ? (health.is_paused ? 'Paused' : 'Running') 
                        : 'Stopped';
                    document.getElementById('systemStatus').style.color = health.is_running 
                        ? (health.is_paused ? '#f59e0b' : '#10b981') 
                        : '#ef4444';
                }

                // Update Current Regime
                if (regime) {
                    const regimeText = `${regime.regime_type} (${regime.trend_direction})`;
                    document.getElementById('currentRegime').textContent = regimeText;
                    document.getElementById('currentRegime').style.color = regime.confidence > 0.7 ? '#10b981' : '#f59e0b';
                }
                
                // Update Last Bar Timestamp - Show actual bar timestamp (same as Evaluating time)
                const currentTimeForDisplay = new Date();
                let timeToShow = null;
                
                // Show actual last_bar_time if available (same logic as Evaluating time)
                if (liveStatus && liveStatus.last_bar_time) {
                    // Show the actual bar timestamp (this matches the Evaluating time)
                    const lastBarDate = new Date(liveStatus.last_bar_time);
                    timeToShow = lastBarDate.toLocaleString('en-US', {
                        timeZone: 'America/New_York',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' EST';
                    
                    // Add indicators for historical simulation or stuck bars
                    if (liveStatus.is_running) {
                        const timeDiff = (currentTimeForDisplay - lastBarDate) / 1000 / 60; // minutes ago
                        // If bar is more than 5 minutes old and bot is running, it's likely historical simulation
                        if (timeDiff > 5) {
                            timeToShow += ' (Historical)';
                        }
                    }
                } else if (liveStatus && liveStatus.is_running) {
                    // Bot is running but no bar timestamp yet - show current time with note
                    timeToShow = currentTimeForDisplay.toLocaleString('en-US', {
                        timeZone: 'America/New_York',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' EST (Waiting for bars)';
                } else if (health && health.last_update) {
                    const lastUpdate = new Date(health.last_update);
                    timeToShow = lastUpdate.toLocaleString('en-US', {
                        timeZone: 'America/New_York',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' EST';
                } else {
                    // Fallback to current time
                    timeToShow = currentTimeForDisplay.toLocaleString('en-US', {
                        timeZone: 'America/New_York',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    }) + ' EST';
                }
                
                if (timeToShow) {
                    document.getElementById('lastBarTime').textContent = timeToShow;
                }

                // Update Trade Setups
                updateTradeSetups(regime, agents, liveStatus);

                // Update Simulation Status
                updateSimulationStatus(health, liveStatus);

                // Update Agent Activity
                updateAgentActivity(agents);

                // Update Recent Activity
                updateRecentActivity(health, liveStatus);

            } catch (e) {
                console.error('Error updating status view:', e);
                // Show error message in status view
                const setupsDiv = document.getElementById('tradeSetups');
                if (setupsDiv) {
                    setupsDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid #ef4444;">
                            <div style="font-weight: 600; color: #ef4444;">Error loading status</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${e.message}</div>
                        </div>
                    `;
                }
            }
        }

        function updateTradeSetups(regime, agents, liveStatus) {
            const setupsDiv = document.getElementById('tradeSetups');
            setupsDiv.innerHTML = '';

            // Get current bar count
            const barCount = liveStatus?.bar_count || 0;
            const requiredBars = 30;
            const barsNeeded = Math.max(0, requiredBars - barCount);

            // Get current evaluation time/bar (CST timezone)
            // If last_bar_time is old (>5 min) and bot is running, show current time
            const currentTime = new Date();
            let currentBarTime = liveStatus?.last_bar_time || regime?.timestamp || null;
            
            if (currentBarTime && liveStatus?.is_running) {
                const lastBarDate = new Date(currentBarTime);
                const timeDiff = (currentTime - lastBarDate) / 1000 / 60; // minutes ago
                // If last bar is more than 5 minutes old, show current time
                if (timeDiff > 5) {
                    currentBarTime = currentTime.toISOString(); // Use current time
                }
            }
            
            const currentBarTimeFormatted = currentBarTime 
                ? new Date(currentBarTime).toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                  }) + ' CST'
                : currentTime.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                  }) + ' EST';
            
            // If we have enough bars, treat regime as valid even if is_valid is false
            // (backend should force-validate, but UI can also handle this)
            const hasEnoughBars = barCount >= requiredBars;
            const regimeValid = regime && (regime.is_valid || hasEnoughBars);
            
            if (!regime || !regimeValid) {
                let message = 'Insufficient bars for analysis';
                let suggestion = '';
                let statusColor = '#9ca3af'; // Gray for NO DATA
                let statusLabel = 'NO DATA';
                let progressColor = '#9ca3af';
                let etaText = '';
                let diagnosticInfo = '';
                
                if (barCount >= requiredBars) {
                    // Have enough bars but regime is invalid - show diagnostic
                    message = `Analysis in progress (${barCount} bars available)`;
                    suggestion = regime ? 'Regime detected but validation pending...' : 'Waiting for regime classification';
                    statusColor = '#f59e0b'; // Orange - processing
                    statusLabel = 'PROCESSING';
                    progressColor = '#f59e0b';
                    diagnosticInfo = regime 
                        ? `<div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;">
                            <div style="font-size: 10px; color: #fca5a5; margin-bottom: 4px;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
                                <strong>Diagnostic:</strong> ${barCount} bars but regime invalid
                            </div>
                            <div style="font-size: 10px; color: #fca5a5;">
                                Regime: ${regime.regime_type || 'N/A'}, Confidence: ${((regime.confidence || 0) * 100).toFixed(1)}%, Valid: ${regime.is_valid ? 'Yes' : 'No'}
                            </div>
                        </div>`
                        : '<div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;"><div style="font-size: 10px; color: #fca5a5;">No regime signal received from backend</div></div>';
                } else if (barCount > 0) {
                    message = `Need ${barsNeeded} more bars (${barCount}/${requiredBars})`;
                    suggestion = 'Continue simulation to collect more bars';
                    statusColor = '#f59e0b'; // Orange for COLLECTING
                    statusLabel = 'COLLECTING';
                    progressColor = '#f59e0b';
                    
                    // Calculate ETA if simulation is running
                    if (liveStatus && liveStatus.is_running && liveStatus.duration_seconds) {
                        const barsPerSecond = barCount / liveStatus.duration_seconds;
                        if (barsPerSecond > 0) {
                            const etaSeconds = Math.ceil(barsNeeded / barsPerSecond);
                            if (etaSeconds < 60) {
                                etaText = `Ready in ~${etaSeconds} seconds`;
                            } else {
                                const etaMinutes = Math.ceil(etaSeconds / 60);
                                etaText = `Ready in ~${etaMinutes} minute${etaMinutes > 1 ? 's' : ''}`;
                            }
                        }
                    } else if (liveStatus && liveStatus.replay_speed) {
                        // Estimate based on replay speed (600x = ~50-80 bars/sec)
                        const estimatedBarsPerSecond = Math.min(80, liveStatus.replay_speed / 7.5);
                        const etaSeconds = Math.ceil(barsNeeded / estimatedBarsPerSecond);
                        if (etaSeconds < 60) {
                            etaText = `Ready in ~${etaSeconds} seconds at ${liveStatus.replay_speed}x speed`;
                        } else {
                            const etaMinutes = Math.ceil(etaSeconds / 60);
                            etaText = `Ready in ~${etaMinutes} minute${etaMinutes > 1 ? 's' : ''} at ${liveStatus.replay_speed}x speed`;
                        }
                    }
                } else {
                    message = 'No bars collected yet';
                    suggestion = 'Start a simulation or collect historical data';
                }
                
                // Show diagnostic info if we have bars but regime is invalid
                if (barCount >= requiredBars && (!regime || !regime.is_valid)) {
                    diagnosticInfo = `
                        <div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;">
                            <div style="font-size: 10px; color: #fca5a5; margin-bottom: 4px;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
                                <strong>Diagnostic:</strong> ${barCount} bars available but regime invalid
                            </div>
                            <div style="font-size: 10px; color: #fca5a5;">
                                ${regime ? `Regime: ${regime.regime_type || 'N/A'}, Confidence: ${((regime.confidence || 0) * 100).toFixed(1)}%` : 'No regime signal received'}
                            </div>
                        </div>
                    `;
                }
                
                setupsDiv.innerHTML = `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">Waiting for Data</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${message}</div>
                            </div>
                            <div style="padding: 4px 8px; background: ${statusColor}20; border-radius: 4px; font-size: 11px; color: ${statusColor}; font-weight: 600;">
                                ${statusLabel}
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: #1f2937; border-radius: 4px; font-size: 11px; color: var(--text-secondary);">
                            <div style="margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>Progress:</strong> ${barCount}/${requiredBars} bars</span>
                                ${etaText ? `<span style="color: ${statusColor}; font-weight: 600;">${etaText}</span>` : ''}
                            </div>
                            <div style="width: 100%; height: 4px; background: #374151; border-radius: 2px; overflow: hidden; margin: 4px 0;">
                                <div style="width: ${Math.min(100, (barCount / requiredBars) * 100)}%; height: 100%; background: ${progressColor}; transition: width 0.3s;"></div>
                            </div>
                            <div style="margin-top: 6px; padding: 6px; background: #111827; border-radius: 4px; border-left: 2px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: var(--text-secondary);"><i class="fas fa-clock" style="margin-right: 4px;"></i>Evaluating Bar:</span>
                                    <span style="color: var(--text-primary); font-weight: 600;">${currentBarTimeFormatted}</span>
                                </div>
                                ${liveStatus && liveStatus.bars_per_symbol ? `
                                <div style="margin-top: 4px; font-size: 10px; color: var(--text-secondary);">
                                    Bars: ${Object.entries(liveStatus.bars_per_symbol).map(([s, c]) => `${s}: ${c}`).join(', ')}
                                </div>
                                ${Object.values(liveStatus.bars_per_symbol || {}).some(c => c < 30) ? `
                                <div style="margin-top: 6px; padding: 6px; background: #7c2d12; border-radius: 4px; border-left: 2px solid #ef4444;">
                                    <div style="font-size: 10px; color: #fca5a5;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 4px;"></i>
                                        <strong>Warning:</strong> Bar count stuck. Check data feed connection (Alpaca/IBKR). Market shows SPY: 681, QQQ: 616 but bot has only ${Object.values(liveStatus.bars_per_symbol || {}).join('/')} bars.
                                    </div>
                                </div>
                                ` : ''}
                                ` : ''}
                            </div>
                            ${diagnosticInfo ? diagnosticInfo : ''}
                            </div>
                            <div style="margin-top: 6px; color: #9ca3af;">
                                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                                ${suggestion}
                            </div>
                            ${barCount === 0 ? `
                            <div style="margin-top: 8px;">
                                <button onclick="autoStartDataCollection()" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-play" style="margin-right: 4px;"></i>Collect Data & Analyze
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                return;
            }

            // If we reach here, we have a valid regime (or enough bars to treat it as valid)
            // Use regime even if is_valid is false but we have enough bars
            const effectiveRegime = regime || {};
            
            // Determine setup quality based on regime and agents
            const confidence = effectiveRegime.confidence || 0;
            const bias = effectiveRegime.bias || 'NEUTRAL';
            const regimeType = effectiveRegime.regime_type || 'COMPRESSION';
            
            let setupQuality = 'NEUTRAL';
            let setupColor = '#9ca3af';
            let setupLabel = 'WAIT';
            let setupReason = '';

            if (confidence > 0.7 && (bias === 'BULLISH' || bias === 'BEARISH')) {
                if (regimeType === 'TREND' || regimeType === 'EXPANSION') {
                    setupQuality = 'GOOD';
                    setupColor = '#10b981'; // Green for READY/GOOD
                    setupLabel = 'GOOD SETUP';
                    setupReason = `Strong ${bias.toLowerCase()} signal in ${regimeType.toLowerCase()} regime`;
                }
            } else if (confidence < 0.5 || regimeType === 'COMPRESSION') {
                setupQuality = 'BAD';
                setupColor = '#ef4444'; // Red for AVOID/BAD
                setupLabel = 'AVOID';
                setupReason = `Low confidence (${(confidence * 100).toFixed(0)}%) or choppy market`;
            } else {
                setupQuality = 'NEUTRAL';
                setupColor = '#f59e0b'; // Orange for CAUTION
                setupLabel = 'CAUTION';
                setupReason = `Moderate confidence (${(confidence * 100).toFixed(0)}%) - wait for better setup`;
            }
            
            // If we have valid regime, status is READY (green)
            const readyStatusColor = '#10b981';

            // Get current evaluation time (EST timezone)
            // For historical simulation, show the actual bar timestamp, not current time
            const evalCurrentTime = new Date();
            let evalTimeFormatted;
            
            // Check if we have a bar timestamp (from simulation or live trading)
            const evalBarTime = liveStatus?.last_bar_time || regime?.timestamp || null;
            
            if (evalBarTime) {
                // Show the actual bar timestamp (this is the real data being evaluated)
                const barDate = new Date(evalBarTime);
                evalTimeFormatted = barDate.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }) + ' EST';
                
                // For historical simulation, add indicator if bar is old
                if (liveStatus && liveStatus.is_running) {
                    const timeDiff = (evalCurrentTime - barDate) / 1000 / 60; // minutes ago
                    // If bar is more than 5 minutes old and bot is running, it's likely historical simulation
                    if (timeDiff > 5) {
                        evalTimeFormatted += ' (Historical)';
                    }
                }
            } else if (liveStatus && liveStatus.is_running) {
                // Bot is running but no bar timestamp yet - show current time with note
                evalTimeFormatted = evalCurrentTime.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }) + ' EST (Waiting for bars)';
            } else {
                // Bot not running - show current time
                evalTimeFormatted = evalCurrentTime.toLocaleString('en-US', {
                    timeZone: 'America/New_York',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }) + ' EST';
            }
            
            setupsDiv.innerHTML = `
                <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${setupColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${setupLabel}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${setupReason}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;">
                                Regime: ${regimeType} | Bias: ${bias} | Confidence: ${(confidence * 100).toFixed(0)}%
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                            <div style="padding: 4px 8px; background: ${readyStatusColor}20; border-radius: 4px; font-size: 11px; color: ${readyStatusColor}; font-weight: 600;">
                                READY
                            </div>
                            <div style="padding: 4px 8px; background: ${setupColor}20; border-radius: 4px; font-size: 11px; color: ${setupColor}; font-weight: 600;">
                                ${setupLabel}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 6px; background: #111827; border-radius: 4px; border-left: 2px solid ${setupColor};">
                        <div style="display: flex; justify-content: space-between; font-size: 10px;">
                            <span style="color: var(--text-secondary);"><i class="fas fa-clock" style="margin-right: 4px;"></i>Evaluating:</span>
                            <span style="color: var(--text-primary); font-weight: 600;">${evalTimeFormatted}</span>
                        </div>
                        <div style="margin-top: 4px; font-size: 10px; color: var(--text-secondary);">
                            Bar #${liveStatus?.bar_count || 'N/A'} | ${liveStatus?.bars_per_symbol ? Object.entries(liveStatus.bars_per_symbol).map(([s, c]) => `${s}: ${c}`).join(', ') : ''}
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 8px; background: #1e3a5f; border-radius: 4px; border-left: 2px solid #3b82f6;">
                        <div style="font-size: 11px; font-weight: 600; color: #93c5fd; margin-bottom: 6px;">
                            <i class="fas fa-info-circle" style="margin-right: 4px;"></i>Trade Setup Criteria:
                        </div>
                        <div style="font-size: 10px; color: #bfdbfe; line-height: 1.6;">
                            <div><strong>GOOD SETUP:</strong> Confidence â‰¥70%, Bias (BULLISH/BEARISH), Regime (TREND/EXPANSION)</div>
                            <div><strong>CAUTION:</strong> Confidence 40-70%, Moderate signals</div>
                            <div><strong>AVOID:</strong> Confidence &lt;40% or COMPRESSION regime</div>
                            <div style="margin-top: 4px; padding-top: 4px; border-top: 1px solid #3b82f6;">
                                <strong>Profit Target:</strong> 15% | <strong>Stop Loss:</strong> 10%
                            </div>
                            <div><strong>Min Confidence:</strong> 15% (lowered for active trading)</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Store throughput history for sparkline
        let throughputHistory = [];
        let lastBarCount = 0;
        let lastUpdateTime = Date.now();

        function updateSimulationStatus(health, liveStatus) {
            const statusDiv = document.getElementById('simulationStatus');
            if (!statusDiv) return;

            // Store for refresh button
            if (health) window.healthData = health;
            if (liveStatus) window.liveStatusData = liveStatus;

            // Determine simulation state
            const isRunning = liveStatus?.is_running || health?.is_running || false;
            const isPaused = liveStatus?.is_paused || health?.is_paused || false;
            const mode = liveStatus?.mode || 'offline';
            const barCount = liveStatus?.bar_count || 0;
            const barsPerSymbol = liveStatus?.bars_per_symbol || {};
            const stopReason = liveStatus?.stop_reason || null;
            const error = liveStatus?.error || null;

            // Calculate throughput (bars per second)
            const now = Date.now();
            const timeDiff = (now - lastUpdateTime) / 1000; // seconds
            if (timeDiff > 0 && barCount > lastBarCount) {
                const barsProcessed = barCount - lastBarCount;
                const throughput = Math.round(barsProcessed / timeDiff);
                throughputHistory.push(throughput);
                if (throughputHistory.length > 12) throughputHistory.shift();
            }
            lastBarCount = barCount;
            lastUpdateTime = now;

            // Show/hide stop button
            const stopBtn = document.getElementById('stopSimBtn');
            if (stopBtn) {
                stopBtn.style.display = isRunning ? 'block' : 'none';
            }

            // Determine status message and color
            let statusMessage = '';
            let statusColor = '#9ca3af'; // Default gray
            let statusIcon = 'fa-clock';
            let details = [];

            if (error) {
                statusMessage = 'Error: ' + error;
                statusColor = '#ef4444'; // Red
                statusIcon = 'fa-exclamation-triangle';
            } else if (isRunning) {
                if (isPaused) {
                    statusMessage = 'Simulation Paused';
                    statusColor = '#f59e0b'; // Orange
                    statusIcon = 'fa-pause';
                } else {
                    statusMessage = 'Still Evaluating...';
                    statusColor = '#3b82f6'; // Blue
                    statusIcon = 'fa-spinner fa-spin';
                }
                details.push(`Processing bars...`);
            } else if (stopReason) {
                if (stopReason === 'end_of_data' || stopReason === 'completed' || stopReason === 'end_time_reached') {
                    statusMessage = 'Simulation Completed';
                    statusColor = '#10b981'; // Green
                    statusIcon = 'fa-check-circle';
                    details.push(`Finished processing bars`);
                } else {
                    statusMessage = 'Simulation Stopped: ' + stopReason;
                    statusColor = '#f59e0b'; // Orange
                    statusIcon = 'fa-stop-circle';
                }
            } else {
                statusMessage = 'No Simulation Running';
                statusColor = '#9ca3af'; // Gray
                statusIcon = 'fa-stop-circle';
                details.push(`Click "Start" to begin simulation`);
            }

            // Add bar count details
            const totalBars = Object.values(barsPerSymbol).reduce((sum, count) => sum + (count || 0), 0);
            if (totalBars > 0) {
                details.push(`Bars processed: ${totalBars}`);
                // Show per-symbol breakdown
                Object.entries(barsPerSymbol).forEach(([symbol, count]) => {
                    if (count > 0) {
                        details.push(`${symbol}: ${count} bars`);
                    }
                });
            } else if (barCount > 0) {
                details.push(`Total bars: ${barCount}`);
            }

            // Fetch trade data and round-trip trades
            Promise.all([
                fetch('/trade-log?limit=1').then(r => r.json()).catch(() => ({ total_count: 0, trades: [] })),
                fetch('/trades/roundtrips?limit=1').then(r => r.json()).catch(() => ({ trades: [] })),
                fetch('/stats').then(r => r.json()).catch(() => ({}))
            ]).then(([tradeLog, roundTrips, stats]) => {
                    const tradeCount = tradeLog?.total_count || 0;
                    const roundTripTrades = roundTrips?.trades || [];
                    const lastTrade = roundTripTrades.length > 0 ? roundTripTrades[0] : null;
                    
                    let tradeStatus = '';
                    let tradeColor = statusColor;

                    if (isRunning) {
                        tradeStatus = 'Still evaluating bars...';
                        tradeColor = '#3b82f6'; // Blue
                    } else if (tradeCount > 0) {
                        tradeStatus = `${tradeCount} trade${tradeCount !== 1 ? 's' : ''} found`;
                        tradeColor = '#10b981'; // Green
                    } else {
                        tradeStatus = 'No trades found - simulation completed';
                        tradeColor = '#f59e0b'; // Orange
                    }

                    // Calculate progress
                    const totalBars = Object.values(barsPerSymbol).reduce((sum, count) => sum + (count || 0), 0) || barCount;
                    const expectedBars = calculateExpectedBars(mode, liveStatus);
                    const progressPercent = expectedBars > 0 ? Math.min(100, Math.round((totalBars / expectedBars) * 100)) : null;
                    
                    // Calculate summary stats
                    const summaryStats = calculateSummaryStats(roundTripTrades, stats);
                    
                    // Calculate current throughput
                    const currentThroughput = throughputHistory.length > 0 
                        ? Math.round(throughputHistory.slice(-1)[0]) 
                        : null;
                    const avgThroughput = throughputHistory.length > 0
                        ? Math.round(throughputHistory.reduce((a, b) => a + b, 0) / throughputHistory.length)
                        : null;

                    // Render enhanced status
                    statusDiv.innerHTML = renderEnhancedStatus({
                        statusMessage,
                        statusColor,
                        statusIcon,
                        mode,
                        tradeStatus,
                        tradeColor,
                        totalBars,
                        expectedBars,
                        progressPercent,
                        barsPerSymbol,
                        details,
                        summaryStats,
                        lastTrade,
                        throughputHistory,
                        currentThroughput,
                        avgThroughput
                    });
                })
                .catch(err => {
                    console.error('Error fetching status data:', err);
                    // Show basic status on error
                    statusDiv.innerHTML = `
                        <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas ${statusIcon}" style="color: ${statusColor};"></i>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${statusMessage}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                            ${mode === 'offline' ? 'Historical Simulation' : 'Live Trading'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${details.length > 0 ? `
                                <div style="margin-top: 8px; padding: 8px; background: #111827; border-radius: 4px;">
                                    ${details.map(detail => `
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                            <i class="fas fa-circle" style="font-size: 4px; margin-right: 6px; vertical-align: middle;"></i>${detail}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
        }

        function calculateExpectedBars(mode, liveStatus) {
            // Try to estimate expected bars from start/end time or use default
            if (liveStatus?.start_time && liveStatus?.end_time) {
                const start = new Date(liveStatus.start_time);
                const end = new Date(liveStatus.end_time);
                const hours = (end - start) / (1000 * 60 * 60);
                // Assume 60 bars per hour for 1-minute bars
                return Math.round(hours * 60);
            }
            // Default: 6.5 hours = 390 bars
            return 390;
        }

        function calculateSummaryStats(roundTrips, stats) {
            if (!roundTrips || roundTrips.length === 0) {
                return {
                    total: 0,
                    winning: 0,
                    losing: 0,
                    pnl: 0,
                    pnlPct: 0,
                    maxDrawdown: stats?.max_drawdown || 0
                };
            }

            const winning = roundTrips.filter(t => (t.gross_pnl || 0) > 0).length;
            const losing = roundTrips.filter(t => (t.gross_pnl || 0) < 0).length;
            const totalPnl = roundTrips.reduce((sum, t) => sum + (t.gross_pnl || 0), 0);
            const totalPnlPct = roundTrips.length > 0 
                ? roundTrips.reduce((sum, t) => sum + (t.pnl_pct || 0), 0) / roundTrips.length 
                : 0;

            return {
                total: roundTrips.length,
                winning,
                losing,
                pnl: totalPnl,
                pnlPct: totalPnlPct,
                maxDrawdown: stats?.max_drawdown || 0
            };
        }

        function renderEnhancedStatus(data) {
            const {
                statusMessage, statusColor, statusIcon, mode,
                tradeStatus, tradeColor, totalBars, expectedBars,
                progressPercent, barsPerSymbol, details, summaryStats,
                lastTrade, throughputHistory, currentThroughput, avgThroughput
            } = data;

            // Render progress bar
            const progressBar = progressPercent !== null
                ? `<div style="margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                        <span style="font-size: 11px; color: var(--text-secondary);">Progress</span>
                        <span style="font-size: 11px; color: var(--text-primary); font-weight: 600;">${progressPercent}%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #111827; border-radius: 4px; overflow: hidden;">
                        <div style="width: ${progressPercent}%; height: 100%; background: ${statusColor}; transition: width 0.3s;"></div>
                    </div>
                </div>`
                : `<div style="margin-top: 8px;">
                    <div style="width: 100%; height: 8px; background: #111827; border-radius: 4px; overflow: hidden; position: relative;">
                        <div style="width: 30%; height: 100%; background: ${statusColor}; animation: indeterminate 1.5s infinite;"></div>
                    </div>
                </div>`;

            // Render sparkline
            const sparkline = renderSparkline(throughputHistory, currentThroughput, avgThroughput);

            // Render summary stats
            const summaryBox = renderSummaryStats(summaryStats);

            // Render last trade
            const lastTradeBox = lastTrade ? renderLastTrade(lastTrade) : '';

            // Build bars display
            const barsDisplay = Object.keys(barsPerSymbol).length > 0
                ? Object.entries(barsPerSymbol).map(([symbol, count]) => 
                    count > 0 ? `${symbol}: ${count}` : null
                ).filter(Boolean).join(', ')
                : totalBars > 0 ? `${totalBars} bars` : '0 bars';

            return `
                <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${statusColor};">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas ${statusIcon}" style="color: ${statusColor};"></i>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 13px;">${statusMessage}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    ${mode === 'offline' ? 'Historical Simulation' : 'Live Trading'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    ${progressBar}

                    <!-- Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <!-- Left: Bars & Throughput -->
                        <div style="padding: 8px; background: #111827; border-radius: 4px;">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Bars Processed</div>
                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">
                                ${barsDisplay}${expectedBars > 0 ? ` / ${expectedBars}` : ''}
                            </div>
                            ${currentThroughput !== null ? `
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                                    Throughput: <span style="color: ${currentThroughput > 100 ? '#10b981' : currentThroughput > 50 ? '#f59e0b' : '#ef4444'}; font-weight: 600;">${currentThroughput}</span> bars/sec
                                </div>
                            ` : ''}
                            ${sparkline}
                        </div>

                        <!-- Right: Trade Activity -->
                        <div style="padding: 8px; background: #111827; border-radius: 4px; border-left: 2px solid ${tradeColor};">
                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Trade Activity</div>
                            <div style="font-size: 13px; color: ${tradeColor}; font-weight: 600;">${tradeStatus}</div>
                            ${summaryStats.total > 0 ? `
                                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
                                    Win: ${summaryStats.winning} / Loss: ${summaryStats.losing}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Summary Stats Box -->
                    ${summaryStats.total > 0 ? summaryBox : ''}

                    <!-- Last Trade Snapshot -->
                    ${lastTradeBox}

                    <!-- Details -->
                    ${details.length > 0 ? `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #374151;">
                            ${details.map(detail => `
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    <i class="fas fa-circle" style="font-size: 4px; margin-right: 6px; vertical-align: middle;"></i>${detail}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSparkline(history, current, avg) {
            if (!history || history.length === 0) return '';

            const max = Math.max(...history, 1);
            const min = Math.min(...history, 0);
            const range = max - min || 1;
            const height = 20;
            const width = 60;
            const points = history.map((val, i) => {
                const x = (i / (history.length - 1 || 1)) * width;
                const y = height - ((val - min) / range) * height;
                return `${x},${y}`;
            }).join(' ');

            const color = avg > 100 ? '#10b981' : avg > 50 ? '#f59e0b' : '#ef4444';

            return `
                <div style="margin-top: 6px;">
                    <svg width="${width}" height="${height}" style="display: block;">
                        <polyline
                            points="${points}"
                            fill="none"
                            stroke="${color}"
                            stroke-width="1.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        />
                    </svg>
                </div>
            `;
        }

        function renderSummaryStats(stats) {
            if (stats.total === 0) return '';

            const pnlColor = stats.pnl >= 0 ? '#10b981' : '#ef4444';
            const pnlSign = stats.pnl >= 0 ? '+' : '';

            return `
                <div style="margin-top: 12px; padding: 10px; background: #111827; border-radius: 4px; border: 1px solid #374151;">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">Summary Stats</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 10px;">
                        <div>
                            <div style="color: var(--text-secondary);">Total</div>
                            <div style="color: var(--text-primary); font-weight: 600;">${stats.total}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary);">Win</div>
                            <div style="color: #10b981; font-weight: 600;">${stats.winning}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary);">Loss</div>
                            <div style="color: #ef4444; font-weight: 600;">${stats.losing}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary);">P&L</div>
                            <div style="color: ${pnlColor}; font-weight: 600;">${pnlSign}$${stats.pnl.toFixed(2)}</div>
                        </div>
                    </div>
                    ${stats.maxDrawdown > 0 ? `
                        <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #374151; font-size: 10px;">
                            <span style="color: var(--text-secondary);">Max Drawdown:</span>
                            <span style="color: #ef4444; font-weight: 600; margin-left: 4px;">${stats.maxDrawdown.toFixed(2)}%</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderLastTrade(trade) {
            const direction = trade.side === 'LONG' || trade.side === 'buy' ? 'LONG' : 'SHORT';
            const directionColor = direction === 'LONG' ? '#10b981' : '#ef4444';
            const pnl = trade.gross_pnl || 0;
            const pnlPct = trade.pnl_pct || 0;
            const pnlColor = pnl >= 0 ? '#10b981' : '#ef4444';
            const pnlSign = pnl >= 0 ? '+' : '';

            return `
                <div style="margin-top: 12px; padding: 10px; background: #111827; border-radius: 4px; border-left: 2px solid ${directionColor};">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">Last Trade</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div>
                            <span style="color: ${directionColor}; font-weight: 600; font-size: 12px;">${direction}</span>
                            <span style="color: var(--text-primary); margin-left: 6px;">${trade.quantity || 0} @ $${(trade.entry_price || 0).toFixed(2)}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 11px;">â†’ $${(trade.exit_price || 0).toFixed(2)}</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                        <div style="font-size: 11px;">
                            <span style="color: var(--text-secondary);">P&L:</span>
                            <span style="color: ${pnlColor}; font-weight: 600; margin-left: 4px;">${pnlSign}$${pnl.toFixed(2)} (${pnlSign}${(pnlPct * 100).toFixed(2)}%)</span>
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary);">
                            ${trade.regime_at_entry || 'N/A'} / ${trade.vol_bucket_at_entry || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
        }

        function stopSimulation() {
            if (confirm('Stop the current simulation?')) {
                fetch('/live/stop', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Simulation stopped');
                        setTimeout(() => {
                            updateStatusView();
                            updateData();
                        }, 500);
                    })
                    .catch(err => {
                        console.error('Error stopping simulation:', err);
                    });
            }
        }

        function updateAgentActivity(agents) {
            const activityDiv = document.getElementById('agentActivity');
            activityDiv.innerHTML = '';

            if (!agents || !agents.agents) {
                activityDiv.innerHTML = `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">No agent data available</div>
                    </div>
                `;
                return;
            }

            const agentEntries = Object.entries(agents.agents);
            if (agentEntries.length === 0) {
                activityDiv.innerHTML = `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px;">
                        <div style="font-size: 12px; color: var(--text-secondary);">No active agents</div>
                    </div>
                `;
                return;
            }

            // Sort by weight (most active first)
            agentEntries.sort((a, b) => (b[1].current_weight || 0) - (a[1].current_weight || 0));

            agentEntries.forEach(([name, data]) => {
                const weight = (data.current_weight || 0) * 100;
                const fitness = data.short_term || 0;
                const barColor = weight > 20 ? '#10b981' : weight > 10 ? '#f59e0b' : '#9ca3af';
                
                activityDiv.innerHTML += `
                    <div style="padding: 12px; background: var(--card-bg); border-radius: 6px; border-left: 3px solid ${barColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 13px;">${name}</div>
                            <div style="padding: 2px 8px; background: ${barColor}20; border-radius: 4px; font-size: 11px; color: ${barColor};">
                                ${weight.toFixed(1)}% weight
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary);">
                            <span>Fitness: ${(fitness * 100).toFixed(1)}%</span>
                            <span>Status: ${weight > 5 ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                `;
            });
        }

        function updateRecentActivity(health, liveStatus) {
            const activityDiv = document.getElementById('recentActivity');
            const activities = [];

            if (liveStatus) {
                if (liveStatus.is_running) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: `Simulation running - ${liveStatus.bar_count || 0} bars processed`,
                        type: 'info',
                        color: '#10b981'
                    });
                }
                if (liveStatus.stop_reason) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: `Stopped: ${liveStatus.stop_reason}`,
                        type: 'warning',
                        color: '#f59e0b'
                    });
                }
            }

            if (health) {
                if (health.is_running && !health.is_paused) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: 'System running',
                        type: 'success',
                        color: '#10b981'
                    });
                } else if (health.is_paused) {
                    activities.push({
                        time: new Date().toLocaleTimeString(),
                        message: 'System paused',
                        type: 'warning',
                        color: '#f59e0b'
                    });
                }
            }

            if (activities.length === 0) {
                activityDiv.innerHTML = `
                    <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; color: var(--text-secondary);">
                        No recent activity
                    </div>
                `;
                return;
            }

            // Show last 5 activities (most recent first)
            activityDiv.innerHTML = activities.slice(-5).reverse().map(activity => `
                <div style="padding: 8px; background: var(--card-bg); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 2px solid ${activity.color}; margin-bottom: 6px;">
                    <div>
                        <div style="color: var(--text-primary); font-size: 11px;">${activity.message}</div>
                        <div style="color: var(--text-secondary); font-size: 10px; margin-top: 2px;">${activity.time}</div>
                    </div>
                    <div style="width: 8px; height: 8px; background: ${activity.color}; border-radius: 50%;"></div>
                </div>
            `).join('');
        }

        // --- Navigation ---
        // --- Logging Settings Functions ---
        async function loadLoggingSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings/logging`);
                const settings = await response.json();
                
                // Update UI
                const logLevelSelect = document.getElementById('logLevelSelect');
                const enableDebugCheckbox = document.getElementById('enableDebugCheckbox');
                
                if (logLevelSelect) {
                    logLevelSelect.value = settings.log_level || 'INFO';
                }
                if (enableDebugCheckbox) {
                    enableDebugCheckbox.checked = settings.enable_debug || false;
                }
                
                console.log('âœ… Logging settings loaded:', settings);
            } catch (e) {
                console.error('Error loading logging settings:', e);
            }
        }
        
        async function saveLoggingSettings() {
            const logLevelSelect = document.getElementById('logLevelSelect');
            const enableDebugCheckbox = document.getElementById('enableDebugCheckbox');
            
            if (!logLevelSelect || !enableDebugCheckbox) {
                showToast('Logging controls not found', 'error');
                return;
            }
            
            const payload = {
                log_level: logLevelSelect.value,
                enable_debug: enableDebugCheckbox.checked
            };
            
            try {
                const response = await fetch(`${API_BASE}/settings/logging`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (response.ok) {
                    showToast('Logging settings saved successfully', 'success');
                    console.log('âœ… Logging settings updated:', result);
                    // Refresh logs to show new level
                    refreshLogs();
                } else {
                    throw new Error(result.detail || 'Failed to save settings');
                }
            } catch (e) {
                showToast(`Error saving settings: ${e.message}`, 'error');
                console.error('Error saving logging settings:', e);
            }
        }
        
        async function refreshLogs() {
            const logViewer = document.getElementById('logViewer');
            const logLevelFilter = document.getElementById('logLevelFilter');
            const logLimit = document.getElementById('logLimit');
            
            if (!logViewer) return;
            
            logViewer.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Loading logs...</div>';
            
            try {
                const level = logLevelFilter?.value || '';
                const limit = logLimit?.value || 100;
                
                const response = await fetch(`${API_BASE}/logs?limit=${limit}${level ? '&level=' + level : ''}`);
                const data = await response.json();
                
                if (data.logs && data.logs.length > 0) {
                    let html = '';
                    data.logs.forEach(log => {
                        const levelColor = {
                            'DEBUG': '#888888',
                            'INFO': '#00ff00',
                            'WARNING': '#ffaa00',
                            'ERROR': '#ff4444',
                            'CRITICAL': '#ff0000'
                        }[log.level] || '#00ff00';
                        
                        html += `<div style="margin-bottom: 4px; border-left: 3px solid ${levelColor}; padding-left: 8px;">`;
                        html += `<span style="color: #888888;">[${log.timestamp}]</span> `;
                        html += `<span style="color: ${levelColor}; font-weight: bold;">${log.level}</span> `;
                        html += `<span style="color: #888888;">${log.logger}</span> `;
                        html += `<span style="color: #ffffff;">${log.message}</span>`;
                        html += `</div>`;
                    });
                    logViewer.innerHTML = html;
                } else {
                    logViewer.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No logs found</div>';
                }
            } catch (e) {
                logViewer.innerHTML = `<div style="color: #ff4444; text-align: center; padding: 20px;">Error loading logs: ${e.message}</div>`;
                console.error('Error refreshing logs:', e);
            }
        }
        
        function downloadLogs() {
            window.open(`${API_BASE}/logs/download`, '_blank');
        }
        
        // Auto-refresh logs every 5 seconds when Settings view is active
        let logRefreshInterval = null;
        
        function showView(viewId) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // Show selected
            document.getElementById(`${viewId}-view`).classList.add('active');
            
            // Highlight nav item
            const navItems = document.querySelectorAll('.nav-item');
            if (viewId === 'dashboard') navItems[0].classList.add('active');
            if (viewId === 'analytics') navItems[1].classList.add('active');
            if (viewId === 'trades') navItems[2].classList.add('active');
            if (viewId === 'agents') navItems[3].classList.add('active');
            if (viewId === 'risk') navItems[4].classList.add('active');
            if (viewId === 'settings') {
                navItems[5].classList.add('active');
                // Setup event listeners for log filters
                setTimeout(setupLogFilters, 100);
                // Load logging settings when Settings view is opened
                loadLoggingSettings();
                // Load logs immediately
                refreshLogs();
                // Auto-refresh logs every 5 seconds
                if (logRefreshInterval) clearInterval(logRefreshInterval);
                logRefreshInterval = setInterval(refreshLogs, 5000);
            } else {
                // Stop auto-refresh when leaving Settings view
                if (logRefreshInterval) {
                    clearInterval(logRefreshInterval);
                    logRefreshInterval = null;
                }
            }

            if (viewId === 'trades') updateFullTradesLog();
            if (viewId === 'agents') updateAgentsView();
            if (viewId === 'analytics') {
                // Load Performance tab by default when Analytics view opens
                updatePerformanceAnalytics();
            }
        }

        // --- Notifications ---
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.className = 'toast', 3000);
        }

        // --- Initialize Combined Date/Time Dropdowns ---
        // Define function first
        // Track if dropdowns have been initialized to prevent re-initialization
        let dropdownsInitialized = false;
        
        // Store saved values in outer scope for restore
        let savedStartValue = '';
        let savedEndValue = '';
        
        async function initDateTimeDropdowns(force = false) {
            console.log('ðŸ”„ initDateTimeDropdowns() called', { force, alreadyInitialized: dropdownsInitialized });
            console.log('ðŸ“‹ Current URL:', window.location.href);
            console.log('ðŸ“‹ Document ready state:', document.readyState);
            
            // Try multiple possible IDs
            const startDateTimeSelect = document.getElementById('simStartDateTime') || 
                                       document.getElementById('simStartDate') ||
                                       document.querySelector('select[id*="Start"]');
            const endDateTimeSelect = document.getElementById('simEndDateTime') || 
                                     document.getElementById('simEndDate') ||
                                     document.querySelector('select[id*="End"]');
            
            console.log('Dropdown elements:', {
                start: startDateTimeSelect ? 'âœ… FOUND' : 'âŒ NOT FOUND',
                end: endDateTimeSelect ? 'âœ… FOUND' : 'âŒ NOT FOUND',
                startId: startDateTimeSelect?.id,
                endId: endDateTimeSelect?.id,
                startHasOptions: startDateTimeSelect?.options.length || 0,
                endHasOptions: endDateTimeSelect?.options.length || 0,
                allSelects: document.querySelectorAll('select').length,
                allSelectIds: Array.from(document.querySelectorAll('select')).map(s => s.id).join(', ')
            });
            
            if (!startDateTimeSelect || !endDateTimeSelect) {
                console.error('âŒ Date/Time dropdowns not found!', {
                    start: !!startDateTimeSelect,
                    end: !!endDateTimeSelect,
                    allSelects: document.querySelectorAll('select').length,
                    allSelectIds: Array.from(document.querySelectorAll('select')).map(s => s.id).join(', '),
                    pageSource: document.documentElement.innerHTML.substring(0, 500)
                });
                // Retry after a short delay
                setTimeout(() => initDateTimeDropdowns(force), 1000);
                return;
            }
            
            // If already initialized and not forcing, preserve selected values and skip
            if (dropdownsInitialized && !force) {
                console.log('âœ… Dropdowns already initialized, preserving selected values');
                const currentStart = startDateTimeSelect.value;
                const currentEnd = endDateTimeSelect.value;
                console.log('ðŸ“‹ Current selections:', { start: currentStart, end: currentEnd });
                return;
            }
            
            // Save current selected values before clearing (if any) - use outer scope variables
            savedStartValue = startDateTimeSelect.value || '';
            savedEndValue = endDateTimeSelect.value || '';
            console.log('ðŸ’¾ Saving current selections:', { start: savedStartValue, end: savedEndValue });
            
            // Clear existing options first (including placeholder)
            startDateTimeSelect.innerHTML = '';
            endDateTimeSelect.innerHTML = '';
            console.log('âœ… Dropdowns cleared, starting to populate...');
            
            // Fetch available dates from CACHE (REAL DATA ONLY)
            console.log('ðŸ“… Fetching available dates from cache (REAL DATA ONLY)...');
            try {
                const cacheResponse = await fetch(`${API_BASE}/cache/available-dates?timeframe=1min`);
                if (!cacheResponse.ok) {
                    throw new Error(`HTTP ${cacheResponse.status}`);
                }
                const cacheData = await cacheResponse.json();
                
                if (cacheData && cacheData.available_dates && cacheData.available_dates.length > 0) {
                    console.log(`âœ… Received ${cacheData.total_dates} dates with REAL cached data from symbols: ${cacheData.symbols.join(', ')}`);
                    
                    // Flatten all date/time options
                    const dateTimeOptions = [];
                    cacheData.available_dates.forEach(dateInfo => {
                        dateInfo.options.forEach(opt => {
                            dateTimeOptions.push(opt);
                        });
                    });
                    
                    console.log(`âœ… Generated ${dateTimeOptions.length} date/time options from REAL cached data`);
                    populateDropdownsFromOptions(dateTimeOptions, startDateTimeSelect, endDateTimeSelect);
                    return;
                } else {
                    console.warn('âš ï¸ No cached data found. Please collect historical data first.');
                    // Show error message in dropdown
                    const errorOption = document.createElement('option');
                    errorOption.value = '';
                    errorOption.textContent = 'No cached data - Please collect historical data first';
                    startDateTimeSelect.appendChild(errorOption);
                    endDateTimeSelect.appendChild(errorOption.cloneNode(true));
                    return;
                }
            } catch (e) {
                console.error('âŒ Error fetching cached dates:', e);
                // Show error message in dropdown
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'Error loading cached dates - Please refresh';
                startDateTimeSelect.appendChild(errorOption);
                endDateTimeSelect.appendChild(errorOption.cloneNode(true));
                return;
            }
        }
        
        async function populateDropdownsFromCalendar(calendarData, startDateTimeSelect, endDateTimeSelect) {
            const dateTimeOptions = [];
            const marketTimes = [
                { value: '09:30', display: '9:30 AM' },
                { value: '10:00', display: '10:00 AM' },
                { value: '11:00', display: '11:00 AM' },
                { value: '12:00', display: '12:00 PM' },
                { value: '13:00', display: '1:00 PM' },
                { value: '14:00', display: '2:00 PM' },
                { value: '15:00', display: '3:00 PM' },
                { value: '16:00', display: '4:00 PM' }
            ];
            
            // Sort trading dates (newest first)
            const tradingDates = calendarData.trading_dates.sort().reverse();
            
            tradingDates.forEach(dateStr => {
                const dateInfo = calendarData.calendar[dateStr];
                if (!dateInfo || !dateInfo.is_trading_day) {
                    return; // Skip non-trading days
                }
                
                const date = new Date(dateStr + 'T00:00:00');
                const dateDisplay = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric' 
                });
                
                // Get available times based on early close
                const closeTime = dateInfo.close_time || '16:00';
                const isEarlyClose = dateInfo.early_close === true;
                
                // Filter times based on close time
                const availableTimes = marketTimes.filter(time => {
                    if (isEarlyClose && closeTime === '13:00') {
                        // Early close at 1 PM - only show times up to 1 PM
                        return time.value <= '13:00';
                    }
                    // Normal close at 4 PM - show all times
                    return true;
                });
                
                // Add time options for this trading date
                availableTimes.forEach(time => {
                    const option = {
                        value: `${dateStr}T${time.value}:00`,
                        display: `${dateDisplay} ${time.display}${isEarlyClose ? ' (Early Close)' : ''}`
                    };
                    dateTimeOptions.push(option);
                });
            });
            
            populateDropdownsFromOptions(dateTimeOptions, startDateTimeSelect, endDateTimeSelect);
        }
        
        function populateDropdownsFromOptions(dateTimeOptions, startDateTimeSelect, endDateTimeSelect) {
            // Note: savedStartValue and savedEndValue are set in initDateTimeDropdowns before this is called
            
            // Populate dropdowns
            console.log(`ðŸ“Š Populating ${dateTimeOptions.length} date/time options...`);
            let addedCount = 0;
            try {
                dateTimeOptions.forEach(opt => {
                    const option1 = document.createElement('option');
                    option1.value = opt.value;
                    option1.textContent = opt.display;
                    startDateTimeSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = opt.value;
                    option2.textContent = opt.display;
                    endDateTimeSelect.appendChild(option2);
                    addedCount++;
                });
                console.log(`âœ… Added ${addedCount} options to each dropdown`);
                console.log(`âœ… Verification: startDateTimeSelect has ${startDateTimeSelect.options.length} options`);
                console.log(`âœ… Verification: endDateTimeSelect has ${endDateTimeSelect.options.length} options`);
            } catch (e) {
                console.error('âŒ Error populating dropdowns:', e);
                // Add at least one option so dropdown is visible
                const fallbackOption = document.createElement('option');
                fallbackOption.value = '';
                fallbackOption.textContent = 'Error loading dates - please refresh';
                startDateTimeSelect.appendChild(fallbackOption);
                endDateTimeSelect.appendChild(fallbackOption.cloneNode(true));
            }
            
            // Restore saved values or set defaults
            if (dateTimeOptions.length > 0) {
                try {
                    // Try to restore saved values first
                    if (savedStartValue && startDateTimeSelect.querySelector(`option[value="${savedStartValue}"]`)) {
                        startDateTimeSelect.value = savedStartValue;
                        console.log(`âœ… Restored saved start value: ${savedStartValue}`);
                    } else {
                        // Set default: Start = 3 months ago at 9:30 AM
                        const threeMonthsAgo = new Date(now);
                        threeMonthsAgo.setMonth(now.getMonth() - 3);
                        while (threeMonthsAgo.getDay() === 0 || threeMonthsAgo.getDay() === 6) {
                            threeMonthsAgo.setDate(threeMonthsAgo.getDate() - 1);
                        }
                        const defaultStartDate = threeMonthsAgo.toISOString().split('T')[0];
                        const defaultStartValue = `${defaultStartDate}T09:30:00`;
                        if (startDateTimeSelect.querySelector(`option[value="${defaultStartValue}"]`)) {
                            startDateTimeSelect.value = defaultStartValue;
                            console.log(`âœ… Set default start value: ${defaultStartValue}`);
                        }
                    }
                    
                    if (savedEndValue && endDateTimeSelect.querySelector(`option[value="${savedEndValue}"]`)) {
                        endDateTimeSelect.value = savedEndValue;
                        console.log(`âœ… Restored saved end value: ${savedEndValue}`);
                    } else {
                        // Set default: End = today at 4:00 PM
                        const defaultEndDate = new Date(now);
                        while (defaultEndDate.getDay() === 0 || defaultEndDate.getDay() === 6) {
                            defaultEndDate.setDate(defaultEndDate.getDate() - 1);
                        }
                        const defaultEndDateStr = defaultEndDate.toISOString().split('T')[0];
                        const defaultEndValue = `${defaultEndDateStr}T16:00:00`;
                        if (endDateTimeSelect.querySelector(`option[value="${defaultEndValue}"]`)) {
                            endDateTimeSelect.value = defaultEndValue;
                            console.log(`âœ… Set default end value: ${defaultEndValue}`);
                        }
                    }
                    
                    dropdownsInitialized = true;
                    console.log(`âœ… Combined Date/Time dropdowns initialized with ${dateTimeOptions.length} options`);
                    console.log(`   Final start value: ${startDateTimeSelect.value}`);
                    console.log(`   Final end value: ${endDateTimeSelect.value}`);
                    console.log(`   âœ… Start dropdown now has ${startDateTimeSelect.options.length} options`);
                    console.log(`   âœ… End dropdown now has ${endDateTimeSelect.options.length} options`);
                    
                    // Visual confirmation
                    if (startDateTimeSelect.options.length > 1) {
                        console.log('âœ… SUCCESS: Dropdowns are populated!');
                    }
                } catch (e) {
                    console.error('âŒ Error setting values:', e);
                }
            } else {
                console.error('âŒ No date/time options generated!');
            }
        }
        
        // CRITICAL: Assign to window IMMEDIATELY after function definition
        try {
            window.initDateTimeDropdowns = initDateTimeDropdowns;
            console.log('âœ… initDateTimeDropdowns assigned to window:', typeof window.initDateTimeDropdowns);
            console.log('âœ… Window.initDateTimeDropdowns exists:', 'initDateTimeDropdowns' in window);
            console.log('âœ… Can call window.initDateTimeDropdowns:', typeof window.initDateTimeDropdowns === 'function');
        } catch(e) {
            console.error('âŒ ERROR assigning to window:', e);
        }
        
        // Also expose a test function
        window.testDropdowns = function() {
            console.log('ðŸ§ª Testing dropdowns...');
            console.log('simStartDateTime:', document.getElementById('simStartDateTime'));
            console.log('simEndDateTime:', document.getElementById('simEndDateTime'));
            console.log('All selects:', Array.from(document.querySelectorAll('select')).map(s => ({id: s.id, options: s.options.length})));
            initDateTimeDropdowns();
        }
        
        // Initialize on page load - ensure it runs
        function initializeOnLoad() {
            console.log('ðŸ”„ Attempting to initialize dropdowns...');
            try {
                initDateTimeDropdowns();
            } catch (e) {
                console.error('âŒ Error initializing dropdowns:', e);
                // Show error in dropdown
                const startSelect = document.getElementById('simStartDateTime');
                const endSelect = document.getElementById('simEndDateTime');
                if (startSelect) {
                    startSelect.innerHTML = '<option value="">Error - Click to refresh</option>';
                }
                if (endSelect) {
                    endSelect.innerHTML = '<option value="">Error - Click to refresh</option>';
                }
            }
        }
        
        // IMMEDIATE initialization - run right now
        (function() {
            console.log('ðŸš€ IMMEDIATE initialization starting...');
            initializeOnLoad();
        })();
        
        // Multiple initialization strategies to ensure it runs
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('ðŸ“„ DOMContentLoaded event fired');
                initializeOnLoad();
            });
        } else {
            console.log('ðŸ“„ Document already loaded, initializing immediately');
            initializeOnLoad();
        }
        
        // Also try after delays in case elements aren't ready
        setTimeout(initializeOnLoad, 100);
        setTimeout(initializeOnLoad, 500);
        setTimeout(initializeOnLoad, 1000);
        setTimeout(initializeOnLoad, 2000);
        setTimeout(initializeOnLoad, 3000);
        
        // Last resort: try when window is fully loaded
        window.addEventListener('load', function() {
            console.log('ðŸ“„ Window load event fired - final initialization attempt');
            setTimeout(initializeOnLoad, 500);
        });
        
        // Force initialization when page is fully loaded
        window.addEventListener('load', function() {
            console.log('ðŸ“„ Window load event fired, forcing dropdown initialization');
            setTimeout(initializeOnLoad, 100);
        });
        
        // Also try on visibility change (when tab becomes visible)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ðŸ‘ï¸ Tab became visible, re-initializing dropdowns');
                setTimeout(initializeOnLoad, 100);
            }
        });

        // --- Auto-Start Historical Simulation ---
        async function autoStartHistoricalSimulation() {
            const btn = document.getElementById('btnSim');
            if (!btn) return;
            
            // Get values from dropdowns
            const startDateSelect = document.getElementById('simStartDate');
            const startTimeSelect = document.getElementById('simStartTime');
            const endDateSelect = document.getElementById('simEndDate');
            const endTimeSelect = document.getElementById('simEndTime');
            
            if (!startDateSelect || !startTimeSelect || !endDateSelect || !endTimeSelect) {
                console.warn('Date/Time dropdowns not found');
                return;
            }
            
            const startDate = startDateSelect.value;
            const startTime = startTimeSelect.value;
            const endDate = endDateSelect.value;
            const endTime = endTimeSelect.value;
            
            // Format for API (YYYY-MM-DDTHH:MM:SS)
            const startDateTime = `${startDate}T${startTime}:00`;
            const endDateTime = `${endDate}T${endTime}:00`;
            
            // Show toast
            showToast('Starting historical simulation with SPY and QQQ...', 'success');
            
            // Auto-start simulation with both symbols
            const payload = {
                symbols: ["SPY", "QQQ"], // Both symbols automatically
                broker_type: "cached",
                offline_mode: true,
                fixed_investment_amount: 10000.0,
                replay_speed: 600.0, // Fast speed
                start_time: startDateTime,
                end_time: endDateTime
            };
            
            try {
                const res = await fetch(`${API_BASE}/live/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (res.ok) {
                    showToast('Historical simulation started! Processing SPY and QQQ...', 'success');
                    updateData();
                } else {
                    throw new Error(data.detail || 'Failed to start');
                }
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // --- API Controls ---
        async function startSimulation() {
            // Check if market is open - simulation is disabled during market hours
            if (marketStatus.is_open) {
                showToast('âŒ Simulation is disabled during trading hours (9:30 AM - 4:00 PM ET). Live trading is automatically active.', 'error');
                return;
            }
            
            const btn = document.getElementById('btnSim');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Starting...';
            
            // Get values from combined date/time dropdowns
            const startDateTimeSelect = document.getElementById('simStartDateTime');
            const endDateTimeSelect = document.getElementById('simEndDateTime');
            
            if (!startDateTimeSelect || !endDateTimeSelect) {
                showToast('Date/Time dropdowns not found', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }
            
            // Values are already in format YYYY-MM-DDTHH:MM:00
            const startDateTime = startDateTimeSelect.value;
            const endDateTime = endDateTimeSelect.value;
            
            // Log selected values for debugging
            console.log('ðŸš€ Starting simulation with:', {
                startDateTime,
                endDateTime,
                startDisplay: startDateTimeSelect.options[startDateTimeSelect.selectedIndex]?.textContent,
                endDisplay: endDateTimeSelect.options[endDateTimeSelect.selectedIndex]?.textContent
            });
            
            // Validate selections
            if (!startDateTime || !endDateTime) {
                showToast('Please select both start and end date/time', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }
            
            // Validate: end_time must be after start_time
            const start = new Date(startDateTime);
            const end = new Date(endDateTime);
            if (end <= start) {
                showToast('End date/time must be after start date/time', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
                return;
            }
            
            // Get replay speed
            const replaySpeedInput = document.getElementById('replaySpeed');
            const replaySpeed = replaySpeedInput ? parseFloat(replaySpeedInput.value) : 600.0;
            
            // Note: broker_type="cached" + offline_mode=true ensures synthetic bars are safe
            // Synthetic bars are ONLY generated in cached/offline mode, never in live trading
            const payload = {
                symbols: ["SPY", "QQQ"], // Always use both symbols automatically
                broker_type: "cached",   // Offline mode (synthetic bars safe here)
                offline_mode: true,      // Explicitly offline (prevents live trading with synthetic data)
                testing_mode: true,      // Enable testing mode - allows trading with minimal bars and bypasses strict filters
                fixed_investment_amount: 10000.0, // $10k per trade for simulation
                replay_speed: replaySpeed,
                start_time: startDateTime, // Use full datetime string
                end_time: endDateTime     // Use full datetime string
            };
            
            try {
                console.log('ðŸ“¤ Sending simulation request:', JSON.stringify(payload, null, 2));
                console.log('ðŸ“‹ Selected date:', startDateTime, 'should be used for evaluation');
                const res = await fetch(`${API_BASE}/live/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                // Check if response is OK before parsing JSON
                if (!res.ok) {
                    const errorText = await res.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText || `HTTP ${res.status}: ${res.statusText}` };
                    }
                    console.error('âŒ Simulation start failed:', errorData);
                    throw new Error(errorData.detail || `HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('âœ… Simulation started successfully:', data);
                console.log('ðŸ“‹ Verify in logs: First bar should match selected date:', startDateTime);
                showToast(data.message || 'Simulation started', 'success');
                
                // Force immediate status update
                setTimeout(() => {
                    updateStatusView();
                    updateData();
                }, 500);
            } catch (e) {
                console.error('âŒ Error starting simulation:', e);
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function controlBot(action) {
            const btn = document.getElementById(`btn${action.charAt(0).toUpperCase() + action.slice(1)}`);
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing';

            try {
                let endpoint = `/${action}`;
                let method = 'POST';
                let body = {};

                if (action === 'start') {
                    // Start live trading with Alpaca (requires API keys)
                    endpoint = '/live/start';
                    body = {
                        symbols: ["QQQ", "SPY"],
                        broker_type: "alpaca",  // Use Alpaca for live trading
                        offline_mode: false,    // Live mode (not cached)
                        testing_mode: true,     // Enable force mode - allows trading with minimal bars
                        fixed_investment_amount: 10000.0
                        // Note: API keys should be set in environment variables:
                        // ALPACA_API_KEY and ALPACA_SECRET_KEY
                        // Or use paper trading: ALPACA_BASE_URL=https://paper-api.alpaca.markets
                    };
                } else if (action === 'stop') {
                    // Stop live trading/simulation
                    endpoint = '/live/stop';
                } else if (action === 'pause') {
                    // Pause/resume trading
                    endpoint = '/pause';
                } else if (action === 'kill') {
                    // Toggle logic needed or assume engage? Assuming toggle based on UI logic is complex, 
                    // let's assume this button ENGAGES kill switch for safety.
                    // Or we can check status first. Let's just try to engage.
                    body = { engage: true }; 
                }

                const res = await fetch(`${API_BASE}${endpoint}`, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    showToast(data.message || `Action ${action} successful`, 'success');
                    updateData(); // Refresh status immediately
                } else {
                    throw new Error(data.detail || 'Request failed');
                }
            } catch (e) {
                showToast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- Data Fetching & UI Updates ---
        async function updateData() {
            try {
                // PERFORMANCE: Add timeout to prevent hanging requests
                const fetchWithTimeout = (url, timeout = 5000) => {
                    return Promise.race([
                        fetch(url).then(r => r.json()),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Request timeout')), timeout)
                        )
                    ]);
                };
                
                const [health, stats, regime, trades, marketStatus] = await Promise.all([
                    fetchWithTimeout(`${API_BASE}/health`, 3000).catch(() => ({ status: "unhealthy", is_running: false })),
                    fetchWithTimeout(`${API_BASE}/stats`, 3000).catch(() => ({ total_return: 0, total_trades: 0 })),
                    fetchWithTimeout(`${API_BASE}/regime`, 3000).catch(() => ({ regime_type: "COMPRESSION", confidence: 0.0 })),
                    fetchWithTimeout(`${API_BASE}/trade-log?limit=10`, 3000).catch(() => ({ trades: [] })),
                    fetchWithTimeout(`${API_BASE}/market/status`, 2000).catch(() => ({ is_open: false }))
                ]);
                
                // 1. Header Status
                const dot = document.getElementById('statusDot');
                const txt = document.getElementById('statusText');
                const btnStart = document.getElementById('btnStart');
                const btnStop = document.getElementById('btnStop');
                const btnPause = document.getElementById('btnPause');
                
                // Show/hide Start Live button based on market hours
                if (btnStart) {
                    if (marketStatus.is_open) {
                        btnStart.style.display = 'inline-block'; // Show during trading hours
                    } else {
                        btnStart.style.display = 'none'; // Hide during non-trading hours
                    }
                }

                if (health.is_running && !health.is_paused) {
                    dot.className = 'status-dot running';
                    txt.textContent = 'System Running';
                    btnStart.disabled = true; btnStop.disabled = false; btnPause.disabled = false;
                } else if (health.is_paused) {
                    dot.className = 'status-dot paused';
                    txt.textContent = 'System Paused';
                    btnStart.disabled = true; btnStop.disabled = false; btnPause.disabled = false; // Can resume via pause btn usually? endpoint handles toggle?
                } else {
                    dot.className = 'status-dot';
                    txt.textContent = 'System Stopped';
                    btnStart.disabled = false; btnStop.disabled = true; btnPause.disabled = true;
                }
                document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;

                // Update status view if it's visible
                const statusView = document.getElementById('perf-status-view');
                if (statusView && statusView.style.display !== 'none') {
                    updateStatusView();
                }

                // 2. Webull Dashboard Updates
                const fmt = (n) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(n);
                
                // Sidebar Values - Always use initial_capital as base, or default to 100000
                const initialCapital = stats.initial_capital || 100000;
                const currentCapital = stats.current_capital || initialCapital;
                // Always show at least initial capital (100K)
                const accountValue = Math.max(currentCapital, initialCapital);
                
                const totalValueEl = document.getElementById('wbTotalValue');
                if (totalValueEl) {
                    totalValueEl.textContent = fmt(accountValue);
                }
                const cashEl = document.getElementById('wbCash');
                if (cashEl) {
                    cashEl.textContent = fmt(accountValue);
                }
                const bpEl = document.getElementById('wbBP');
                if (bpEl) {
                    bpEl.textContent = fmt(accountValue);
                }
                const optBpEl = document.getElementById('wbOptBP');
                if (optBpEl) {
                    optBpEl.textContent = fmt(accountValue);
                }
                
                const pnl = stats.current_capital - stats.initial_capital;
                const pnlEl = document.getElementById('wbOpenPnL');
                pnlEl.textContent = (pnl>=0?'+':'') + fmt(pnl);
                pnlEl.className = `wb-metric-val ${pnl>=0?'text-pos':'text-neg'}`;
                
                const dayEl = document.getElementById('wbDayPnL');
                dayEl.textContent = pnlEl.textContent; // Placeholder for day PnL
                dayEl.className = pnlEl.className;

                document.getElementById('wbPerfPnL').textContent = pnlEl.textContent;
                document.getElementById('wbPerfPnL').style.color = pnl>=0 ? 'var(--wb-success)' : 'var(--wb-danger)';

                // Charts
                updateCharts(stats, regime, health);

                // Trades Table (Dashboard Snippet)
                const tbody = document.querySelector('#wbPositionsTable tbody');
                tbody.innerHTML = '';
                if(trades.trades && trades.trades.length > 0) {
                    trades.trades.slice(0,5).forEach(t => {
                        const tr = document.createElement('tr');
                        // Format timestamp with date and time in EST
                        let timeStr = '-';
                        if (t.entry_time) {
                            const entryDate = new Date(t.entry_time);
                            timeStr = entryDate.toLocaleString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true,
                                timeZone: 'America/New_York' // EST
                            });
                        }
                        tr.innerHTML = `
                            <td>${timeStr}</td>
                            <td style="font-weight:600">${t.symbol}</td>
                            <td>${t.quantity>0?'BUY':'SELL'}</td>
                            <td>${Math.abs(t.quantity)}</td>
                            <td>${fmt(t.entry_price)}</td>
                            <td>$0.00</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#9ca3af;">No recent trades</td></tr>';
                }

            } catch (e) {
                console.error("Update failed", e);
                // Show error message in trades table
                const tbody = document.querySelector('#wbPositionsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#ef4444;">Error loading data. Please refresh.</td></tr>';
                }
            }
        }
        
        // Call updateData immediately and then every 2 seconds
        updateData();
        setInterval(updateData, 3000); // PERFORMANCE: Reduced from 2s to 3s (33% fewer API calls)

        function updateCharts(stats, regime, health) {
            // Main Equity Chart
            if (!charts.main) {
                const ctx = document.getElementById('wbMainChart').getContext('2d');
                charts.main = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#00c805', backgroundColor: 'rgba(0,200,5,0.1)', fill: true, tension: 0.4, pointRadius:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: false}, scales: { x:{display:false}, y:{display:false} } }
                });
            }
            
            if (stats.equity_history && stats.equity_history.length > 0) {
                const labels = stats.equity_history.map((_,i) => i);
                charts.main.data.labels = labels;
                charts.main.data.datasets[0].data = stats.equity_history;
                charts.main.update('none');
            }

            // Mini Chart
            if (!charts.mini) {
                const ctx = document.getElementById('wbMiniChart').getContext('2d');
                charts.mini = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', borderWidth:1.5, fill: false, pointRadius:0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: false}, scales: { x:{display:false}, y:{display:false} } }
                });
            }
            if (stats.equity_history) {
                charts.mini.data.labels = stats.equity_history.map((_,i)=>i);
                charts.mini.data.datasets[0].data = stats.equity_history;
                charts.mini.update('none');
            }

            // Win Rate
            const winRate = (stats.win_rate || 0) * 100;
            if (!charts.win) {
                charts.win = new Chart(document.getElementById('wbWinChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [0,100], backgroundColor: ['#3b82f6', '#e2e8f0'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            charts.win.data.datasets[0].data = [winRate, 100-winRate];
            charts.win.update();
            document.getElementById('wbWinVal').textContent = winRate.toFixed(1)+'%';

            // Regime
            const conf = (regime.confidence || 0) * 100;
            if (!charts.regime) {
                charts.regime = new Chart(document.getElementById('wbRegimeChart'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [0,100], backgroundColor: ['#8b5cf6', '#e2e8f0'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            charts.regime.data.datasets[0].data = [conf, 100-conf];
            charts.regime.update();
            document.getElementById('wbRegimeVal').textContent = conf.toFixed(1)+'%';

            // Risk Gauge
            if (!charts.risk) {
                charts.risk = new Chart(document.getElementById('wbRiskGauge'), {
                    type: 'doughnut',
                    data: { datasets: [{ data: [10,90], backgroundColor: ['#10b981', '#e2e8f0'], borderWidth:0, circumference:180, rotation:-90 }] },
                    options: { cutout: '75%', plugins: {legend:false}, maintainAspectRatio: false }
                });
            }
            // Determine risk color
            let riskVal = 10;
            let riskColor = '#10b981';
            let riskText = 'SAFE';
            if (health.risk_status?.kill_switch_engaged) {
                riskVal = 100; riskColor='#ef4444'; riskText='HALTED';
            }
            charts.risk.data.datasets[0].data = [riskVal, 100-riskVal];
            charts.risk.data.datasets[0].backgroundColor[0] = riskColor;
            charts.risk.update();
            document.getElementById('wbRiskLabel').textContent = riskText;
            document.getElementById('wbRiskLabel').style.color = riskColor;
        }

        async function updateFullTradesLog() {
            const res = await fetch(`${API_BASE}/trade-log?limit=100`);
            const data = await res.json();
            const tbody = document.querySelector('#fullTradesTable tbody');
            tbody.innerHTML = '';
            if(data.trades) {
                data.trades.forEach(t => {
                    const row = document.createElement('tr');
                    const pnl = t.pnl || 0;
                    row.innerHTML = `
                        <td>-</td>
                        <td>${t.entry_time}</td>
                        <td style="font-weight:600">${t.symbol}</td>
                        <td>${t.quantity>0?'BUY':'SELL'}</td>
                        <td>${Math.abs(t.quantity)}</td>
                        <td>${t.entry_price.toFixed(2)}</td>
                        <td class="${pnl>=0?'text-pos':'text-neg'}">${pnl.toFixed(2)}</td>
                        <td>${t.reason || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        async function updateAgentsView() {
            const res = await fetch(`${API_BASE}/agents`);
            const data = await res.json();
            const grid = document.getElementById('agentsGrid');
            grid.innerHTML = '';
            
            if (data.agents) {
                // Convert to array if needed
                const agents = Array.isArray(data.agents) ? data.agents : Object.entries(data.agents).map(([k,v]) => ({name:k, ...v}));
                agents.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'wb-card';
                    card.innerHTML = `
                        <div class="wb-card-title" style="text-transform:capitalize;">${a.name}</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--wb-text-primary); margin: 10px 0;">
                            ${((a.weight || a.current_weight || 0)*100).toFixed(1)}%
                        </div>
                        <div class="wb-metric-label">Allocation</div>
                    `;
                    grid.appendChild(card);
                });
            }
        }

        // --- Market Status Check & Auto-Start ---
        let marketStatus = { is_open: false };
        let autoStartAttempted = false;
        
        async function checkMarketStatus() {
            try {
                const res = await fetch(`${API_BASE}/market/status`);
                marketStatus = await res.json();
                
                // Show/hide Start Live button based on market hours
                const btnStart = document.getElementById('btnStart');
                if (btnStart) {
                    if (marketStatus.is_open) {
                        btnStart.style.display = 'inline-block'; // Show during trading hours
                    } else {
                        btnStart.style.display = 'none'; // Hide during non-trading hours
                    }
                }
                
                // DISABLE simulation button during market hours
                const btnSim = document.getElementById('btnSim');
                if (btnSim) {
                    if (marketStatus.is_open) {
                        // Market is open - disable and hide simulation button
                        btnSim.style.display = 'none';
                        btnSim.disabled = true;
                    } else {
                        // Market is closed - enable simulation
                        btnSim.style.display = 'inline-block';
                        btnSim.disabled = false;
                    }
                }
                
                // Hide simulation controls during market hours
                const simControls = document.querySelectorAll('#simStartDateTime, #simEndDateTime, #replaySpeed');
                simControls.forEach(ctrl => {
                    if (ctrl) {
                        if (marketStatus.is_open) {
                            ctrl.style.display = 'none'; // Hide during market hours
                        } else {
                            ctrl.style.display = 'inline-block'; // Show when market closed
                        }
                    }
                });
                
                // ENHANCED: Auto-start when live bars are detected (not just market status)
                // This ensures we start only when Alpaca actually delivers delayed bars
                if (marketStatus.is_open) {
                    // Check if live trading is already running AND if live bars are flowing
                    try {
                        const liveStatus = await fetch(`${API_BASE}/live/status`).then(r => r.json()).catch(() => ({ is_running: false, last_bar_time: null }));
                        
                        if (liveStatus.is_running) {
                            // Already running - don't show toast every time
                            if (!autoStartAttempted) {
                                console.log('âœ… Live trading already running');
                                autoStartAttempted = true;
                            }
                        } else if (!autoStartAttempted) {
                            // Check if we have live bars from today
                            const lastBarTime = liveStatus.last_bar_time;
                            let hasLiveBars = false;
                            
                            if (lastBarTime) {
                                try {
                                    const barTime = new Date(lastBarTime);
                                    const now = new Date();
                                    const timeDiff = (now - barTime) / 1000 / 60; // minutes
                                    
                                    // Bar is from today and within last hour (Alpaca delayed data)
                                    if (barTime.toDateString() === now.toDateString() && timeDiff < 60) {
                                        hasLiveBars = true;
                                        console.log(`âœ… Live bars detected: ${lastBarTime} (age: ${timeDiff.toFixed(1)} min)`);
                                    }
                                } catch (e) {
                                    console.debug('Error parsing bar time:', e);
                                }
                            }
                            
                            // Auto-start only when live bars are detected
                            if (hasLiveBars) {
                                autoStartAttempted = true;
                                console.log('ðŸŸ¢ Market open + live bars detected - auto-starting live trading...');
                                
                                // Auto-start with SPY and QQQ - use testing_mode for aggressive trading
                                const autoStartPayload = {
                                    symbols: ["SPY", "QQQ"],
                                    broker_type: "alpaca",  // Use Alpaca for live trading
                                    offline_mode: false,
                                    testing_mode: true,  // Enable force mode - allows trading with minimal bars
                                    fixed_investment_amount: 10000.0
                                };
                                
                                const res = await fetch(`${API_BASE}/live/start`, {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify(autoStartPayload)
                                });
                                
                                if (res.ok) {
                                    const data = await res.json();
                                    console.log('âœ… Auto-started live trading:', data);
                                    showToast('ðŸš€ Auto-trading started: SPY & QQQ (Live Mode)', 'success');
                                    // Refresh status immediately
                                    setTimeout(() => updateData(), 2000);
                                } else {
                                    const error = await res.json().catch(() => ({ detail: 'Unknown error' }));
                                    console.error('âŒ Auto-start failed:', error);
                                    // Reset flag to retry next check
                                    autoStartAttempted = false;
                                }
                            } else if (lastBarTime) {
                                // Market open but no live bars yet - log and wait
                                console.log(`â³ Market open but waiting for live bars... (last bar: ${lastBarTime})`);
                            } else {
                                // Market open but no bars at all yet
                                console.log('â³ Market open - waiting for first delayed bar from Alpaca...');
                            }
                        }
                    } catch (e) {
                        console.error('Auto-start check failed:', e);
                        // Reset flag to retry next check
                        autoStartAttempted = false;
                    }
                } else {
                    // Market closed - reset auto-start flag for next market open
                    if (autoStartAttempted) {
                        console.log('ðŸ“´ Market closed - resetting auto-start flag');
                    }
                    autoStartAttempted = false;
                }
            } catch (e) {
                console.error('Error checking market status:', e);
            }
        }

        // --- TradingView Widget ---
        function loadTradingViewChart(symbol = 'SPY') {
            const widgetContainer = document.getElementById('tradingview-widget');
            if (!widgetContainer) return;
            
            // Clear existing widget
            widgetContainer.innerHTML = '';
            
            // Create TradingView widget
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/tv.js';
            script.onload = function() {
                new TradingView.widget({
                    "autosize": true,
                    "symbol": `NASDAQ:${symbol}`,
                    "interval": "1",
                    "timezone": "America/New_York",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#1a1a1a",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tradingview-widget",
                    "hide_side_toolbar": false,
                    "studies": [
                        "RSI@tv-basicstudies",
                        "MACD@tv-basicstudies",
                        "Volume@tv-basicstudies"
                    ],
                    "show_popup_button": true,
                    "popup_width": "1000",
                    "popup_height": "650"
                });
            };
            document.head.appendChild(script);
        }
        
        // Update TradingView chart when symbol changes or Performance tab opens
        let currentChartSymbol = 'SPY';
        const originalShowAnalyticsTab = showAnalyticsTab;
        showAnalyticsTab = function(tabId, el) {
            originalShowAnalyticsTab(tabId, el);
            if (tabId === 'perf') {
                const symbolSelect = document.getElementById('simSymbol');
                if (symbolSelect) {
                    currentChartSymbol = symbolSelect.value;
                }
                setTimeout(() => loadTradingViewChart(currentChartSymbol), 500);
            }
        };
        
        // --- Init ---
        setInterval(updateData, 3000); // PERFORMANCE: Reduced from 2s to 3s (33% fewer API calls)
        setInterval(checkMarketStatus, 30000); // Check market status every 30 seconds for faster auto-start
        updateData(); // Initial load
        checkMarketStatus(); // Initial market status check

    </script>
    
    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Handle install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // You can show a custom install button here if needed
            console.log('PWA install prompt available');
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FutBot Pro | Command Center</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <!-- Custom Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1a1a1a',
                            900: '#121212',
                            950: '#0a0a0a'
                        },
                        brand: {
                            blue: '#3b82f6',
                            green: '#10b981',
                            red: '#ef4444',
                            purple: '#8b5cf6'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .crypto-font {
            font-family: 'JetBrains Mono', monospace;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .animate-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-black text-gray-200 min-h-screen font-sans antialiased overflow-hidden selection:bg-brand-blue selection:text-white">

    <!-- Top Navigation Bar -->
    <nav class="h-16 border-b border-gray-800 glass-panel fixed w-full top-0 z-50 flex items-center justify-between px-6">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-blue-900/50">F</div>
                <span class="text-xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">FutBot Pro</span>
            </div>
            <div class="h-6 w-px bg-gray-700 mx-2"></div>
            <div class="flex items-center space-x-2 bg-gray-900/50 px-3 py-1 rounded-full border border-gray-800">
                <div id="connection-status" class="status-dot bg-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.5)]"></div>
                <span id="system-status-text" class="text-xs font-medium text-gray-400 uppercase tracking-wider">Connecting...</span>
            </div>
        </div>

        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-4 text-sm">
                <div class="flex flex-col items-end">
                    <span class="text-xs text-gray-500 uppercase">Total Equity</span>
                    <span id="nav-equity" class="font-mono font-bold text-white tracking-wide">---</span>
                </div>
                <div class="h-8 w-px bg-gray-800"></div>
                <div class="flex flex-col items-end">
                    <span class="text-xs text-gray-500 uppercase">Today's P&L</span>
                    <span id="nav-pnl" class="font-mono font-bold text-gray-400">---</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                 <button onclick="toggleMode('live')" id="btn-live" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-200 border border-transparent hover:border-gray-700">Live</button>
                 <button onclick="toggleMode('sim')" id="btn-sim" class="px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-200 border border-transparent hover:border-gray-700">Backtest</button>
                 <div class="h-6 w-px bg-gray-800 mx-1"></div>
                 <button id="btn-settings" class="p-2 text-gray-400 hover:text-white transition-colors"><i data-lucide="settings" class="w-4 h-4"></i></button>
            </div>
                    </div>
    </nav>

    <!-- Main Layout -->
    <div class="pt-16 h-screen flex">
        
        <!-- Sidebar (Assets & Positions) -->
        <aside class="w-80 border-r border-gray-800 bg-gray-900/30 flex flex-col h-full backdrop-blur-sm">
            <!-- Market Overview -->
            <div class="p-4 border-b border-gray-800">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Market Context</h3>
                    <span class="text-[10px] bg-gray-800 text-gray-400 px-1.5 py-0.5 rounded">QQQ</span>
                    </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
                        <div class="text-[10px] text-gray-500 mb-1">REGIME</div>
                        <div id="market-regime" class="text-sm font-bold text-white truncate">Detecting...</div>
                    </div>
                    <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
                        <div class="text-[10px] text-gray-500 mb-1">VOLATILITY</div>
                        <div id="market-volatility" class="text-sm font-bold text-white truncate">...</div>
                            </div>
                        </div>
                    </div>

            <!-- Positions List -->
            <div class="flex-1 overflow-y-auto">
                <div class="p-4">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Active Positions <span id="pos-count" class="ml-1 text-gray-600">(0)</span></h3>
                    <div id="positions-list" class="space-y-2">
                        <!-- Positions injected here -->
                        <div class="text-center py-8 text-gray-600 text-sm italic">No open positions</div>
                    </div>
                </div>
            </div>

            <!-- Risk Status Footer -->
            <div class="p-4 border-t border-gray-800 bg-gray-900/80">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-gray-400">Risk Status</span>
                    <span id="risk-status-pill" class="text-[10px] px-2 py-0.5 rounded-full bg-green-500/10 text-green-500 border border-green-500/20">NORMAL</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-1.5 mb-1 overflow-hidden">
                    <div id="drawdown-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                <div class="flex justify-between text-[10px] text-gray-500">
                    <span>Drawdown</span>
                    <span id="drawdown-val">0.00%</span>
                </div>
            </div>
        </aside>

        <!-- Center Stage (Charts & Analytics) -->
        <main class="flex-1 flex flex-col min-w-0 bg-black">
            
            <!-- Chart Toolbar -->
            <div class="h-10 border-b border-gray-800 flex items-center justify-between px-4 bg-gray-900/20">
                <div class="flex items-center space-x-4">
                    <div class="text-sm font-bold text-white flex items-center">
                        <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                        QQQ
                        <span class="ml-2 text-gray-500 font-normal text-xs">NASDAQ 100 ETF</span>
                    </div>
                    <div class="h-4 w-px bg-gray-800"></div>
                    <div class="text-xs text-gray-400 font-mono" id="current-price">---</div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Timeframe toggles could go here -->
                     <span class="text-[10px] text-gray-600">Real-time Data</span>
                </div>
            </div>

            <!-- Main Chart Area -->
            <div class="flex-1 relative bg-black" id="chart-container">
                 <div id="main-chart" class="absolute inset-0 w-full h-full"></div>
            </div>

            <!-- Bottom Panel (Console & Orders) -->
            <div class="h-64 border-t border-gray-800 bg-gray-900/30 flex flex-col">
                <div class="flex border-b border-gray-800">
                    <button class="px-4 py-2 text-xs font-medium text-blue-400 border-b-2 border-blue-500 bg-blue-500/5">System Logs</button>
                    <button class="px-4 py-2 text-xs font-medium text-gray-400 hover:text-white transition-colors">Order History</button>
                    <button class="px-4 py-2 text-xs font-medium text-gray-400 hover:text-white transition-colors">Trade Analysis</button>
                </div>
                <div class="flex-1 overflow-y-auto p-2 font-mono text-xs space-y-1" id="log-console">
                    <!-- Logs injected here -->
                    <div class="flex text-gray-500"><span class="text-gray-600 w-20 shrink-0">System</span> <span>Console ready...</span></div>
                </div>
            </div>
        </main>

        <!-- Right Sidebar (Strategy & Controls) -->
        <aside class="w-72 border-l border-gray-800 bg-gray-900/30 backdrop-blur-sm p-4 overflow-y-auto">
            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Strategy Control</h3>
            
            <!-- Control Panel -->
            <div class="space-y-4">
                <!-- Status Card -->
                <div class="bg-gray-800/40 rounded-lg p-4 border border-gray-700/50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-400">Bot State</span>
                        <div id="bot-status-indicator" class="w-2 h-2 rounded-full bg-gray-500"></div>
                    </div>
                    <div class="flex space-x-2">
                         <button onclick="startBot()" id="btn-start" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded transition-all shadow-lg shadow-green-900/20">START</button>
                         <button onclick="stopBot()" id="btn-stop" class="flex-1 bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded transition-all shadow-lg shadow-red-900/20">STOP</button>
                    </div>
                </div>

                <!-- Agent Status -->
                <div>
                    <h4 class="text-[10px] font-semibold text-gray-500 uppercase mb-2">Active Agents</h4>
                    <div class="space-y-2" id="agent-list">
                        <!-- Dynamic Agent List -->
                        <div class="bg-gray-800/30 rounded border border-gray-800 p-2 flex justify-between items-center">
                             <span class="text-xs text-gray-300">Trend Agent</span>
                             <span class="text-[10px] text-gray-500">Idle</span>
                        </div>
                         <div class="bg-gray-800/30 rounded border border-gray-800 p-2 flex justify-between items-center">
                             <span class="text-xs text-gray-300">Mean Reversion</span>
                             <span class="text-[10px] text-gray-500">Idle</span>
            </div>
                </div>
            </div>

                <!-- Metrics -->
                <div class="grid grid-cols-2 gap-2 mt-4">
                     <div class="bg-gray-800/30 p-2 rounded border border-gray-800">
                         <div class="text-[10px] text-gray-500">Win Rate</div>
                         <div class="text-sm font-mono text-white" id="metric-winrate">---</div>
                     </div>
                     <div class="bg-gray-800/30 p-2 rounded border border-gray-800">
                         <div class="text-[10px] text-gray-500">Profit Factor</div>
                         <div class="text-sm font-mono text-white" id="metric-pf">---</div>
                     </div>
                     <div class="bg-gray-800/30 p-2 rounded border border-gray-800">
                         <div class="text-[10px] text-gray-500">Sharpe</div>
                         <div class="text-sm font-mono text-white" id="metric-sharpe">---</div>
                     </div>
                     <div class="bg-gray-800/30 p-2 rounded border border-gray-800">
                         <div class="text-[10px] text-gray-500">Max DD</div>
                         <div class="text-sm font-mono text-white" id="metric-dd">---</div>
                     </div>
                </div>
            </div>
        </aside>

    </div>

    <!-- Application Logic -->
    <script>
        // Initialize Icons
        lucide.createIcons();

        // Constants
        const API_BASE = window.location.origin;
        const REFRESH_RATE = 2000; // 2 seconds

        // State
        let currentMode = 'live';
        let chartInitialized = false;
        
        // DOM Elements
        const els = {
            equity: document.getElementById('nav-equity'),
            pnl: document.getElementById('nav-pnl'),
            statusText: document.getElementById('system-status-text'),
            statusDot: document.getElementById('connection-status'),
            logs: document.getElementById('log-console'),
            regime: document.getElementById('market-regime'),
            volatility: document.getElementById('market-volatility'),
            positions: document.getElementById('positions-list'),
            posCount: document.getElementById('pos-count'),
            botStatus: document.getElementById('bot-status-indicator'),
            price: document.getElementById('current-price')
        };

        // --- Core Functions ---

        async function fetchStatus() {
            try {
                const response = await fetch(`${API_BASE}/live/status`);
                const data = await response.json();
                
                updateConnectionStatus(true);
                updateSystemState(data);
            } catch (e) {
                updateConnectionStatus(false);
                log('Error fetching status: ' + e.message, 'error');
            }
        }

        async function fetchPortfolio() {
            try {
                const response = await fetch(`${API_BASE}/live/portfolio`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                updatePortfolioUI(data);
            } catch (e) {
                log(`Portfolio Sync Failed: ${e.message}`, 'error');
            }
        }

        async function fetchPriceHistory() {
             try {
                const response = await fetch(`${API_BASE}/visualizations/price-history?symbol=QQQ`);
                const data = await response.json();
                if (data.dates && data.dates.length > 0) {
                    updateChart(data);
            
                    // Update current price in header
                    if (data.closes.length > 0) {
                        const lastPrice = data.closes[data.closes.length - 1];
                        els.price.textContent = formatMoney(lastPrice);
                    }
                }
            } catch (e) {
                // Moderate logging for chart to avoid spam
                if (!chartInitialized) {
                    log(`Chart Sync Failed: ${e.message}`, 'warning');
                }
            }
        }

        // --- UI Updaters ---

        function updateConnectionStatus(connected) {
            if (connected) {
                els.statusDot.className = "status-dot bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]";
                els.statusText.textContent = "CONNECTED";
                els.statusText.className = "text-xs font-medium text-green-500 uppercase tracking-wider";
            } else {
                els.statusDot.className = "status-dot bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]";
                els.statusText.textContent = "DISCONNECTED";
                els.statusText.className = "text-xs font-medium text-red-500 uppercase tracking-wider";
            }
        }

        function updateSystemState(data) {
            // Update Bot Running State
            if (data.is_running) {
                els.botStatus.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]";
            } else {
                els.botStatus.className = "w-2 h-2 rounded-full bg-gray-500";
            }
        }

        function updatePortfolioUI(data) {
            if (!data) return;
            
            if (!data.account) {
                log("Portfolio data missing 'account' field", 'warning');
                return;
            }

            // Equity
            const equity = data.account.equity || 0;
            els.equity.innerText = formatMoney(equity);
            
            // PnL (Simulated calculation if not provided directly)
            // Assuming starting capital 100k for calculation visual - TODO: Get from API
            let startCap = 100000;
            // Try to get start cap from account if available (some brokers provide it)
            if (data.account.initial_capital) {
                startCap = data.account.initial_capital;
            } else if (data.account.buying_power && data.account.cash) {
                 // Heuristic for paper trading: if cash is exactly 100k, use that
                 if (Math.abs(data.account.cash - 100000) < 1) startCap = 100000;
        }

            const pnl = equity - startCap;
            const pnlPct = startCap > 0 ? (pnl / startCap) * 100 : 0;
            
            els.pnl.innerText = `${formatMoney(pnl)} (${pnlPct.toFixed(2)}%)`;
            els.pnl.className = `font-mono font-bold ${pnl >= 0 ? 'text-green-500' : 'text-red-500'}`;

            // Positions
            const positions = data.positions || [];
            els.posCount.innerText = `(${positions.length})`;
            
            if (positions.length === 0) {
                els.positions.innerHTML = '<div class="text-center py-8 text-gray-600 text-sm italic">No open positions</div>';
            } else {
                els.positions.innerHTML = positions.map(pos => `
                    <div class="bg-gray-800/40 p-3 rounded border border-gray-700/50 hover:bg-gray-800/60 transition-colors animate-enter">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-white text-xs">${pos.symbol}</span>
                            <span class="text-[10px] ${pos.side === 'long' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'} px-1.5 py-0.5 rounded uppercase">${pos.side}</span>
                        </div>
                        <div class="flex justify-between text-[10px] text-gray-400">
                            <span>Qty: ${pos.qty}</span>
                            <span class="${pos.unrealized_pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${formatMoney(pos.unrealized_pnl)}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateChart(data) {
            const trace = {
                x: data.dates,
                close: data.closes,
                high: data.highs,
                low: data.lows,
                open: data.opens,
                type: 'candlestick',
                xaxis: 'x',
                yaxis: 'y',
                increasing: {line: {color: '#10b981'}},
                decreasing: {line: {color: '#ef4444'}}
            };

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 0, r: 40, b: 0, l: 0 },
                xaxis: {
                    gridcolor: '#333',
                    showgrid: true,
                    zeroline: false,
                    color: '#666',
                    rangeslider: { visible: false }
                },
                yaxis: {
                    gridcolor: '#333',
                    side: 'right',
                    color: '#666'
                },
                dragmode: 'pan',
                showlegend: false
            };

            if (!chartInitialized) {
                Plotly.newPlot('main-chart', [trace], layout, { displayModeBar: false, responsive: true });
                chartInitialized = true;
            } else {
                // Efficiently update data using react
                Plotly.react('main-chart', [trace], layout);
            }
        }

        // --- Actions ---

        async function startBot() {
            log("Sending START command...", "info");
            try {
                const res = await fetch(`${API_BASE}/live/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        symbols: ["QQQ"],
                        broker_type: "ibkr", 
                        ibkr_port: 7497,
                        risk_level: "conservative"
                    })
                });
                const data = await res.json();
                log(`Command Response: ${data.message || JSON.stringify(data)}`, "success");
                fetchStatus();
            } catch (e) {
                log(`Failed to start: ${e.message}`, "error");
            }
        }

        async function stopBot() {
            log("Sending STOP command...", "warning");
            try {
                await fetch(`${API_BASE}/live/stop`, { method: 'POST' });
                log("Bot stopped.", "info");
                fetchStatus();
            } catch (e) {
                log(`Failed to stop: ${e.message}`, "error");
            }
        }

        function toggleMode(mode) {
            currentMode = mode;
            document.getElementById('btn-live').className = `px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-200 ${mode === 'live' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/40' : 'text-gray-400 hover:text-white'}`;
            document.getElementById('btn-sim').className = `px-3 py-1.5 rounded-md text-xs font-medium transition-all duration-200 ${mode === 'sim' ? 'bg-purple-600 text-white shadow-lg shadow-purple-900/40' : 'text-gray-400 hover:text-white'}`;
            log(`Switched to ${mode.toUpperCase()} mode view.`);
        }

        // --- Utilities ---

        function formatMoney(num) {
            try {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
            } catch (e) {
                return '$0.00';
            }
        }

        function log(msg, type='info') {
            const time = moment().format('HH:mm:ss');
            const colors = {
                info: 'text-gray-400',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400'
            };
            
            const div = document.createElement('div');
            div.className = `flex font-mono text-xs mb-1 hover:bg-white/5 px-1 rounded`;
            div.innerHTML = `
                <span class="text-gray-600 w-16 shrink-0 select-none">${time}</span>
                <span class="${colors[type] || 'text-gray-300'} break-all">${msg}</span>
            `;
            
            els.logs.insertBefore(div, els.logs.firstChild);
            
            // Keep log size manageable
            if (els.logs.children.length > 100) {
                els.logs.removeChild(els.logs.lastChild);
            }
        }

        // --- Initialization ---

        window.addEventListener('load', () => {
            // Initial Fetch
            fetchStatus();
            fetchPortfolio();
            fetchPriceHistory();
            
            // Polling Loop
            setInterval(() => {
                fetchStatus();
                fetchPortfolio();
                fetchPriceHistory();
            }, REFRESH_RATE);
            
            log("Dashboard initialized. Connecting to FutBot Pro Core...", "info");
                });

    </script>
</body>
</html>
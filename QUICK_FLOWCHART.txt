â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    FUTBOT TRADING ALGORITHM - QUICK FLOWCHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[USER ACTION]
    â”‚
    â”œâ”€ Dashboard: Click "Start Live"
    â””â”€ API: POST /start-live
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ui/fastapi_app.py                                                          â”‚
â”‚  start_live_trading()                                                       â”‚
â”‚    â”œâ”€> Initialize broker_client                                             â”‚
â”‚    â”œâ”€> Initialize data_feed                                                 â”‚
â”‚    â””â”€> Create LiveTradingConfig                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ui/bot_manager.py                                                           â”‚
â”‚  BotManager.start_live_trading()                                            â”‚
â”‚    â”œâ”€> Create LiveTradingLoop                                               â”‚
â”‚    â””â”€> Start background thread                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚  core/live/scheduler.py                                                    â”‚
â”‚  LiveTradingLoop.run()                                                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ MAIN LOOP (runs continuously)                                        â”‚ â”‚
â”‚  â”‚                                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ For each symbol (SPY, QQQ, etc.):                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  1. Get next bar                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> data_feed.get_next_bar(symbol)                        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  2. Validate bar                                              â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> Check: bar.symbol == symbol?                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚         âš ï¸ CRITICAL: Prevents wrong price                     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  3. Update portfolio                                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> portfolio.update_position(symbol, bar.close)          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  4. Compute features & regime                                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â”œâ”€> feature_engine.compute_features(bars)                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> regime_engine.classify_regime(features)               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚         â””â”€> Returns: RegimeSignal                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚             â”œâ”€> regime_type: TREND/COMPRESSION/etc          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚             â”œâ”€> bias: BULLISH/BEARISH/NEUTRAL               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚             â””â”€> confidence: 0.0-1.0                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  5. Check profit-taking (existing positions)                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> profit_manager.should_take_profit()                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  6. Get trade decision                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> meta_policy.decide(signal, agents)                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚         â”œâ”€> Each agent.decide() â†’ TradeIntent               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚         â””â”€> Combine â†’ FinalTradeIntent                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  7. Check if options trade?                                  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> If YES â†’ [OPTIONS PATH]                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚     â””â”€> If NO  â†’ [STOCK PATH]                                â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”˜
            â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                     â”‚
            â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OPTIONS PATH              â”‚      â”‚ STOCK PATH                           â”‚
â”‚                           â”‚      â”‚                                      â”‚
â”‚ executor_options.py       â”‚      â”‚ âš ï¸ BUG FIXED HERE                    â”‚
â”‚ execute_intent()          â”‚      â”‚                                      â”‚
â”‚                           â”‚      â”‚ 1. Get base_investment ($1000)      â”‚
â”‚ â”œâ”€> Multi-leg?           â”‚      â”‚    â””â”€> asset_profile OR config       â”‚
â”‚ â”‚   â””â”€> _execute_        â”‚      â”‚                                      â”‚
â”‚ â”‚       multi_leg_trade() â”‚      â”‚ 2. Calculate target_quantity         â”‚
â”‚ â”‚       â”œâ”€> Submit CALL  â”‚      â”‚    â””â”€> $1000 / $670 = 1.49 shares   â”‚
â”‚ â”‚       â””â”€> Submit PUT   â”‚      â”‚                                      â”‚
â”‚ â”‚                         â”‚      â”‚ 3. Calculate position_delta         â”‚
â”‚ â”œâ”€> Track fills           â”‚      â”‚    â””â”€> target - current            â”‚
â”‚ â”‚   â””â”€> options_portfolio â”‚      â”‚                                      â”‚
â”‚ â”‚       .add_multi_leg_    â”‚      â”‚ 4. Apply risk management âš ï¸         â”‚
â”‚ â”‚       position()        â”‚      â”‚    â””â”€> advanced_risk.compute_       â”‚
â”‚ â”‚                         â”‚      â”‚        advanced_position_size()     â”‚
â”‚ â”œâ”€> Delta hedging?        â”‚      â”‚        â”œâ”€> Check regime cap        â”‚
â”‚ â”‚   â””â”€> delta_hedge_      â”‚      â”‚        â”‚   â””â”€> BEFORE: (cap/price) â”‚
â”‚ â”‚       manager.check()   â”‚      â”‚        â”‚   â””â”€> AFTER: cap âœ…        â”‚
â”‚ â”‚                         â”‚      â”‚        â”œâ”€> Apply confidence         â”‚
â”‚ â””â”€> Multi-leg exits       â”‚      â”‚        â””â”€> Convert to quantity      â”‚
â”‚     â””â”€> _check_multi_leg_  â”‚      â”‚                                      â”‚
â”‚         exits()           â”‚      â”‚ 5. Cap position_delta               â”‚
â”‚                           â”‚      â”‚    â””â”€> If > max_quantity: cap it    â”‚
â”‚                           â”‚      â”‚                                      â”‚
â”‚                           â”‚      â”‚ 6. Execute trade                    â”‚
â”‚                           â”‚      â”‚    â””â”€> executor.apply_intent()      â”‚
â”‚                           â”‚      â”‚        â”œâ”€> Calculate target_pos    â”‚
â”‚                           â”‚      â”‚        â”œâ”€> Determine side (BUY/SELL)â”‚
â”‚                           â”‚      â”‚        â””â”€> broker_client.place_orderâ”‚
â”‚                           â”‚      â”‚                                      â”‚
â”‚                           â”‚      â”‚ 7. Update portfolio                 â”‚
â”‚                           â”‚      â”‚    â””â”€> portfolio.apply_position_  â”‚
â”‚                           â”‚      â”‚        delta()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    [Sleep until next bar]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            KEY TROUBLESHOOTING POINTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”´ A. PRICE MISMATCH PREVENTION
   Location: scheduler.py:_process_bar() ~line 596
   Check: bar.symbol == symbol
   Issue: Wrong price used for wrong symbol
   Fix: Skip bar if mismatch

ğŸ”´ B. POSITION SIZING âš ï¸ RECENTLY FIXED
   Location: risk/advanced.py:compute_advanced_position_size() ~line 237
   Issue: Dividing by price when calculating caps (unit mismatch)
   Fix: Removed division by price - caps now in dollars
   Before: max_size = (capital * pct) / price âŒ
   After:  max_size = capital * pct âœ…

ğŸ”´ C. QUANTITY CALCULATION
   Location: scheduler.py:_process_bar() ~line 1101
   Check: target_quantity = base_investment / bar.close
   Issue: Wrong price â†’ wrong quantity
   Fix: Use bar.close (not latest["close"])

ğŸ”´ D. MULTI-LEG FILL TRACKING
   Location: executor_options.py:_execute_multi_leg_trade() ~line 800
   Issue: Legs filled separately, need to track both
   Check: Both call_fill and put_fill exist

ğŸ”´ E. DELTA HEDGING
   Location: delta_hedge_manager.py:calculate_hedge_quantity() ~line 200
   Issue: Net delta calculation, hedge sizing
   Check: hedge_shares = -net_delta * 100 (correct units)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            DEBUGGING CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. âœ… Bar Validation
   - Is bar.symbol == symbol?
   - Is bar.close correct price?

2. âœ… Position Sizing
   - What is base_investment? ($1000 default)
   - What is bar.close? (should match symbol)
   - What is adjusted_size after risk management?
   - What is final quantity? (should be ~1-2 shares for $1000 at $670)

3. âœ… Risk Management
   - What is confidence? (0.0-1.0)
   - What is regime_type? (affects caps)
   - What is regime_cap_pct? (5% compression, 15% trend)
   - Is max_size_by_regime in dollars? (should be, not shares)

4. âœ… Execution
   - Did order get submitted?
   - Did fill occur?
   - What is filled_quantity?

5. âœ… Portfolio Update
   - Did position update correctly?
   - Is unrealized_pnl correct?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

